<!DOCTYPE html>
<html><!-- nomanifest="app.manifest" -->
    <head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
    <meta charset="UTF-8">
        <title class="i18n">Wildfire modeling</title>
        <!-- Ext resources -->
        <link rel="stylesheet" type="text/css"
              href="./externals/ext-3.4.1/resources/css/ext-all.css" />
        <link rel="stylesheet" type="text/css"
              href="./externals/ext-3.4.1/resources/css/xtheme-gray.css" />
        <script type="text/javascript" src="externals/ext-3.4.1/adapter/ext/ext-base-debug.js"></script>
        <!--
        <script type="text/javascript" src="externals/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="externals/ext-3.4.1/adapter/jquery/ext-jquery-adapter-debug.js"></script>
        -->
        <script type="text/javascript" src="externals/ext-3.4.1/ext-all-debug.js"></script>
        <script type="text/javascript" src="externals/OpenLayers-2.12/OpenLayers.js"></script>
        <script type="text/javascript" src="externals/OpenLayers-2.12/lib/OpenLayers/Lang/nl.js"></script>
        <!-- GeoExt -->
        <script src="externals/GeoExt/lib/GeoExt.js" type="text/javascript"></script>
        <script src="externals/GeoExt/lib/GeoExt/locale/GeoExt-fr.js" type="text/javascript"></script>
        <script src="externals/GeoExt/lib/GeoExt/locale/GeoExt-nl.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/geoext-all-debug.css" />
    </head>
    <body>
        <script>
//<!--
// settings
Ext.namespace('Gmi.Settings');

Gmi.Settings.openLayers_imgPath = 'img/';
Gmi.Settings.openLayers_proxyHost = '/test/proxy.php?url=';

OpenLayers.imgPath = Gmi.Settings.openLayers_imgPath;
OpenLayers.ProxyHost = Gmi.Settings.openLayers_proxyHost;

// klimaatgegevens

var WeatherRecord = new Ext.data.Record.create([
    { name: 'station', type: 'int'},
    { name: 'date', type: 'date'},
    { name: 'tmin', type: 'float'},
    { name: 'tmax', type: 'float'},
    { name: 'hmin', type: 'float'},
    { name: 'hmax', type: 'float'}
]);

var TerrainFeatureRecord = new GeoExt.data.FeatureRecord.create([
    {name: 'landscape_name', type: 'string'},
    {name: 'started', type: 'date'}
]);

function textToRecords(data) {
    var records = [];

    // splits data in regels en verwijder commentaar en lege regels
    var lines = data.split('\n').filter(function(line){return line.length > 0 && !line.startsWith('#');});
    for (var i = 0; i < lines.length; i++) {
        var tokens = lines[i].split(/[,\s]+/g).filter(function(token){return token.length > 0;});
        console.log(tokens);

        records.push(new WeatherRecord({
            station: tokens[0],
            date: Date.parseDate(tokens[1], 'Ymd'), // convert yyyymmdd to date?
            tmin: parseFloat(tokens[2]),
            tmax: parseFloat(tokens[4]),
            hmin: parseFloat(tokens[6]),
            hmax: parseFloat(tokens[8])
        }));
    }
    return records;
}

function getClimateData() {
    //var today = Ext.util.Format.date(new Date(), 'Ymd');
    var today = new Date();
    var end_ymd = today.dateFormat('Ymd');
    var start = new Date(today);
    start.setDate(today.getDate() - 5);
    var start_ymd = start.dateFormat('Ymd');
    // NB: proxy nodig voor direct ophalen
    //Ext.Ajax.request({
    var vars = 'TN:TNH:TX:TXH:UN:UNH:UX:UXH'; // Minimum temperatuur, uur, maximum temp, uur, Minimale relatieve vochtigheid, uur, max rel vocht, uur
    var request = OpenLayers.Request.GET({
        url: 'http://www.knmi.nl/klimatologie/daggegevens/getdata_dag.cgi',
        async: false,
        params: {
            stns: 275,
            vars: 'TN:TNH:TX:TXH:UN:UNH:UX:UXH', // station,datum, ...
            start: start_ymd,
            end: end_ymd
        },
        success: function(response) {
            var data = response.responseText; // bij OpenLayers request
        }
    });
    var text = request.responseText;
    return textToRecords(text);
};

var weatherColumnModel = new Ext.grid.ColumnModel({
    defaults: {
        sortable: true, // columns are not sortable by default
        width: 100,
        align: 'right',
        format: '000.0',
        xtype: 'numbercolumn'
    },
    columns: [
    {
        header: 'Station',
        dataIndex: 'station',
        hidden: true,
        format: '000'
        /*{
        editable: true,
        editor: new Ext.form.DateField({  // rules about editing
                format: 'Y-m-d',
                allowBlank: false,
                maxLength: 10
        })*/
    }, {
        header: 'Date',
        dataIndex: 'date',
        width: 100,
        align: 'right',
        format: 'Y-m-d',
        xtype: 'datecolumn'
    }, {
        header: 'Tmin',
        dataIndex: 'tmin'
    }, {
        header: 'Tmax',
        dataIndex: 'tmax'
    }, {
        header: 'RVmin',
        dataIndex: 'hmin'
    }, {
        header: 'RVmax',
        dataIndex: 'hmax'
    }]
});

var weatherStore = new Ext.data.Store({
    id: 'weatherStore',
    autoSave: false,
    recordType: WeatherRecord,
    sortInfo: { field: "date", direction: "DESC" },
    reader: {
        readRecords: function() {
            var records = getClimateData();
            return {
                records: records
            };
        }
    }
});

var weatherGrid = new Ext.grid.GridPanel({
    id: 'weathergrid',
    title: 'Weather characteristics',
    store: weatherStore,
    cm: weatherColumnModel
});

var weathersettingsWindow = new Ext.Window({
    title: "Weather settings",
    id: 'weathersettingsWindow',
    width: 600,
    height: 400,
    closable: true,
    closeAction: 'hide',
    autoScroll: true,
    hideable: true,
    resizable: true,
    draggable: true,
    modal: true,
    //width: '40%',
    //height: '600',
    plain: true,
    layout: 'fit', // fit grid in window
    //modal: false,
    items: [weatherGrid],//, windGrid],
    buttons:[{
        text: 'Sluiten', 
        handler: function() {
            weathersettingsWindow.hide();
        }
    }]
});
weathersettingsWindow.hide();

function showClimateData() {
    weathersettingsWindow.show();
    weatherStore.loadData();
};

// overig

            function not_implemented() {
                Ext.Msg.show({
                    title: OpenLayers.i18n('Information'),
                    msg: OpenLayers.i18n("Not implemented yet"),
                    width: 400,
                    height: 400,
                    buttons: Ext.MessageBox.OK
                });
            }
            ;

/* vertaling: html, javascript, extjs, openlayers (teksten in OpenLayers.Lang), geoext (teksten in GeoExt.Lang.dict)
*/

OpenLayers.Util.applyDefaults(OpenLayers.Lang['nl'], {
    "Room for a description.": "Hier komt een beschrijving.",
    
    "${layerName} is now the active layer.": "Kaartlaag '${layerName}' is nu actief",
    
    "Layers": "Kaartlagen",
    
    "Simulation": "Simulatie",
    
    "Ignite": "Aansteken",
    
    "Description": "Beschrijving",
    
    "Information": "Informatie",
    
    "Wildfire modeling": "Simulatie van natuurbranden",
    
    "Not implemented yet": "Deze functie is nog niet ge√Ømplementeerd."
});
function translateDom() {
    // vertaalbare teksten in dom moeten class i18n hebben
    var code = OpenLayers.Lang.getCode();
    var dictionary = OpenLayers.Lang[code];
    if (code !== 'en' && dictionary !== 'undefined') {
        var els = Ext.DomQuery.select('.i18n');
        for (var i = 0; i < els.length; i++) {
            var el = els[i];
            if (typeof dictionary[el.innerHTML] !== 'undefined') {
                el.innerHTML = dictionary[el.innerHTML];
            }
        }
    }
}

var mapPanel, tree;
var status;

function online() {
//status.setAttribute("class", "online");
status.innerHTML = "Online";
}

function offline() {
//status.setAttribute("class", "offline");
status.innerHTML = "Offline";
}

// define Ext.onReady(fn, scope, options)
Ext.onReady(function() {
    var win;
    
    // dom is geladen en kan dus vertaald worden
    translateDom();
    
    status = document.getElementById('online-or-offline');

    if (navigator.onLine) {
        online();
    } else {
        offline();
    }

    window.addEventListener('online', online, false);
    window.addEventListener('offline', offline, false);
    
    // create a vector layer for drawing
    var vector = new OpenLayers.Layer.Vector('vector_drawing_layer', {
        displayInLayerSwitcher: false,
        styleMap: new OpenLayers.StyleMap({
            temporary: OpenLayers.Util.applyDefaults({
                    pointRadius: 16
                }, OpenLayers.Feature.Vector.style.temporary),
            'default': OpenLayers.Util.applyDefaults({
                    pointRadius: 16,
                    strokeWidth: 3
                }, OpenLayers.Feature.Vector.style['default']),
            select: OpenLayers.Util.applyDefaults({
                    pointRadius: 16,
                    strokeWidth: 3
                }, OpenLayers.Feature.Vector.style.select)
        })
    });
    // OpenLayers' EditingToolbar internally creates a Navigation control, we
    // want a TouchNavigation control here so we create our own editing toolbar
    var toolbar = new OpenLayers.Control.Panel({
        displayClass: 'olControlEditingToolbar'
    });
    toolbar.addControls([
        // this control is just there to be able to deactivate the drawing
        // tools
        new OpenLayers.Control({
            displayClass: 'olControlNavigation'
        }),
        new OpenLayers.Control.ModifyFeature(vector, {
            vertexRenderIntent: 'temporary',
            displayClass: 'olControlModifyFeature'
        }),/*
        new OpenLayers.Control.DrawFeature(vector, OpenLayers.Handler.Point, {
            displayClass: 'olControlDrawFeaturePoint'
        }),*/
        new OpenLayers.Control.DrawFeature(vector, OpenLayers.Handler.Path, {
            displayClass: 'olControlDrawFeaturePath'
        })/*,
        new OpenLayers.Control.DrawFeature(vector, OpenLayers.Handler.Polygon, {
            displayClass: 'olControlDrawFeaturePolygon'
        })*/
    ]);
    
    // van geoext example tree.html
    var nav, panel;
    mapPanel = new GeoExt.MapPanel({
        border: true,
        region: "center",
        // we do not want all overlays, to try the OverlayLayerContainer
        map: new OpenLayers.Map({
            allOverlays: false, 
            displayProjection: 'EPSG:4326',
            projection: 'EPSG:900913',
            controls: [
                new OpenLayers.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                }),
                new OpenLayers.Control.Zoom(),
                nav = new OpenLayers.Control.NavigationHistory(),
                //new OpenLayers.Control.Permalink(), // todo: uitzoeken werking geoext met permalink
                toolbar
            ]
        }),
        center: new OpenLayers.LonLat(5.946197509765718, 52.20750576821061).transform('EPSG:4326', 'EPSG:900913'), //[146.1569825, -41.6109735],
        zoom: 10,
        layers: [
            /*new OpenLayers.Layer.WMS("Global Imagery",
                "http://maps.opengeo.org/geowebcache/service/wms", {
                    layers: "bluemarble"
                }, {
                    isBaseLayer: true,
                    buffer: 0,
                    visibility: true
                }
            ),*/
            new OpenLayers.Layer.OSM({
                    transitionEffect: 'resize'
                }),
            new OpenLayers.Layer.WMS('Water', 'http://model.geodan.nl/geoserver/wms?', {
                    layers: 'nl_data:waterdeel_vlak',
                    format: 'image/png',
                    transparent: true
                }, {
                    isBaseLayer: false,
                    visibility: false,
                    maxExtent: OpenLayers.Bounds.fromString('361124.418941,6573545.115699,806881.242096,7095449.313188'),
                    transitionEffect: 'resize'
                }),
            new OpenLayers.Layer.WMS('KNMI Neerslagradar', 'http://geoservices.knmi.nl/cgi-bin/RADNL_OPER_R___25PCPRR_L3.cgi?', {
                    layers: 'RADNL_OPER_R___25PCPRR_L3_COLOR',
                    transparent: true,
                    format: 'image/png'
                }, {
                    visibility: false,
                    opacity: 0.6,
                    singleTile: true,
                    transitionEffect: 'resize'
                }),
            vector
            /*,
            new OpenLayers.Layer.WMS("Tasmania Roads",
                "http://demo.opengeo.org/geoserver/wms", {
                    layers: "topp:tasmania_roads",
                    transparent: true,
                    format: "image/gif"
                }, {
                    isBaseLayer: false,
                    buffer: 0
                }
            )*/
        ]
    });
    var panel = new OpenLayers.Control.Panel({
        //div: document.getElementById("panel")
    });
    panel.addControls([nav.next, nav.previous]);
    mapPanel.map.addControl(panel);
    
    // create our own layer node UI class, using the TreeNodeUIEventMixin
    var LayerNodeUI = Ext.extend(GeoExt.tree.LayerNodeUI, new GeoExt.tree.TreeNodeUIEventMixin());
    var treeConfig = [{
        nodeType: "gx_baselayercontainer",
        expanded: true
    }, {
        nodeType: "gx_overlaylayercontainer",
        expanded: true,
        // render the nodes inside this container with a radio button,
        // and assign them the group "foo".
        loader: {
            baseAttrs: {
                radioGroup: "foo",
                uiProvider: "layernodeui"
            }
        }
    }/*, {
        nodeType: "gx_layer",
        layer: "Tasmania (Group Layer)",
        isLeaf: false,
        // create subnodes for the layers in the LAYERS param. If we assign
        // a loader to a LayerNode and do not provide a loader class, a
        // LayerParamLoader will be assumed.
        loader: {
            param: "LAYERS"
        }
    }*/];
    
    // create the tree with the configuration from above
    tree = new Ext.tree.TreePanel({
        border: true,
        region: "west",
        title: OpenLayers.i18n("Layers"),
        width: 200,
        split: true,
        collapsible: true,
        collapseMode: "mini",
        autoScroll: true,
        plugins: [
            new GeoExt.plugins.TreeNodeRadioButton({
                listeners: {
                    "radiochange": function(node) {
                        alert(OpenLayers.i18n("${layerName} is now the active layer.", {layerName: node.text}));
                    }
                }
            })
        ],
        loader: new Ext.tree.TreeLoader({
            // applyLoader has to be set to false to not interfere with loaders
            // of nodes further down the tree hierarchy
            applyLoader: false,
            uiProviders: {
                "layernodeui": LayerNodeUI
            }
        }),
        root: {
            nodeType: "async",
            // the children property of an Ext.tree.AsyncTreeNode is used to
            // provide an initial set of layer nodes. We use the treeConfig
            // from above, that we created with OpenLayers.Format.JSON.write.
            //children: Ext.decode(treeConfig)
            // Don't use the line above in your application. Instead, use
            children: treeConfig
            
        },
        listeners: {
            "radiochange": function(node){
                alert(OpenLayers.i18n("${layerName} is now the active layer.", {layerName: node.layer.name}));
            }
        },
        rootVisible: false,
        lines: false,
        bbar: [{
            contentEl: document.getElementById('show-btn'),
            text: OpenLayers.i18n("Ignite"),
            handler: function() {
                not_implemented();
                //treeConfigWin.show();
                //Ext.getCmp("treeconfig").setValue(treeConfig);
            }
        }, {
            text: OpenLayers.i18n('Climate data'),
            handler: showClimateData
        }, {
            text: OpenLayers.i18n('Wfs Grid'),
            handler: function() {
                var map = mapPanel.map;
                var layers = map.getLayersByName('wfs_vector_landscapes');
                if (layers.length > 0) {
                    var wfsLayer = layers[0];
                } else {
                    // wfs kaartlaag toevoegen
                    var wfsLayer = new OpenLayers.Layer.Vector("wfs_vector_landscapes", {
                        //rendererOptions: {
                        //    zIndexing: true
                        displayInLayerSwitcher: false,
                        styleMap: new OpenLayers.StyleMap({
                            'default': new OpenLayers.Style({
                                //display: 'none',
                                fillColor: '#aaaaaa',
                                fillOpacity: 0.2,
                                strokeColor: '#888888',
                                strokeOpacity: 0.4
                            }),
                            'select': new OpenLayers.Style({
                                fillColor: '#ff8800',
                                fillOpacity: 0.6,
                                strokeColor: '#ff0000',
                                strokeOpacity: 0.6,
                                strokeWidth: '3px',
                                display: 'visible'
                            })
                        })
                    });
                    // TODO: voor wfs laag alleen geselecteerde feature tonen!
                    mapPanel.map.addLayer(wfsLayer);
                }
                // create feature store, binding it to the vector layer
                var store = new GeoExt.data.FeatureStore({
                    layer: wfsLayer,
                    /*fields: [
                        {name: 'landscape_name', type: 'string'},
                        {name: 'started', type: 'date'}
                    ],*/
                    //recordType: TerrainFeatureRecord,
                    reader: new GeoExt.data.FeatureReader({}, TerrainFeatureRecord),
                    proxy: new GeoExt.data.ProtocolProxy({
                        protocol: new OpenLayers.Protocol.WFS({
                            url: "/geoserver/ows",
                            version: "1.1.0",
                            featureType: 'landscapes',
                            featureNS: 'model_wildfire',
                            srsName: 'EPSG:900913'//,
                            //outputFormat: 'application/json', // richting geoserver
                            //format: new OpenLayers.Format.GeoJSON() // ??
                        })
                    }),
                    autoLoad: true
                });
                console.log('Store', store);
                // create grid panel configured with feature store
                gridPanel = new Ext.grid.GridPanel({
                    title: "Feature Grid",
                    applyTo: "desc",
                    region: "east",
                    store: store,
                    width: 320,
                    height: 400,
                    columns: [{
                        header: "Naam",
                        width: 200,
                        sortable: true,
                        dataIndex: "landscape_name"
                    }, {
                        header: 'Begintijd',
                        width: 200,
                        sortable: true,
                        dataIndex: 'started'
                    }],
                    sm: new GeoExt.grid.FeatureSelectionModel({
                        autoPanMapOnSelection: false, // we zoomen er zelf naartoe
                        singleSelect: true
                    })
                });
                
                gridPanel.store.bind(wfsLayer);
                gridPanel.getSelectionModel().bind(wfsLayer);
                gridPanel.getSelectionModel().on('rowselect', function (obj, rowIndex, row){
                    console.log('rowselect', row.data.feature);
                    var center = row.data.feature.geometry.getCentroid();
                    mapPanel.map.panTo(new OpenLayers.LonLat(center.x, center.y));
                    
                    var time = new Date(row.data.feature.attributes['started']);
                    time = new Date(time.getTime() - time.getTime() % (5*60*1000)); // round to 5 minutes
                    console.log('tijd afgerond', time);
                    var map = row.data.feature.layer.map;
                    var layers = map.getLayersByName('KNMI Neerslagradar');
                    if (layers.length > 0) {
                        var layer = layers[0];
                        layer.mergeNewParams({time: time.toISOString()});
                    }
                }, gridPanel);

                // create a panel and add the map panel and grid panel
                // inside it
                /*mainPanel = new Ext.Panel({
                    renderTo: "mainpanel",
                    layout: "border",
                    height: 400,
                    width: 920,
                    items: [mapPanel, gridPanel]
                });*/
            }
        }]
    });
    
    var viewportItems = [mapPanel, tree];
    if (document.getElementById('desc')) {
        viewportItems.push({
            contentEl: document.getElementById('desc'),
            region: "east",
            bodyStyle: {"padding": "5px"},
            collapsible: true,
            collapseMode: "mini",
            split: true,
            width: 200,
            title: OpenLayers.i18n("Simulation")
        });
    }
    
    new Ext.Viewport({
        layout: "fit",
        hideBorders: true,
        items: {
            layout: "border",
            deferredRender: false,
            items: viewportItems
        }
    });
 
    var button = Ext.get('show-btn');

    button.on('click', function() {
        // create the window on the first click and reuse on subsequent clicks
        if (!win) {
            win = new Ext.Window({
                applyTo: 'hello-win',
                title: 'Simulatie', // of hier of in div met class x-window-header
                layout: 'fit',
                width: 500,
                height: 300,
                closeAction: 'hide', // NB anders slechts 1x bruikbaar
                plain: true,
                modal: true,
                items: new Ext.TabPanel({
                    //applyTo: 'hello-tabs',
                    renderTo: Ext.get('hello-win'),
                    //autoTabs: true,
                    activeTab: 0,
                    deferredRender: false,
                    border: false,
                    items: [{
                            xtype: 'form',
                            title: 'Gebied', // 1ste tab
                            defaults: {
                                width: 150
                            },
                            items: [
                                {
                                    xtype: 'textfield',
                                    fieldLabel: 'Naam gebied'
                                },
                                {
                                    xtype: 'button',
                                    fieldLabel: 'Selecteer gebied',
                                    handler: not_implemented
                                },
                                {
                                    xtype: 'combo',
                                    fieldLabel: 'Choose version',
                                    store: ['3.0', '2.0', '1.0']
                                },
                                {
                                    xtype: 'button',
                                    fieldLabel: 'Opslaan'
                                }
                            ]
                        }, {
                            xtype: 'form',
                            title: 'Weersomstandigheden', // 2de tab
                            defaults: {
                                width: 150
                            },
                            items: [
                                {
                                    xtype: 'textfield',
                                    fieldLabel: 'Name'
                                },
                                {
                                    xtype: 'checkbox',
                                    fieldLabel: 'Do you love Ext?'
                                },
                                {
                                    xtype: 'combo',
                                    fieldLabel: 'Choose version',
                                    store: ['3.0', '2.0', '1.0']
                                }
                            ]
                        }, {
                            xtype: 'form',
                            title: 'Tijd', // 3de tab
                            items: [
                                {
                                    xtype: 'datefield',
                                    fieldLabel: 'Begintijd',
                                    width: 'auto',
                                    format: 'd-m-Y'
                                }
                                , {
                                    xtype: 'datefield',
                                    fieldLabel: 'Eindtijd',
                                    width: 'auto',
                                    format: 'd-m-Y'
                                }
                            ]
                        }
                    ]
                }),
                buttons: [{
                        text: 'Help',
                        handler: not_implemented
                    }, {
                        text: 'Annuleren',
                        disabled: true
                    }, {
                        text: 'Start',
                        handler: not_implemented,
                        handlerX: function() {
                            win.hide();
                        }
                    }]
            });
        }
        win.show(this);
    });

});
//-->
        </script>
        <div id="online-or-offline">?</div>
        <input type="button" id="show-btn" value="Open dialoog" />
        <br />
        <br />
        <div id="hello-win" class="x-hidden">
        </div>
        <div id="wfsgrid">WFS grid</div>

        <div class="x-window-header">Simulatie</div>
        <div id="hello-tabs">
            <!-- Auto create tab 1 -->
            <div class="x-tab" title="Hello World 1">
                <p>Hello...</p>
            </div>
            <!-- Auto create tab 2 -->
            <div class="x-tab" title="Hello World 2">
                <p>... World!</p>
            </div>
        </div>
        
        <div id="desc" class="i18n">Room for a description.</div>
    </body>
</html>
