<!DOCTYPE html>
<html><!-- nomanifest="app.manifest" -->
    <head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
    <meta charset="UTF-8">
        <title class="i18n">Wildfire modeling</title>
        <!-- Ext resources -->
        <link rel="stylesheet" type="text/css"
              href="./externals/ext-3.4.1/resources/css/ext-all.css" />
        <link rel="stylesheet" type="text/css"
              href="./externals/ext-3.4.1/resources/css/xtheme-gray.css" />
        
        <!-- EITHER default ext js adapter -->
        <!--script type="text/javascript" src="externals/ext-3.4.1/adapter/ext/ext-base-debug.js"></script-->
        <!-- OR jquery library and related extjs adapter -->
        <script type="text/javascript" src="externals/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="externals/ext-3.4.1/adapter/jquery/ext-jquery-adapter-debug.js"></script>
        
        <!-- rest of extjs -->
        <script type="text/javascript" src="externals/ext-3.4.1/ext-all-debug.js"></script>
        
	<!-- Proj resources -->
	<script type="text/javascript" src="externals/proj4js_combined.js"></script>
        
        <script type="text/javascript" src="externals/OpenLayers-2.12/OpenLayers.js"></script>
        <script type="text/javascript" src="externals/OpenLayers-2.12/lib/OpenLayers/Lang/nl.js"></script>
        <link rel="stylesheet" type="text/css" href="externals/OpenLayers-2.12/theme/default/style.css" />
        <!-- GeoExt -->
        <script src="externals/GeoExt/lib/GeoExt.js" type="text/javascript"></script>
        <script src="externals/GeoExt/lib/GeoExt/locale/GeoExt-fr.js" type="text/javascript"></script>
        <script src="externals/GeoExt/lib/GeoExt/locale/GeoExt-nl.js" type="text/javascript"></script>
	<!-- gxp resources -->
	<link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/all.css" />
	<script type="text/javascript" src="externals/gxp/src/script/loader.js"></script>
	<script type="text/javascript">
        /** Create viewer instance, this is the core of the app **/
        Proj4js.defs["EPSG:28992"] = "+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079  +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.417,50.3319,465.552,-0.398957,0.343988,-1.8774,4.0725 +units=m +no_defs";
        Proj4js.defs["EPSG:32631"] = "+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"; 
        </script>
        <script type="text/javascript">
if (typeof String.prototype.startsWith !== 'function') {
    // needed for Chrome browser
    String.prototype.startsWith = function (str){
        return this.slice(0, str.length) === str;
    };
}
        </script>
        <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/geoext-all.css" />
        <link rel="stylesheet" type="text/css" href="css/natuurbrandmodel.css" />
    </head>
    <body>
        <script>
//<!--
// settings
Ext.namespace('Gmi.Settings', 'Gmi.Session', 'Gmi.Services', 'Gmi.Services.WPS');

Gmi.Settings.openLayers_imgPath = 'img/';
Gmi.Settings.openLayers_proxyHost = 'proxy.php?url=';
Gmi.Settings.maxArea = 10000 * 10000; // m2; 10 bij 10 km, 100 km2
Gmi.Settings.tijd_afronding_minuten = 5;
Gmi.Settings.operationalMode = 1;
Gmi.Settings.dateFormat = 'Y-m-d';
Gmi.Settings.decimalSeparator = ',';

Gmi.Session.userid = '0';
Gmi.Version = '0.1';

OpenLayers.imgPath = Gmi.Settings.openLayers_imgPath;
OpenLayers.ProxyHost = Gmi.Settings.openLayers_proxyHost;

// Models
Gmi.Services.WPS = {
    url: '/geoserver/ows?',
    
    request: function(options) {
        var config = Ext.extend({
            url: '/geoserver/ows?',
            params: {
                service: 'WPS',
                version: '1.1.0',
                request: 'execute',
                identifier: 'py:wildfire_makesubset',
                datainputs: combineParams({
                    userid: Gmi.Session.userid,
                    name: 'test',
                    left: bounds.left,
                    lower: bounds.bottom,
                    right: bounds.right,
                    upper: bounds.top
                }, ';'),
                RawDataOutput: 'string',
                mimeType: 'application/json'
            }
        }, options);
        Ext.Ajax.Request(config);
    }
};

// klimaatgegevens

var WeatherRecord = new Ext.data.Record.create([
    { name: 'station', type: 'int'},
    { name: 'date', type: 'date'},
    { name: 'precipitation', type: 'float'},
    { name: 'hour1', type: 'int'},
    { name: 'hour2', type: 'int'},
    { name: 'tmin', type: 'float'},
    { name: 'tmax', type: 'float'},
    { name: 'hmin', type: 'float'}, // max. 99 in model
    { name: 'hmax', type: 'float'} // max. 99 in farsite model
]);

var WindRecord = new Ext.data.Record.create([
    { name: 'station', type: 'int'},
    { name: 'date', type: 'date'},
    { name: 'time', type: 'string'}, // hhmm
    { name: 'speed', type: 'float'}, // km/h farsite, km/s gebruiker
    { name: 'direction', type: 'float'}, // degrees
    { name: 'cloudiness', type: 'float'} // percentage
]);

var TerrainFeatureRecord = new GeoExt.data.FeatureRecord.create([
    {name: 'landscape_name', type: 'string'},
    {name: 'started', type: 'date'}
]);

function stringToFloat(s) {
    var f = parseFloat(s);
    if (isNaN(f)) {
        f = 0.0;
    }
    return f;
};

function weatherTextToRecords(end_ymd, data) {
    var records = [];

    // splits data in regels en verwijder commentaar en lege regels
    // datum is oplopend gesorteerd
    var lines = data.split('\n').filter(function(line){return line.length > 0 && !line.startsWith('#');});
    var last_ymd = '00000000';
    for (var i = 0; i < lines.length; i++) {
        var tokens = lines[i].split(/[,\s]+/g).filter(function(token){return token.length > 0;});
        console.log(tokens);

        last_ymd = tokens[1];
        records.push(new WeatherRecord({
            station: tokens[0],
            date: Date.parseDate(tokens[1], 'Ymd'), // convert yyyymmdd to date?
            tmin: parseFloat(tokens[2])/10,
            hour1: parseInt(tokens[3]),
            tmax: parseFloat(tokens[4])/10,
            hour2: parseInt(tokens[5]),
            hmin: parseFloat(tokens[6]),
            hmax: parseFloat(tokens[8]),
            precipitation: Math.max(0, stringToFloat(tokens[10])) / 10
        }));
    }
    if (records.length > 0 && end_ymd !== last_ymd) {
        // voeg laatste record toe met zelfde gegevens behalve datum
        records.push(new WeatherRecord(OpenLayers.Util.applyDefaults({date: Date.parseDate(end_ymd, 'Ymd')}, records[records.length-1].data)));
    }
    return records;
}

var climateStations = [];

function getClimateData(station) {
    //var today = Ext.util.Format.date(new Date(), 'Ymd');
    var end = Ext.getCmp('model_date').getValue();
    //end.setDate(end.getDate() + 1); // ook morgen
    var end_ymd = end.dateFormat('Ymd');
    
    var start = new Date(end);
    start.setDate(end.getDate() - 6);
    var start_ymd = start.dateFormat('Ymd');
    
    var today = new Date();
    
    // NB: proxy nodig voor direct ophalen
    //Ext.Ajax.request({
    var vars = 'TN:TNH:TX:TXH:UN:UNH:UX:UXH:RH'; // Minimum temperatuur, uur, maximum temp, uur, Minimale relatieve vochtigheid, uur, max rel vocht, uur, etmaalsom neerslag
    var request = OpenLayers.Request.GET({
        url: 'http://www.knmi.nl/klimatologie/daggegevens/getdata_dag.cgi',
        async: false, // synchroon opvragen
        params: {
            stns: station,
            vars: 'TN:TNH:TX:TXH:UN:UNH:UX:UXH:RH', // station,datum, ...
            start: start_ymd,
            end: end_ymd
        },
        success: function(response) {
            var data = response.responseText; // bij OpenLayers request
        }
    });
    var text = request.responseText;
    return weatherTextToRecords(end_ymd, text);
};

function getWindData(station) {
    var model_datetime = getModelDateTime();
    
    var records = [];
    records.push(new WindRecord({
        station: station,
        date: model_datetime,
        time: zpad(model_datetime.getHours(), 2) + '00',
        speed: 1,
        direction: 0,
        cloudiness: 0
    }));
    var tomorrow = new Date(model_datetime);
    tomorrow.setDate(tomorrow.getDate() + 1);
    records.push(new WindRecord({
        station: station,
        date: tomorrow,
        time: zpad(model_datetime.getHours(), 2) + '00',
        speed: 1,
        direction: 0,
        cloudiness: 0
    }));
    return records;
};

var weatherColumnModel = new Ext.grid.ColumnModel({
    defaults: {
        sortable: true, // columns are not sortable by default
        width: 100,
        align: 'right',
        format: '000.0',
        editable: true,
        xtype: 'numbercolumn'
    },
    columns: [
    {
        header: 'Station',
        dataIndex: 'station',
        hidden: true,
        format: '000'
        /*{
        editor: new Ext.form.DateField({  // rules about editing
                format: 'Y-m-d',
                allowBlank: false,
                maxLength: 10
        })*/
    }, {
        header: 'Date',
        dataIndex: 'date',
        width: 100,
        align: 'right',
        format: Gmi.Settings.dateFormat,
        xtype: 'datecolumn'
    }, {
        header: 'Tmin (°C)',
        format: '00.0',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            decimalSeparator: Gmi.Settings.decimalSeparator,
            maxLength: 4
        }),
        dataIndex: 'tmin'
    }, {
        header: 'Tmax (°C)',
        format: '00.0',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            decimalSeparator: Gmi.Settings.decimalSeparator,
            maxLength: 4
        }),
        dataIndex: 'tmax'
    }, {
        header: 'RVmin (%)',
        format: '000',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            maxLength: 3,
            minValue: 0,
            maxValue: 100
        }),
        dataIndex: 'hmin'
    }, {
        header: 'RVmax (%)',
        format: '000',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            maxLength: 3,
            minValue: 0,
            maxValue: 100
        }),
        dataIndex: 'hmax'
    }, {
        header: 'Rainfall',
        format: '000.0',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            maxLength: 5,
            minValue: 0,
            maxValue: 100
        }),
        dataIndex: 'precipitation'
    }]
});

var windColumnModel = new Ext.grid.ColumnModel({
    defaults: {
        sortable: true, // columns are not sortable by default
        width: 100,
        align: 'right',
        format: '000.0',
        xtype: 'numbercolumn'
    },
    columns: [
    {
        header: 'Station',
        dataIndex: 'station',
        hidden: true,
        format: '000'
        /*{
        editable: true,
        editor: new Ext.form.DateField({  // rules about editing
                format: 'Y-m-d',
                allowBlank: false,
                maxLength: 10
        })*/
    }, {
        header: 'Date',
        dataIndex: 'date',
        width: 100,
        align: 'right',
        format: Gmi.Settings.dateFormat,
        xtype: 'datecolumn'
    }, {
        header: 'Time',
        dataIndex: 'time',
        format: 'H:i',
        align: 'right',
        editable: true,
        xtype: 'datecolumn'
    }, {
        header: 'Speed (m/s)',
        format: '00.0',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            maxLength: 3
        }),
        dataIndex: 'speed'
    }, {
        header: 'Direction (&deg;)',
        format: '000',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            maxLength: 3
        }),
        dataIndex: 'direction'
    }, {
        header: 'Cloudiness (%)',
        format: '000',
        editable: true,
        editor: new Ext.form.NumberField({  // rules about editing
            allowBlank: false,
            maxLength: 3
        }),
        dataIndex: 'cloudiness'
    }]
});

var weatherStore = new Ext.data.Store({
    id: 'weatherStore',
    autoSave: false,
    recordType: WeatherRecord,
    sortInfo: { field: "date", direction: "DESC" },
    reader: {
        readRecords: function() {
            var station = Ext.getCmp('weatherstation'); // naam zit in .lastSelectionText
            var records = getClimateData(station.value);
            if (records) {
                weatherGrid.setTitle(OpenLayers.i18n('Weather characteristics - ${name}', {name: station.lastSelectionText}));
            }
            return {
                records: records
            };
        }
    },
    writer: new Ext.data.JsonWriter({
        encode: true,
        writeAllFields: false
    })
});

var windStore = new Ext.data.Store({
    id: 'windStore',
    autoSave: false,
    recordType: WindRecord,
    sortInfo: { field: 'time', direction: 'ASC' },
    reader: {
        readRecords: function() {
            var station = Ext.getCmp('weatherstation');
            var records = getWindData(station.value);
            return {
                records: records
            };
        }
    },
    writer: new Ext.data.JsonWriter({
        encode: true,
        writeAllFields: false
    })
});

var weatherGrid = new Ext.grid.EditorGridPanel({
    id: 'weathergrid',
    title: OpenLayers.i18n('Weather characteristics'),
    store: weatherStore,
    clicksToEdit: 1,
    cm: weatherColumnModel
});

var windGrid = new Ext.grid.EditorGridPanel({
    id: 'windgrid',
    title: OpenLayers.i18n('Wind characteristics'),
    store: windStore,
    clicksToEdit: 1,
    cm: windColumnModel
});

var weathersettingsWindow = new Ext.Window({
    id: 'weathersettingsWindow',
    title: OpenLayers.i18n("Weather settings"),
    width: 600,
    height: 400,
    closable: true,
    closeAction: 'hide',
    autoScroll: true,
    hideable: true,
    resizable: true,
    draggable: true,
    modal: true,
    //width: '40%',
    //height: '600',
    plain: true,
    layout: 'fit', // fit grid in window
    //modal: false,
    defaults: {
        height: 100
    },
    items: [
        new Ext.form.ComboBox({
            id: 'weatherstation2',
            fieldLabel: 'Weather station',
            name: 'station',
            typeAhead: true,
            triggerAction: 'all',
            lazyRender: true,
            anchor: '100%',
            align: 'right',
            mode: 'local',
            value: 275, // default: Deelen
            forceSelection: true, editable: false,
            store: new Ext.data.ArrayStore({
                id: 0,
                fields: [
                    'id',
                    'naam'
                ],
                data: [[0, 'Eigen gegevens'], [260, 'De Bilt'], [275, 'Deelen'], [283, 'Hupsel'], [375, 'Volkel']]
            }),
            valueField: 'id',
            displayField: 'naam',
            listeners: {
                'select': function() {
                        not_implemented();
                    }
            }
        }),
        weatherGrid, 
        windGrid
    ],
    buttons:[{
        text: OpenLayers.i18n('Close'), 
        handler: function() {
            weathersettingsWindow.hide();
        }
    }]
});
weathersettingsWindow.hide();

function showClimateData() {
    weathersettingsWindow.show();
    
    if (weatherStore.getRange().length == 0) {
        weatherStore.loadData();
    }
    if (windStore.getRange().length == 0) {
        windStore.loadData();
    }
    
    weatherGrid.startEditing(0, 0);
    windGrid.startEditing(0, 0);
};

// overig

            function not_implemented() {
                Ext.Msg.show({
                    title: OpenLayers.i18n('Information'),
                    msg: OpenLayers.i18n("Not implemented yet"),
                    width: 400,
                    height: 400,
                    buttons: Ext.MessageBox.OK
                });
            }
            ;

/* vertaling: html, javascript, extjs, openlayers (teksten in OpenLayers.Lang), geoext (teksten in GeoExt.Lang.dict)
*/

OpenLayers.Util.applyDefaults(OpenLayers.Lang['nl'], {
    "Room for a model panel.": "Hier komt een simulatie model.",
    
    "${layerName} is now the active layer.": "Kaartlaag '${layerName}' is nu actief",
    
    "Layers": "Kaartlagen",
    
    "Simulation model": "Simulatiemodel",
    
    "Close": "Sluiten",
    
    "Ignite": "Aansteken",
    
    "Description": "Beschrijving",
    
    "Information": "Informatie",
    
    "Wildfire modeling": "Simulatie van natuurbranden",
    
    "Not implemented yet": "Deze functie is nog niet geïmplementeerd."
});
function translateDom() {
    // vertaalbare teksten in dom moeten class i18n hebben
    var code = OpenLayers.Lang.getCode();
    var dictionary = OpenLayers.Lang[code];
    if (code !== 'en' && dictionary !== 'undefined') {
        var els = Ext.DomQuery.select('.i18n');
        for (var i = 0; i < els.length; i++) {
            var el = els[i];
            if (typeof dictionary[el.innerHTML] !== 'undefined') {
                el.innerHTML = dictionary[el.innerHTML];
            }
        }
    }
}

var mapPanel, tree;
var status;

function online() {
//status.setAttribute("class", "online");
status.innerHTML = "Online";
}

function offline() {
//status.setAttribute("class", "offline");
status.innerHTML = "Offline";
}

// define Ext.onReady(fn, scope, options)
Ext.onReady(function() {
    var win;
    
    // dom is geladen en kan dus vertaald worden
    translateDom();
    
    // maak tooltips mogelijk
    Ext.QuickTips.init();
    
    status = document.getElementById('online-or-offline');

    if (navigator.onLine) {
        online();
    } else {
        offline();
    }

    window.addEventListener('online', online, false);
    window.addEventListener('offline', offline, false);
    
    // create a vector layer for drawing
    var wildfire_layer = new OpenLayers.Layer.Vector('Wildfire lines', {
        displayInLayerSwitcher: false,
        styleMap: new OpenLayers.StyleMap({
            temporary: OpenLayers.Util.applyDefaults({
                    pointRadius: 5,
                    strokeWidth: 3,
                    strokeOpacity: 1,
                    strokeColor: "#ff0000",
                    strokeDashstyle: "dash"
                }, OpenLayers.Feature.Vector.style.temporary),
            'default': OpenLayers.Util.applyDefaults({
                    pointRadius: 5,
                    strokeWidth: 3,
                    strokeColor: '#ff0000'
                }, OpenLayers.Feature.Vector.style['default']),
            select: OpenLayers.Util.applyDefaults({
                    pointRadius: 5,
                    strokeWidth: 3
                }, OpenLayers.Feature.Vector.style.select)
        }),
        eventListeners: {
            beforefeatureadded: function(event) {
                // remove other features
                event.object.removeAllFeatures();
                return true;
            },
            featureadded: function(event) {
                // event = type, element, feature, object (layer)
                console.log('featureadded', event.feature);
            },
            scope: wildfire_layer
        }
    });
    
    var measureControl = new OpenLayers.Control.Measure( OpenLayers.Handler.Path, {
        immediate: true,
        persist: true,
        displayClass: 'olControlMeasure',
        title: OpenLayers.i18n('Measure distances in map'),
        handlerOptions: {
            layerOptions: {
                styleMap: new OpenLayers.StyleMap({
                    "default": new OpenLayers.Style(null, {
                        rules: [new OpenLayers.Rule({
                            symbolizer: {
                                "Point": {
                                    pointRadius: 4,
                                    graphicName: "square",
                                    fillColor: "white",
                                    fillOpacity: 1,
                                    strokeWidth: 1,
                                    strokeOpacity: 1,
                                    strokeColor: "#333333"
                                },
                                "Line": {
                                    strokeWidth: 3,
                                    strokeOpacity: 1,
                                    strokeColor: "#666666",
                                    strokeDashstyle: "dash"
                                },
                                "Polygon": {
                                    strokeWidth: 2,
                                    strokeOpacity: 1,
                                    strokeColor: "#666666",
                                    fillColor: "white",
                                    fillOpacity: 0.3
                                }
                            }
                        })]
                    })
                })
            }
        }
    });  

    measureControl.getCustomLength = function(evt, onlySum) {
    
        var el = document.getElementById('measure-tip');
        if (! el) {
            if (jQuery) {
                jQuery('body').append('<div id="measure-tip" style="border: solid; background-color: white; position: absolute; top: 300px; z-index: 1020; padding: 4px;"></div>');
            } else {
                el = document.createElement('div');
                el.id = 'measure-tip';
                el.style.border = 'solid';
                el.style.backgroundColor = 'white';
                el.style.position = 'absolute';
                el.style.height = '20px';
                el.style.width = '300px';
                el.style.left = '500px';
                el.style.top = '300px';
                document.getElementsByTagName('body')[0].appendChild(el);
            }
        }
    
        var idx = evt.geometry.components.length;

        if (idx < 2)
            return '';

        //$('#map-size').html(ui.size.width + 'x' + ui.size.height)
        //.css({ left: Math.floor(ui.size.width/2) + 'px', top: Math.floor(ui.size.height/2) + 'px' }); 

        var str = '';
        if (idx > 2 || onlySum) {
            str = OpenLayers.i18n('Distance: ${distance} ${units}', {
                distance: evt.units === 'km' ? evt.measure.toFixed(3) : evt.measure.toFixed(1), 
                units: evt.units
            });
            //str += 'Total: ' + (evt.units === 'km' ? evt.measure.toFixed(3) : evt.measure.toFixed(1)) + ' ' + evt.units;// + '&nbsp;&nbsp;&nbsp;';
        }

        if (!onlySum) {
            // bepaal ook lengte van laatste segment
            var geom = new OpenLayers.Geometry.LineString([
                evt.geometry.components[idx - 2],
                evt.geometry.components[idx - 1]
            ]);
            var lastLengthArr = this.getBestLength(geom);

            str += 'Last segment: ' + (lastLengthArr[1] === 'km' ?  lastLengthArr[0].toFixed(3) : lastLengthArr[0].toFixed(1)) + ' ' + lastLengthArr[1];
        }

        return str;
    };

    //map.addControl(measureControl); 

    // Update content in .foo div   
    measureControl.events.on({
        'deactivate': function(evt) {
            console.log('deactivate', evt);
            var el = document.getElementById('measure-tip');
            if (el) {
                // opruimen
                jQuery('#measure-tip').remove();
            }
        },
        'measure': function(evt) {
            //$('.foo').html();
            console.log('measure', evt);
            var distanceMsg = measureControl.getCustomLength(evt, true);
            //jQuery('#measure-tip').text(str);
            var el = document.getElementById('measure-tip');
            el.innerHTML = distanceMsg;

            console.log('afstand', distanceMsg);
        },
        'measurepartial': function(evt) {
            //$('.foo').html(measureControl.getCustomLength(evt, false));
            console.log('measurepartial', evt);
            var distanceMsg = measureControl.getCustomLength(evt, false);
            //jQuery('#measure-tip').text(str);
            var el = document.getElementById('measure-tip');
            el.innerHTML = distanceMsg;
            console.log('afstand', distanceMsg);
        }
    });

    // OpenLayers' EditingToolbar internally creates a Navigation control, we
    // want a TouchNavigation control here so we create our own editing toolbar
    var toolbar = new OpenLayers.Control.Panel({
        displayClass: 'olControlEditingToolbar',
        activateControl: function(c) {
            console.log('activate control', c);
            if (c.CLASS_NAME === 'OpenLayers.Control.ModifyFeature') {
                if (c.layer.features.length > 0) {
                    c.selectFeature(c.layer.features[0]);
                }
            }
            return OpenLayers.Control.Panel.prototype.activateControl.apply(this, [c]);
        }
    });
    toolbar.addControls([
        // this control is just there to be able to deactivate the drawing
        // tools
        new OpenLayers.Control({
            displayClass: 'olControlNavigation',
            title: OpenLayers.i18n('Navigate in map')
        }),
        measureControl,
        new OpenLayers.Control.ModifyFeature(wildfire_layer, {
            vertexRenderIntent: 'temporary',
            displayClass: 'olControlModifyFeature',
            title: OpenLayers.i18n('Modify existing fire line')
        }),
        /*new OpenLayers.Control.DrawFeature(wildfire_layer, OpenLayers.Handler.Point, {
            displayClass: 'olControlDrawFeaturePoint'
        }),*/
        new OpenLayers.Control.DrawFeature(wildfire_layer, OpenLayers.Handler.Path, {
            displayClass: 'olControlDrawFeaturePath',
            title: OpenLayers.i18n('Draw new fire line')
        })/*,
        new OpenLayers.Control.DrawFeature(wildfire_layer, OpenLayers.Handler.Polygon, {
            displayClass: 'olControlDrawFeaturePolygon'
        })*/
    ]);

    // van geoext example tree.html
    var nav, panel;
    mapPanel = new GeoExt.MapPanel({
        border: true,
        region: "center",
        // we do not want all overlays, to try the OverlayLayerContainer
        map: new OpenLayers.Map({
            allOverlays: false, 
            displayProjection: 'EPSG:4326',
            projection: 'EPSG:900913',
            theme: null,
            controls: [
                new OpenLayers.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                }),
                new OpenLayers.Control.Zoom({title: OpenLayers.i18n('Change zoom')}),
                new OpenLayers.Control.ScaleLine({bottomOutUnits: '', bottomInUnits: '', title: 'scaleline'}),
                nav = new OpenLayers.Control.NavigationHistory({
                    //displayClass: 'olControlCustomToolbar'
                    previousOptions: {
                        title: OpenLayers.i18n('Restore previous extent')
                    },
                    nextOptions: {
                        title: OpenLayers.i18n('Restore next extent')
                    }
                }),
                //new OpenLayers.Control.Permalink(), // todo: uitzoeken werking geoext met permalink
                toolbar
            ]
        }),
        center: new OpenLayers.LonLat(5.946197509765718, 52.20750576821061).transform('EPSG:4326', 'EPSG:900913'), //[146.1569825, -41.6109735],
        zoom: 10,
        layers: [
            /*new OpenLayers.Layer.WMS("Global Imagery",
                "http://maps.opengeo.org/geowebcache/service/wms", {
                    layers: "bluemarble"
                }, {
                    isBaseLayer: true,
                    buffer: 0,
                    visibility: true
                }
            ),*/
            new OpenLayers.Layer.OSM(),
            new OpenLayers.Layer.WMS('Water', 'http://model.geodan.nl/geoserver/wms?', {
                    layers: 'nl_data:waterdeel_vlak',
                    format: 'image/png',
                    transparent: true
                }, {
                    isBaseLayer: false,
                    visibility: false,
                    maxExtent: OpenLayers.Bounds.fromString('361124.418941,6573545.115699,806881.242096,7095449.313188'),
                    transitionEffect: 'resize'
                }),
            new OpenLayers.Layer.WMS('KNMI Neerslagradar', 'http://geoservices.knmi.nl/cgi-bin/RADNL_OPER_R___25PCPRR_L3.cgi?', {
                    layers: 'RADNL_OPER_R___25PCPRR_L3_COLOR',
                    transparent: true,
                    format: 'image/png'
                }, {
                    visibility: false,
                    opacity: 0.6,
                    singleTile: true,
                    transitionEffect: 'resize'
                }),
            wildfire_layer,
            new OpenLayers.Layer.Boxes('_boxes_', {displayInLayerSwitcher: false})
            /*,
            new OpenLayers.Layer.WMS("Tasmania Roads",
                "http://demo.opengeo.org/geoserver/wms", {
                    layers: "topp:tasmania_roads",
                    transparent: true,
                    format: "image/gif"
                }, {
                    isBaseLayer: false,
                    buffer: 0
                }
            )*/
        ]
    });
    var panel = new OpenLayers.Control.Panel({
        //div: document.getElementById("panel")
        displayClass: 'olControlCustomToolbar'
    });
    panel.addControls([nav.next, nav.previous]);
    mapPanel.map.addControl(panel);
    
    // create our own layer node UI class, using the TreeNodeUIEventMixin
    var LayerNodeUI = Ext.extend(
        GeoExt.tree.LayerNodeUI, 
        new GeoExt.tree.TreeNodeUIEventMixin()
    );
    var treeConfig = [{
        nodeType: "gx_baselayercontainer",
        expanded: true
    }, {
        nodeType: "gx_overlaylayercontainer",
        expanded: true,
        // render the nodes inside this container with a radio button,
        // and assign them the group "foo".
        loader: {
            baseAttrs: {
                radioGroup: "foo",
                uiProvider: "layernodeui"
            }
        }
    }/*, {
        nodeType: "gx_layer",
        layer: "Tasmania (Group Layer)",
        isLeaf: false,
        // create subnodes for the layers in the LAYERS param. If we assign
        // a loader to a LayerNode and do not provide a loader class, a
        // LayerParamLoader will be assumed.
        loader: {
            param: "LAYERS"
        }
    }*/];
    
    // create the tree with the configuration from above
    tree = new Ext.tree.TreePanel({
        border: true,
        region: "west",
        title: OpenLayers.i18n("Layers"),
        width: 200,
        split: true,
        collapsible: true,
        collapseMode: "mini",
        autoScroll: true,
        plugins: [
            new GeoExt.plugins.TreeNodeRadioButton({
                listeners: {
                    "radiochange": function(node) {
                        alert(OpenLayers.i18n("${layerName} is now the active layer.", {layerName: node.text}));
                    }
                }
            })/* plus */, {
                ptype: "gx_treenodecomponent"
            } /* */
        ],
        loader: new Ext.tree.TreeLoader({
            // applyLoader has to be set to false to not interfere with loaders
            // of nodes further down the tree hierarchy
            applyLoader: false,
            uiProviders: {
                "layernodeui": LayerNodeUI
            }
        }),
        root: {
            nodeType: "async",
            /* of niet async van begin *
            nodeType: "gx_layercontainer",
            /*loader: {
                baseAttrs: {
                    uiProvider: "layernodeui"//custom_ui"
                },
                createNode: function(attr) {
                    // add a WMS legend to each node created
                    attr.component = {
                        xtype: "gx_wmslegend",
                        layerRecord: mapPanel.layers.getByLayer(attr.layer),
                        showTitle: false,
                        // custom class for css positioning
                        // see tree-legend.html
                        cls: "legend"
                    }
                    return GeoExt.tree.LayerLoader.prototype.createNode.call(this, attr);
                },
                load: function() { // blijkbaar nodig indien niet async
                    console.log('load', arguments);
                }
            }, /* tot einde hier */
            // the children property of an Ext.tree.AsyncTreeNode is used to
            // provide an initial set of layer nodes. We use the treeConfig
            // from above, that we created with OpenLayers.Format.JSON.write.
            //children: Ext.decode(treeConfig)
            // Don't use the line above in your application. Instead, use
            children: treeConfig
        },
        listeners: {
            "radiochange": function(node){
                alert(OpenLayers.i18n("${layerName} is now the active layer.", {layerName: node.layer.name}));
            }
        },
        rootVisible: false,
        lines: false,
        bbar: [/*{
            contentEl: document.getElementById('show-btn'),
            text: OpenLayers.i18n("Ignite"),
            handler: function() {
                not_implemented();
                //treeConfigWin.show();
                //Ext.getCmp("treeconfig").setValue(treeConfig);
            }
        }, */{
            text: OpenLayers.i18n('Wfs Grid'),
            handler: function() {
                var map = mapPanel.map;
                var layers = map.getLayersByName('wfs_vector_landscapes');
                if (layers.length > 0) {
                    var wfsLayer = layers[0];
                } else {
                    // wfs kaartlaag toevoegen
                    var wfsLayer = new OpenLayers.Layer.Vector("wfs_vector_landscapes", {
                        //rendererOptions: {
                        //    zIndexing: true
                        displayInLayerSwitcher: false,
                        visibility: false,
                        styleMap: new OpenLayers.StyleMap({
                            'default': new OpenLayers.Style({
                                //display: 'none',
                                fillColor: '#aaaaaa',
                                fillOpacity: 0.2,
                                strokeColor: '#888888',
                                strokeOpacity: 0.4
                            }),
                            'select': new OpenLayers.Style({
                                fillColor: '#ff8800',
                                fillOpacity: 0.6,
                                strokeColor: '#ff0000',
                                strokeOpacity: 0.6,
                                strokeWidth: '3px',
                                display: 'visible'
                            })
                        })
                    });
                    // TODO: voor wfs laag alleen geselecteerde feature tonen!
                    mapPanel.map.addLayer(wfsLayer);
                }
                // create feature store, binding it to the vector layer
                var store = new GeoExt.data.FeatureStore({
                    layer: wfsLayer,
                    /*fields: [
                        {name: 'landscape_name', type: 'string'},
                        {name: 'started', type: 'date'}
                    ],*/
                    //recordType: TerrainFeatureRecord,
                    reader: new GeoExt.data.FeatureReader({}, TerrainFeatureRecord),
                    proxy: new GeoExt.data.ProtocolProxy({
                        protocol: new OpenLayers.Protocol.WFS({
                            url: "/geoserver/ows",
                            version: "1.1.0",
                            featureType: 'landscapes',
                            featureNS: 'model_wildfire',
                            srsName: 'EPSG:900913'//,
                            //outputFormat: 'application/json', // richting geoserver
                            //format: new OpenLayers.Format.GeoJSON() // ??
                        })
                    }),
                    autoLoad: true
                });
                console.log('Store', store);
                // create grid panel configured with feature store
                gridPanel = new Ext.grid.GridPanel({
                    title: "Feature Grid",
                    applyTo: "desc",
                    region: "east",
                    store: store,
                    width: 320,
                    height: 400,
                    columns: [{
                        header: "Naam",
                        width: 200,
                        sortable: true,
                        dataIndex: "landscape_name"
                    }, {
                        header: 'Begintijd',
                        width: 200,
                        sortable: true,
                        dataIndex: 'started'
                    }],
                    sm: new GeoExt.grid.FeatureSelectionModel({
                        autoPanMapOnSelection: false, // we zoomen er zelf naartoe
                        singleSelect: true
                    })
                });
                
                gridPanel.store.bind(wfsLayer);
                gridPanel.getSelectionModel().bind(wfsLayer);
                gridPanel.getSelectionModel().on('rowselect', function (obj, rowIndex, row){
                    console.log('rowselect', row.data.feature);
                    var geom = row.data.feature.geometry;
                    var center = geom.getCentroid();
                    mapPanel.map.panTo(new OpenLayers.LonLat(center.x, center.y));
                    
                    var datetime = new Date(row.data.feature.attributes['started']);
                    
                    // zetten van box
                    var bounds = geom.getBounds();
                    setBox(mapPanel.map, bounds);

                    // zetten van fuelmodel_name
                    Ext.getCmp('fuelmodel_name').setValue(row.data.feature.attributes['landscape_name']);
        
                    // zetten van model_date en model_time
                    setModelDateTime(datetime);
                    
                    // terrein laag (landscape_id) zetten? makkelijker bij testen
                    showTerrein(mapPanel.map, row.data.feature.attributes['terrein_id']);
                    
                    // tijd van neerslagradar
                    time = new Date(datetime.getTime() - datetime.getTime() % (5*60*1000)); // round to 5 minutes
                    console.log('tijd afgerond', time);
                    var map = row.data.feature.layer.map;
                    var layers = map.getLayersByName('KNMI Neerslagradar');
                    if (layers.length > 0) {
                        var layer = layers[0];
                        layer.mergeNewParams({time: time.toISOString()});
                    }
                }, gridPanel);

                // create a panel and add the map panel and grid panel
                // inside it
                /*mainPanel = new Ext.Panel({
                    renderTo: "mainpanel",
                    layout: "border",
                    height: 400,
                    width: 920,
                    items: [mapPanel, gridPanel]
                });*/
            }
        }]
    });
    
    var modelPanel = new Ext.Panel({
            title: OpenLayers.i18n("Simulation model"),
            contentEl: document.getElementById('model'),
            region: "east",
            bodyStyle: {"padding": "0px"},
            collapsible: true,
            collapseMode: "mini",
            autoScroll: true,
            split: true,
            width: 250,
            layout: 'auto',
            items: [
    new Ext.form.FormPanel({
	title: OpenLayers.i18n("Step 1 - Location"),
	//html: "Create conversion parameters and select area in the map by dragging a box around it. This will be the models boundary.",
	id: "farsitepanel1",
        collapsible: true,
	labelWidth: 40,
	labelAlign: 'left',
        monitorValid: true, // 
	layout: {
            type:  "form",
            align: "center"
	},
	defaults: {
            style: 'margin: 5px'
	},
	items: [
	/*	{
			xtype:'fieldset',
			id: 'fieldset_conversie',
			title: 'Conversie',
			defaults: {
				width: 150,
			},
			items: [
				actions["landuse2fuel"]
			]
		},{
			xtype: 'fieldset',
			id: 'fieldset_nieuwbestaand',
			title: 'Nieuw of bestaand',
			defaults: {
				width: 150,
			},
			items: [
				actions["newfuelmodel"],
				actions["existingfuelmodel"]
			]
		},*/
                {
                    xtype: 'fieldset',
                    title: OpenLayers.i18n('Select area'),
                    defaults: {
                        width: 'inherited'
                    },
                    items: [
                        {
                            xtype: "panel", //need this to put plugin-terrein in 
                            defaults: {width: 150, style: 'margin: 0px;'},
                            id: "terreinpanel1", 
                            border: false
                        }, {
                            xtype: 'numberfield',
                            id: 'terrein_id',
                            name: 'terrein_id',
                            fieldLabel: OpenLayers.i18n('Terrein ID'),
                            width: 40,
                            disabled: true,
                            hidden: true,
                            value: '0'
                        },
                        new Ext.Button({
                            text: OpenLayers.i18n("Select region"),
                            //xtype: 'button',
                            id: 'btn_select_region',
                            enableToggle: true,
                            tooltip: OpenLayers.i18n("Select region by dragging a rectangle in the map"),
                            handler: function(b, e) {
                                console.log('select region handler', b.pressed);
                                var map = mapPanel.map;
                                if (b.pressed) {
                                    var control = new OpenLayers.Control();
                                    b.control = control;
                                    OpenLayers.Util.extend(control, {
                                        draw: function () {
                                            // this Handler.Box will intercept the shift-mousedown
                                            // before Control.MouseDefault gets to see it
                                            this.box = new OpenLayers.Handler.Box( control,
                                                {"done": this.notice},
                                                //{"move": function(){ console.log('move')}}, // voor .Drag
                                                {keyMaskX: OpenLayers.Handler.MOD_SHIFT}
                                            );
                                            this.box.activate();
                                        },

                                        notice: function (bounds) {
                                            // lower-left
                                            var ll = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.bottom)); 
                                            // upper-right
                                            var ur = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.top)); 

                                            var bounds = new OpenLayers.Bounds(
                                                ll.lon.toFixed(0), // left
                                                ll.lat.toFixed(0), // bottom
                                                ur.lon.toFixed(0), // right
                                                ur.lat.toFixed(0) // top
                                            );
                                            var geom = bounds.toGeometry();
                                            var area = geom.getArea(); // or getGeodesicArea('EPSG:900913')
                                            if (area > Gmi.Settings.maxArea) {
                                                // TODO: in km2 zou leesbaarder zijn
                                                alert(OpenLayers.i18n('Area ${area} is larger than ${max} m2', {
                                                    max: Gmi.Settings.maxArea, 
                                                    area: area
                                                }));
                                                //return;
                                            }
                                            console.log('area', area);
                                            
                                            setBox(map, bounds);
                                        }
                                    });
                                    mapPanel.map.addControl(control);
                                } else {
                                    // disable regio kiezen, maar laat gebied zichtbaar
                                    b.control.box.deactivate();
                                    map.removeControl(b.control);
                                }
                            },
                            cls: 'g-actie-knop'
                        }),
                        new Ext.Button({
                            text: OpenLayers.i18n('Make subset'),
                            cls: 'g-actie-knop',
                            handler: function(b, e) {
                                // kaart variabele beschikbaar maken
                                var map = mapPanel.map;
                                // laag achterhalen
                                var layers = map.getLayersByName('_boxes_');
                                if (layers.length > 0) {
                                    // rechthoek achterhalen
                                    //var bounds = layers[0].getDataExtent(); // gaat fout omdat deze functie marker.lonlat gebruikt en deze hier null
                                    var bounds = layers[0].markers.length > 0 ? layers[0].markers[0].bounds : null;
                                    if (! bounds) {
                                        alert(OpenLayers.i18n('Select region first'));
                                    } else {
                                        // select region knop deactiveren
                                        var btn_select_region = Ext.getCmp('btn_select_region');
                                        if (btn_select_region.pressed) {
                                            btn_select_region.control.box.deactivate();
                                            map.removeControl(btn_select_region.control);
                                            btn_select_region.doToggle();
                                        }
                                        Gmi.Session.box = bounds;

                                        // makesubset process aanroepen
                                        startProgress(OpenLayers.i18n('makesubset'));
                                        Ext.Ajax.request({
                                            url: '/geoserver/ows?', 
                                            params: {
                                                service: 'WPS',
                                                version: '1.1.0',
                                                request: 'execute',
                                                identifier: 'py:wildfire_makesubset',
                                                datainputs: combineParams({
                                                    userid: Gmi.Session.userid,
                                                    name: 'test',
                                                    left: bounds.left,
                                                    lower: bounds.bottom,
                                                    right: bounds.right,
                                                    upper: bounds.top
                                                }, ';'),
                                                RawDataOutput: 'string',
                                                mimeType: 'application/json'
                                            },
                                            extraParams: {
                                                count: 0
                                            },
                                            on_finished: function(out_params) {
                                                // toon terrein laag
                                                showTerrein(map, out_params.runid);
                                           },
                                           success: wpsSuccessCallback,
                                           failure: wpsFailureCallback
                                        });
                                    }
                                }
                            }
                        })
                    ]
                }, { /*
			xtype: 'fieldset',
			title: 'Bewerk terrein',
			defaults: {
				width: 150,
			},
			items: [
				{
					xtype: "panel", //need this to put edit-tool in 
					defaults: {width: 150, style: 'margin: 0px;'},
					id: "terreineditpanel1",
                            border: false
                        }
                        ]
                }, { */
                        xtype: 'fieldset',
                        title: OpenLayers.i18n('Save'),
                        defaults: {
                            width: 'inherited'
                        },
                        items: [
                            {
                                fieldLabel: OpenLayers.i18n('Name'),
                                xtype: 'textfield',
                                id: 'fuelmodel_name',
                                name: 'fuelmodel_name',
                                tooltip: OpenLayers.i18n('Name of terrain'),
                                width: 100,
                                align: 'right',
                                //allowBlank: false, // must be filled in!
                                value: OpenLayers.i18n('untitled')
                                //style: 'padding: 0px;'
                            },
                            //actions["makeLcp"]
                            new Ext.Button({
                                text: OpenLayers.i18n("Edit"),
                                formBind: true, // If form validation fails disable the button
                                //xtype: 'button',
                                tooltip: OpenLayers.i18n("Edit the land use"),
                                handler: function() {
                                    not_implemented();
                                    /*
                                    var terreinid = Gmi.Session.terreinid; //Ext.getCmp("terrein_id").getValue();
                                    var landscapename = Ext.getCmp("fuelmodel_name").getValue();
                                    if (! terreinid) {
                                        alert(OpenLayers.i18n('Landscape file cannot be prepared yet.'));
                                    } else {
                                        // maak landschap ('lcp') voor model aan
                                        startProgress(OpenLayers.i18n('makelcp'));
                                        Ext.Ajax.request({
                                            url: '/geoserver/ows?', //service=WPS&request=execute&version=1.0.0&identifier=py:wildfire_makelcp&datainputs=userid=' + userid + ';terreinid=' + terreinid + ';landscapename=' + landscapename + ';&RawDataOutput=string&mimeType=application/json',
                                            params: {
                                                service: 'WPS',
                                                version: '1.1.0',
                                                request: 'execute',
                                                identifier: 'py:wildfire_makelcp',
                                                datainputs: combineParams({
                                                    userid: Gmi.Session.userid,
                                                    terreinid: terreinid,
                                                    landscapename: landscapename
                                                }, ';'),
                                                RawDataOutput: 'string',
                                                mimeType: 'application/json'
                                            },
                                            extraParams: {
                                                count: 0
                                            },
                                            on_finished: function(out_params) {
                                                // bewaar id van fuelmodel
                                                Gmi.Session.fuelid = out_params.runid;
                                            },
                                            success: wpsSuccessCallback,
                                            failure: wpsFailureCallback
                                        });
                                    }
                                    */
                                },
                                cls: 'g-actie-knop'
                            }),
                            new Ext.Button({
                                text: OpenLayers.i18n("Save"),
                                formBind: true, // If form validation fails disable the button
                                //xtype: 'button',
                                tooltip: OpenLayers.i18n("Create landscape file on the base of currently selected region"),
                                handler: function() {
                                    var terreinid = Gmi.Session.terreinid; //Ext.getCmp("terrein_id").getValue();
                                    var landscapename = Ext.getCmp("fuelmodel_name").getValue();
                                    if (! terreinid) {
                                        alert(OpenLayers.i18n('Landscape file cannot be prepared yet.'));
                                    } else {
                                        // maak landschap ('lcp') voor model aan
                                        startProgress(OpenLayers.i18n('makelcp'));
                                        Ext.Ajax.request({
                                            url: '/geoserver/ows?', //service=WPS&request=execute&version=1.0.0&identifier=py:wildfire_makelcp&datainputs=userid=' + userid + ';terreinid=' + terreinid + ';landscapename=' + landscapename + ';&RawDataOutput=string&mimeType=application/json',
                                            params: {
                                                service: 'WPS',
                                                version: '1.1.0',
                                                request: 'execute',
                                                identifier: 'py:wildfire_makelcp',
                                                datainputs: combineParams({
                                                    userid: Gmi.Session.userid,
                                                    terreinid: terreinid,
                                                    landscapename: landscapename
                                                }, ';'),
                                                RawDataOutput: 'string',
                                                mimeType: 'application/json'
                                            },
                                            extraParams: {
                                                count: 0
                                            },
                                            on_finished: function(out_params) {
                                                // bewaar id van fuelmodel
                                                Gmi.Session.fuelid = out_params.runid;
                                            },
                                            success: wpsSuccessCallback,
                                            failure: wpsFailureCallback
                                        });
                                    }
                                },
                                cls: 'g-actie-knop'
                            })
                        ]
                    }
                    ]
                }),
                new Ext.form.FormPanel({
                    title: 'Step 2 - Inputs',
                    collapsible: true,
                    defaults: {
                        style: 'margin: 5px'
                    },
                    items: [
                        {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Subset'),
                            defaults: {
                                width: 'inherited'
                            },
                            collapsible: true,
                            collapsed: true,
                            items: []
                        },
                        {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Date & time'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [
                                {
                                    xtype: 'datefield',
                                    id: 'model_date',
                                    fieldLabel: OpenLayers.i18n('Date'),
                                    anchor: '100%',
                                    format: Gmi.Settings.dateFormat,
                                    forceSelection: true, editable: false
                                },
                                {
                                    xtype: 'timefield',
                                    id: 'model_time',
                                    fieldLabel: OpenLayers.i18n("Time"),
                                    anchor: '100%',
                                    forceSelection: true, editable: false,
                                    //minValue   : '09:00',
                                    //maxValue   : '18:00',
                                    increment: Gmi.Settings.tijd_afronding_minuten,
                                    format: 'H:i'
                                    //,value: '14:00'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Weather data'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [
                                new Ext.form.ComboBox({
                                    id: 'weatherstation',
                                    fieldLabel: 'Weather station',
                                    name: 'station',
                                    typeAhead: true,
                                    triggerAction: 'all',
                                    lazyRender: true,
                                    anchor: '100%',
                                    align: 'right',
                                    mode: 'local',
                                    value: 275, // default: Deelen
                                    forceSelection: true, editable: false,
                                    store: new Ext.data.ArrayStore({
                                        id: 0,
                                        fields: [
                                            'id',
                                            'naam'
                                        ],
                                        data: [[0, 'Eigen gegevens'], [260, 'De Bilt'], [275, 'Deelen'], [283, 'Hupsel'], [375, 'Volkel']]
                                    }),
                                    valueField: 'id',
                                    displayField: 'naam'
                                }),
                                new Ext.Button({
                                    text: OpenLayers.i18n('Show weather data'),
                                    handler: showClimateData,
                                    cls: 'g-actie-knop'
                                })
                            ]
                        }
                    ]
                }),
                new Ext.form.FormPanel({
                    title: 'Step 3 - Run model',
                    collapsible: true,
                    defaults: {
                        style: 'margin: 5px'
                    },
                    items: [
                        {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Fire location'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [
                                new Ext.Button({
                                    text: OpenLayers.i18n('Draw fire line'),
                                    handler: drawFireLine,
                                    cls: 'g-actie-knop'
                                })
                            ]
                        }, {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Execution'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [{
                                    fieldLabel: OpenLayers.i18n('Name'),
                                    xtype: 'textfield',
                                    id: 'fire_name',
                                    name: 'fire_name',
                                    tooltip: OpenLayers.i18n('Name of fire'),
                                    anchor: '100%',
                                    width: 100,
                                    align: 'right',
                                    //allowBlank: false, // must be filled in!
                                    value: OpenLayers.i18n('untitled')
                                    //style: 'padding: 0px;'
                                },
                                new Ext.Button({
                                    text: OpenLayers.i18n('Start run'),
                                    handler: startModelRun,
                                    cls: 'g-actie-knop'
                                })
                            ]
                        }
                    ]
                }),
                new Ext.form.FormPanel({
                    title: 'Step 4 - Outputs',
                    collapsible: true,
                    defaults: {
                        style: 'margin: 5px'
                    },
                    html: '&lt;todo&gt;',
                    cls: 'empty'
                })]
            });
    var viewportItems = [mapPanel, tree, modelPanel];
    
    new Ext.Viewport({
        layout: "fit",
        hideBorders: true,
        items: {
            layout: "border",
            deferredRender: false,
            items: viewportItems
        }
    });
    
    // toevoegen van stappen aan rechterkant (simPanel)
 
    var button = Ext.get('show-btn');

    button.on('click', function() {
        // create the window on the first click and reuse on subsequent clicks
        if (!win) {
            win = new Ext.Window({
                applyTo: 'hello-win',
                title: 'Simulatie', // of hier of in div met class x-window-header
                layout: 'fit',
                width: 500,
                height: 300,
                closeAction: 'hide', // NB anders slechts 1x bruikbaar
                plain: true,
                modal: true,
                items: new Ext.TabPanel({
                    //applyTo: 'hello-tabs',
                    renderTo: Ext.get('hello-win'),
                    //autoTabs: true,
                    activeTab: 0,
                    deferredRender: false,
                    border: false,
                    items: [{
                            xtype: 'form',
                            title: 'Gebied', // 1ste tab
                            defaults: {
                                width: 150
                            },
                            items: [
                                {
                                    xtype: 'textfield',
                                    fieldLabel: 'Naam gebied'
                                },
                                {
                                    xtype: 'button',
                                    fieldLabel: 'Selecteer gebied',
                                    handler: not_implemented
                                },
                                {
                                    xtype: 'combo',
                                    fieldLabel: 'Choose version',
                                    store: ['3.0', '2.0', '1.0']
                                },
                                {
                                    xtype: 'button',
                                    fieldLabel: 'Opslaan'
                                }
                            ]
                        }, {
                            xtype: 'form',
                            title: 'Weersomstandigheden', // 2de tab
                            defaults: {
                                width: 150
                            },
                            items: [
                                {
                                    xtype: 'textfield',
                                    fieldLabel: 'Name'
                                },
                                {
                                    xtype: 'checkbox',
                                    fieldLabel: 'Do you love Ext?'
                                },
                                {
                                    xtype: 'combo',
                                    fieldLabel: 'Choose version',
                                    store: ['3.0', '2.0', '1.0']
                                }
                            ]
                        }, {
                            xtype: 'form',
                            title: 'Tijd', // 3de tab
                            items: [
                                {
                                    xtype: 'datefield',
                                    fieldLabel: 'Begintijd',
                                    width: 'auto',
                                    format: Gmi.Settings.dateFormat
                                }
                                , {
                                    xtype: 'datefield',
                                    fieldLabel: 'Eindtijd',
                                    width: 'auto',
                                    format: Gmi.Settings.dateFormat
                                }
                            ]
                        }
                    ]
                }),
                buttons: [{
                        text: 'Help',
                        handler: not_implemented
                    }, {
                        text: 'Annuleren',
                        disabled: true
                    }, {
                        text: 'Start',
                        handler: not_implemented,
                        handlerX: function() {
                            win.hide();
                        }
                    }]
            });
        }
        win.show(this);
    });


    // tijd task
    var prev_minutes = -1;
    var task = {
        run: function(){
            var today = new Date();
            var h=today.getHours();
            var m=today.getMinutes();
            var m_floor = Math.floor(m/Gmi.Settings.tijd_afronding_minuten)*Gmi.Settings.tijd_afronding_minuten;
            if (m_floor !== prev_minutes) {
                // set date (todo: alleen indien veranderd)
                Ext.getCmp('model_date').setValue(today);
                // tijd in formulier aanpassen
                console.log(today.toLocaleTimeString());
                Ext.getCmp('model_time').setValue( zpad(h, 2) + ':' + zpad(m_floor, 2) );
                prev_minutes = m_floor;
            }
        },
        interval: 15000 // every 15 seconds
    };
    var runner = new Ext.util.TaskRunner();
    runner.start(task);
});

function zpad(i, width) {
    var s = Math.round(i) + '';
    while (s.length < width) {
        s = '0' + s;
    }
    return s;
};

function setModelDateTime(datetime) {
    Ext.getCmp('model_date').setValue(datetime);
    var h = datetime.getHours();
    var m = datetime.getMinutes();
    var time = zpad(h, 2) + zpad(m, 2); // ':' niet nodig?
    Ext.getCmp('model_time').setValue(time);
};

function getModelDateTime() {
    var model_date = Ext.getCmp('model_date').getValue();
    var model_time = Ext.getCmp('model_time').getValue();
    model_date.setHours(model_time.split(':')[0]);
    model_date.setMinutes(model_time.split(':')[1]);
    return model_date;
};

function setBox(map, bounds) {
    var layers = map.getLayersByName('_boxes_');
    if (layers.length > 0) {
        // layer leegmaken
        layers[0].clearMarkers();
        // nieuwe toevoegen
        var box = new OpenLayers.Marker.Box(bounds);
        layers[0].addMarker(box);
    }
};

function showTerrein(map, terrein_id) {
    // bewaar runid als terreinid
    Gmi.Session.terreinid = terrein_id;
    // verwijdere oude terreinen
    var layers = map.getLayersByName('Terrein');
    /*for (var i = layers.length - 1; i >= 0; i--) {
        map.removeLayer(layers[i]);
    }*/
    // voeg nieuwe terrein toe
    var name = 'model_wildfire:terrein_' + terrein_id;
    if (layers.length > 0) {
        layers[0].mergeNewParams({
            layers: name
        });
    } else {
        var layer = new OpenLayers.Layer.WMS('Terrein', 
        'http://model.geodan.nl/geoserver/wms?', {
            layers: name,
            transparent: true,
            format: 'image/png'
        }, {
            isBaseLayer: false,
            opacity: 0.6
        });
        map.addLayer(layer);
   }
};

function weatherStoreAsString() {
    weatherStore.sort('date', 'asc');
    var weatherData = weatherStore.getRange();
                // weather: (month,day,precip,hour1,hour2,tlo,thi,hhi,hlo,elv), etc (6 dagen)
                //weatherstring: '(05,12,00,0500,1500,15,32,60,15,0000),(05,13,00,0500,1500,15,32,50,10,0000),(05,14,00,0500,1500,15,32,50,11,0000),(05,15,00,0500,1500,15,32,60,10,0000),(05,16,00,0500,1500,15,32,50,10,0000),(05,17,00,0500,1500,15,32,50,10,0000)', 

    var weatherString = '';
    //var model_start = getModelDateTime();
    var lastDate;
    var lastDataValues;
    var month, day, rn, am, pm, tlo, thi, hhi, hlo, elv;
    for (var i = 0; i < weatherData.length; i++) {
        weatherData[i].data.hour1 = 500;
        weatherData[i].data.hour2 = 1500; // eis: hour1 < hour2
        weatherData[i].data.precipitation = 0;
        
        lastDate = weatherData[i].data.date;
        
        month = zpad(lastDate.getMonth() + 1, 2);
        day = zpad(lastDate.getDate(), 2);
        rn = zpad(weatherData[i].data.precipitation, 2);
        am = zpad(weatherData[i].data.hour1, 4);
        pm = zpad(weatherData[i].data.hour2, 4);
        tlo = zpad(weatherData[i].data.tmin, 2); // todo: afronden
        thi = zpad(weatherData[i].data.tmax, 2);
        hhi = zpad(Math.min(99, weatherData[i].data.hmax), 2); // max 99 voor farsite
        hlo = zpad(Math.min(99, weatherData[i].data.hmin), 2); // max 99 voor farsite
        elv = '0000';
        var lastDataValues = rn + ',' 
            + am + ',' + pm +',' + tlo +',' + thi +',' + hhi +',' + hlo +',' + elv;
        weatherString += '(' + month + ',' + day  + ',' + lastDataValues +')';
        if (i < weatherData.length - 1) { 
            weatherString += ',';
        }
    }
    // EIS: elke dag data; ook data nodig voor model tijd + 6
    var modelDate = getModelDateTime();
    while (modelDate > lastDate) {
        // voor elke dag gegevens toevoegen als laatste dataString
        lastDate.setDate(lastDate.getDate() + 1);
        month = zpad(lastDate.getMonth() + 1, 2);
        day = zpad(lastDate.getDate(), 2);
        weatherString += ',(' + month + ',' + day + ',' + lastDataValues + ')'; 
    }
    console.log('weatherString', weatherString);
    return weatherString;
};

function windStoreAsString() {
                // wind: (month,day,hour,speed,dir,cl), etc (6 uren)
                //windstring: '(5,16,1508,00,180,10),(5,16,1608,00,180,10),(5,16,1708,00,180,10),(5,16,1808,00,180,10),(5,16,1908,00,180,10),(5,17,2008,00,180,10)', 
    windStore.sort('date', 'asc');
    var windData = windStore.getRange();

    var windString = '' ;
    for (var i = 0; i < windData.length; i++) {
        month = windData[i].data.date.getMonth() + 1;
        day = windData[i].data.date.getDate();
        hour = windData[i].data.time;
        hour = hour.replace(':', '');
        hour = hour.substr(0, 4);
        speed = zpad(windData[i].data.speed * 3.6, 2); // van m/s naar km/h
        dir = zpad(windData[i].data.direction, 3);
        cl = zpad(windData[i].data.cloudiness, 2);
        windString += '(' + month + ',' + day  + ',' + hour + ',' + speed + ',' + dir + ',' + cl +')';
        if (i < windData.length - 1) {
            windString += ',';
        }
    }
    console.log('windString', windString);
    return windString;
};

function drawFireLine() {
    // drawfeature knop activeren
    var map = mapPanel.map;
    //var controls = map.getControlsByClass(OpenLayers.Control.DrawFeature);
    var controls = map.getControlsByClass('OpenLayers.Control.DrawFeature');
    if (controls.length > 0) {
        controls[0].activate();
    }
};

function startModelRun() {
    
    var map = mapPanel.map;
    if (! map) {
        alert('Interne fout: map is undefined.'); // internal
        return;
    }
    
    // TODO: vuurfront uitlezen ipv middelpunt van box
    if (! Gmi.Session.box) {
        alert('Box/Subset is undefined.'); // [Make subset]
        return;
    }
    
    var t = map.getLayersByName('Wildfire lines');
    if (t.length === 0) {
        alert('Interne fout: geen vectorlaag voor vuurlijnen');
        return;
    }
    var wildfire_layer = t[0];
    if (wildfire_layer.features.length === 0) {
        alert('Geen vuurfront getekend');
        return;
    }
    var geom = wildfire_layer.features[0].geometry.clone();
    for (var i = 0; i < geom.components.length; i++) {
        geom.components[i].transform('EPSG:900913', 'EPSG:28992');
    }
    var wkt = geom.toString(); // rd geometry
    console.log('fire line', wkt);
    //return;
/*    
    var rdbox = Gmi.Session.box.clone().transform('EPSG:900913', 'EPSG:28992');
    var center = rdbox.getCenterLonLat();
    //var p = new OpenLayers.Geometry.Point(center.lon, center.lat);
    var geom = new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(center.lon - 1, center.lat - 1), new OpenLayers.Geometry.Point(center.lon + 1, center.lat + 1)]);
    var wkt = geom.toString();
    //var wkt = 'LINESTRING(' + center.lon +' ' + center.lat + ', ' + center.lon +' ' + center.lat + ')';
*/
    if (! Gmi.Session.fuelid) {
        alert('Fuel model is undefined.'); // [Save]
        return;
    }
    
    // weather/wind data

    // tijd
    var hhmm = Ext.getCmp('model_time').value.replace(':', '');
    if (! hhmm) {
        alert('Tijd onbekend');
        return;
    }
    var model_datetime = getModelDateTime();
    
    // startRun process aanroepen
    // Let op: 
    startProgress(OpenLayers.i18n('startRun'));
    var fire_name = Ext.getCmp('fire_name').getValue();
    Ext.Ajax.request({
        url: '/geoserver/ows?', 
        params: {
            service: 'WPS',
            version: '1.1.0',
            request: 'execute',
            identifier: 'py:wildfire_startRun',
            datainputs: combineParams({
                userid: Gmi.Session.userid,
                name: fire_name, // naam van brand
                fuelmodel: Gmi.Session.fuelid, // runid van fuelmodel (resultaat van makelcp)
                geom: wkt, // wkt LINESTRING(x y, ...) RD projectie
                // wind: (month,day,hour,speed,dir,cl), etc (6 uren)
                windstring: windStoreAsString(),
                // windstring=(5,16,1508,00,180,10),(5,16,1608,00,180,10),(5,16,1708,00,180,10),(5,16,1808,00,180,10),(5,16,1908,00,180,10),(5,16,2008,00,180,10);
                // weather: (month,day,precip,hour1,hour2,tlo,thi,hhi,hlo,elv), etc (6 dagen)
                weatherstring: weatherStoreAsString(),
                // weatherstring=(05,12,00,0500,1500,15,32,60,15,0000),(05,13,00,0500,1500,15,32,50,10,0000),(05,14,00,0500,1500,15,32,50,11,0000),(05,15,00,0500,1500,15,32,60,10,0000),(05,16,00,0500,1500,15,32,50,10,0000),(05,17,00,0500,1500,15,32,50,10,0000);
                // startmonth=05;startday=16;starthour=1508;
                startmonth: zpad(model_datetime.getMonth() + 1, 2), // 0-padded; month geeft 0..11
                startday: zpad(model_datetime.getDate(), 2), // 0-padded, laatste dag van weather/wind-string
                starthour: hhmm // hhmm
            }, ';'),
            RawDataOutput: 'string',
            mimeType: 'application/json'
        },
        extraParams: {
            count: 0
        },
        on_finished: function(out_params) {
            // toevoegen van kaartlaag met naam als model_wildfire:result_1769
            // bewaar runid als terreinid
            Gmi.Session.fireid = out_params.runid;
            // verwijdere oude terreinen
            var layers = map.getLayersByName('Brandverspreiding');
            var name = 'model_wildfire:result_' + out_params.runid;
            if (layers.length > 0) {
                // pas huidige resultaat aan
                layers[0].mergeNewParams({
                    layers: name
                });
            } else {
                // voeg nieuwe resultaat toe
                var layer = new OpenLayers.Layer.WMS('Brandverspreiding', 
                'http://model.geodan.nl/geoserver/wms?', {
                    layers: name,
                    transparent: true,
                    format: 'image/png'
                }, {
                    isBaseLayer: false,
                    opacity: 0.6
                });
                map.addLayer(layer);
           }
       },
       success: wpsSuccessCallback,
       failure: wpsFailureCallback
    });
};

var wpsFailureCallback = function(response, options) {
    stopProgress();
    alert(OpenLayers.i18n('WPS failure'));
};

var wpsSuccessCallback = function(response, options) {
    console.log('wpsSuccessCallback response', response, options);
    
    var params = JSON.parse(response.responseText);
    var activerunid = params.runid;
    // statussen: scheduled, running, error, finished
    if (params.status === 'scheduled') {
        var runner = new Ext.util.TaskRunner();
        var count = options.extraParams.count + 1;
        // bij een 'scheduled' process moet voortgang gecontroleerd worden
        var task = {
            interval: 1000, // 1 seconde
            run: function() {
                count = count + 1;
                //Ext.fly('clock').update(new Date().format('g:i:s A'));
                Ext.Ajax.request({
                    url:'/geoserver/ows?',//service=WPS&request=execute&version=1.0.0&identifier=py:checkModelStatus&datainputs=runid='+activerunid+';&RawDataOutput=string=mimeType="application/json"',
                    params: {
                        service: 'WPS',
                        version: '1.1.0',
                        request: 'execute',
                        identifier: 'py:checkModelStatus',
                        RawDataOutput: 'string',
                        mimeType: 'application/json',
                        datainputs: combineParams({
                            runid: activerunid
                        }, ';')
                    },
                    extraParams: {
                        count: count
                    },
                    success: function(check_response, c_options) {
                        var params = {};
                        //console.log(check_response);
                        try {
                            params = JSON.parse(check_response.responseText);
                        } catch (err) {
                            params.status = 'error';
                            params.lastMessage = check_response.responseText;
                        }
                        if (params.status === 'error') {
                            runner.stop(task); 
                            stopProgress();
                            console.log('wfs taak ging fout', params);
                            alert(OpenLayers.i18n('WFS process error: ${msg}', {msg: params.lastMessage}));
                        } else if (params.percentage == 100) {
                            runner.stop(task); 
                            stopProgress();
                            console.log('wfs taak is klaar', params);
                            if (options.on_finished) {
                                options.on_finished(params);
                            } else {
                                alert(OpenLayers.i18n('Process is ready; results are ignored'));
                            }
                        } else if (c_options.extraParams.count >= 120) {
                            runner.stop(task);
                            stopProgress();
                            console.log('wfs taak duurde te lang', params);
                            alert(OpenLayers.i18n('Process takes too long; aborted'));
                        } else {
                            updateProgress(c_options.extraParams.count, params.percentage);
                            console.log('voortgang', c_options.extraParams.count, params);
                        }
                    },
                    failure: function() {
                        stopProgress();
                        runner.stop(task);
                        console.log('WFS process failure', arguments);
                        alert('WFS process failure');
                    }
                });
            }
        };
        runner.start(task);
    } else if (params.status === 'finished') {
        stopProgress();
        // direct resultaat, dus on_finished
        if (options.on_finished) {
            options.on_finished(params);
        }
    } else if (params.status === 'error') {
        // fout
        stopProgress();
        alert(OpenLayers.i18n('WFS process error: ${msg}', {msg: params.lastMessage}));
    } else {
        stopProgress();
        // onbekende veld
        alert(OpenLayers.i18n('Internal error: unknown return status'));
    }
};

function startProgress(message) {
    Ext.MessageBox.show({
        title: OpenLayers.i18n('Please wait'),
        msg: message,
        progressText: OpenLayers.i18n('Initializing...'),
        width: 300,
        progress: true,
        closable: false
        //,animEl: 'mb6'
    });
};

function updateProgress(i, perc) {
    Ext.MessageBox.updateProgress(i, OpenLayers.i18n('${perc}% completed',{perc: Math.round(perc)}));
};

function stopProgress() {
    Ext.MessageBox.hide();
};

function combineParams(o, sep) {
    if (!sep) {
        sep = ';';
    }
    var s = '';
    for (var key in o) {
        s += key + '=' + o[key] + sep;
    }
    return s;
}

//-->
        </script>
        <div id="online-or-offline">?</div>
        <input type="button" id="show-btn" value="Open dialoog" />
        <br />
        <br />
        <div id="hello-win" class="x-hidden">
        </div>
        <div id="wfsgrid">WFS grid</div>

        <div class="x-window-header">Simulatie</div>
        <div id="hello-tabs">
            <!-- Auto create tab 1 -->
            <div class="x-tab" title="Hello World 1">
                <p>Hello...</p>
            </div>
            <!-- Auto create tab 2 -->
            <div class="x-tab" title="Hello World 2">
                <p>... World!</p>
            </div>
        </div>
        
        <div id="model">
            <!--p class="i18n">Room for a model panel.</p-->
            <div id="desc"></div>
        </div>
    </body>
</html>
