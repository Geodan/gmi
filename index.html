<!DOCTYPE html>
<html><!-- nomanifest="app.manifest" -->
    <head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
    <meta charset="UTF-8">
        <title class="i18n">Wildfire modeling</title>
        <!-- Ext resources -->
        <link rel="stylesheet" type="text/css"
              href="./externals/ext-3.4.1/resources/css/ext-all.css" />
        <link rel="stylesheet" type="text/css"
              href="./externals/ext-3.4.1/resources/css/xtheme-gray.css" />
        <script type="text/javascript" src="externals/ext-3.4.1/adapter/ext/ext-base-debug.js"></script>
        <!--
        <script type="text/javascript" src="externals/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="externals/ext-3.4.1/adapter/jquery/ext-jquery-adapter-debug.js"></script>
        -->
        <script type="text/javascript" src="externals/ext-3.4.1/ext-all-debug.js"></script>
        
	<!-- Proj resources -->
	<script type="text/javascript" src="externals/proj4js_combined.js"></script>
        
        <script type="text/javascript" src="externals/OpenLayers-2.12/OpenLayers.js"></script>
        <script type="text/javascript" src="externals/OpenLayers-2.12/lib/OpenLayers/Lang/nl.js"></script>
        <!-- GeoExt -->
        <script src="externals/GeoExt/lib/GeoExt.js" type="text/javascript"></script>
        <script src="externals/GeoExt/lib/GeoExt/locale/GeoExt-fr.js" type="text/javascript"></script>
        <script src="externals/GeoExt/lib/GeoExt/locale/GeoExt-nl.js" type="text/javascript"></script>
	<script type="text/javascript">
        /** Create viewer instance, this is the core of the app **/
        Proj4js.defs["EPSG:28992"] = "+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079  +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.417,50.3319,465.552,-0.398957,0.343988,-1.8774,4.0725 +units=m +no_defs";
        Proj4js.defs["EPSG:32631"] = "+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"; 
        </script>
        <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/geoext-all.css" />
        <link rel="stylesheet" type="text/css" href="css/natuurbrandmodel.css" />
    </head>
    <body>
        <script>
//<!--
// settings
Ext.namespace('Gmi.Settings', 'Gmi.Session', 'Gmi.Services', 'Gmi.Services.WPS');

Gmi.Settings.openLayers_imgPath = 'img/';
Gmi.Settings.openLayers_proxyHost = 'proxy.php?url=';
Gmi.Settings.maxArea = 10000 * 10000; // m2; 10 bij 10 km, 100 km2

Gmi.Session.userid = '0';

OpenLayers.imgPath = Gmi.Settings.openLayers_imgPath;
OpenLayers.ProxyHost = Gmi.Settings.openLayers_proxyHost;

// Models
Gmi.Services.WPS = {
    url: '/geoserver/ows?',
    
    request: function(options) {
        var config = Ext.extend({
            url: '/geoserver/ows?',
            params: {
                service: 'WPS',
                version: '1.1.0',
                request: 'execute',
                identifier: 'py:wildfire_makesubset',
                datainputs: combineParams({
                    userid: Gmi.Session.userid,
                    name: 'test',
                    left: bounds.left,
                    lower: bounds.bottom,
                    right: bounds.right,
                    upper: bounds.top
                }, ';'),
                RawDataOutput: 'string',
                mimeType: 'application/json'
            },
        }, options);
        Ext.Ajax.Request(config);
    }
};

// klimaatgegevens

var WeatherRecord = new Ext.data.Record.create([
    { name: 'station', type: 'int'},
    { name: 'date', type: 'date'},
    { name: 'tmin', type: 'float'},
    { name: 'tmax', type: 'float'},
    { name: 'hmin', type: 'float'},
    { name: 'hmax', type: 'float'}
]);

var TerrainFeatureRecord = new GeoExt.data.FeatureRecord.create([
    {name: 'landscape_name', type: 'string'},
    {name: 'started', type: 'date'}
]);

function weatherTextToRecords(end_ymd, data) {
    var records = [];

    // splits data in regels en verwijder commentaar en lege regels
    // datum is oplopend gesorteerd
    var lines = data.split('\n').filter(function(line){return line.length > 0 && !line.startsWith('#');});
    var last_ymd = '00000000';
    for (var i = 0; i < lines.length; i++) {
        var tokens = lines[i].split(/[,\s]+/g).filter(function(token){return token.length > 0;});
        console.log(tokens);

        last_ymd = tokens[1];
        records.push(new WeatherRecord({
            station: tokens[0],
            date: Date.parseDate(tokens[1], 'Ymd'), // convert yyyymmdd to date?
            tmin: parseFloat(tokens[2])/10,
            tmax: parseFloat(tokens[4])/10,
            hmin: parseFloat(tokens[6]),
            hmax: parseFloat(tokens[8])
        }));
    }
    if (records.length > 0 && end_ymd !== last_ymd) {
        // voeg laatste record toe met zelfde gegevens behalve datum
        records.push(new WeatherRecord(OpenLayers.Util.applyDefaults({date: Date.parseDate(end_ymd, 'Ymd')}, records[records.length-1].data)));
    }
    // dag van vandaag toevoegen (indien niet aanwezig)
    return records;
}

var climateStations = [];

function getClimateData(station) {
    //var today = Ext.util.Format.date(new Date(), 'Ymd');
    var today = new Date();
    var end_ymd = today.dateFormat('Ymd');
    var start = new Date(today);
    start.setDate(today.getDate() - 5);
    var start_ymd = start.dateFormat('Ymd');
    // NB: proxy nodig voor direct ophalen
    //Ext.Ajax.request({
    var vars = 'TN:TNH:TX:TXH:UN:UNH:UX:UXH'; // Minimum temperatuur, uur, maximum temp, uur, Minimale relatieve vochtigheid, uur, max rel vocht, uur
    var request = OpenLayers.Request.GET({
        url: 'http://www.knmi.nl/klimatologie/daggegevens/getdata_dag.cgi',
        async: false,
        params: {
            stns: station,
            vars: 'TN:TNH:TX:TXH:UN:UNH:UX:UXH', // station,datum, ...
            start: start_ymd,
            end: end_ymd
        },
        success: function(response) {
            var data = response.responseText; // bij OpenLayers request
        }
    });
    var text = request.responseText;
    return weatherTextToRecords(end_ymd, text);
};

var weatherColumnModel = new Ext.grid.ColumnModel({
    defaults: {
        sortable: true, // columns are not sortable by default
        width: 100,
        align: 'right',
        format: '000.0',
        xtype: 'numbercolumn'
    },
    columns: [
    {
        header: 'Station',
        dataIndex: 'station',
        hidden: true,
        format: '000'
        /*{
        editable: true,
        editor: new Ext.form.DateField({  // rules about editing
                format: 'Y-m-d',
                allowBlank: false,
                maxLength: 10
        })*/
    }, {
        header: 'Date',
        dataIndex: 'date',
        width: 100,
        align: 'right',
        format: 'Y-m-d',
        xtype: 'datecolumn'
    }, {
        header: 'Tmin',
        format: '00.0',
        dataIndex: 'tmin'
    }, {
        header: 'Tmax',
        format: '00.0',
        dataIndex: 'tmax'
    }, {
        header: 'RVmin',
        format: '000',
        dataIndex: 'hmin'
    }, {
        header: 'RVmax',
        format: '000',
        dataIndex: 'hmax'
    }]
});

var weatherStore = new Ext.data.Store({
    id: 'weatherStore',
    autoSave: false,
    recordType: WeatherRecord,
    sortInfo: { field: "date", direction: "DESC" },
    reader: {
        readRecords: function() {
            var station = Ext.getCmp('weatherstation'); // naam zit in .lastSelectionText
            var records = getClimateData(station.value);
            if (records) {
                weatherGrid.setTitle(OpenLayers.i18n('Weather characteristics - ${name}', {name: station.lastSelectionText}));
            }
            return {
                records: records
            };
        }
    }
});

var weatherGrid = new Ext.grid.GridPanel({
    id: 'weathergrid',
    title: OpenLayers.i18n('Weather characteristics'),
    store: weatherStore,
    cm: weatherColumnModel
});

var weathersettingsWindow = new Ext.Window({
    id: 'weathersettingsWindow',
    title: OpenLayers.i18n("Weather settings"),
    width: 600,
    height: 400,
    closable: true,
    closeAction: 'hide',
    autoScroll: true,
    hideable: true,
    resizable: true,
    draggable: true,
    modal: true,
    //width: '40%',
    //height: '600',
    plain: true,
    layout: 'fit', // fit grid in window
    //modal: false,
    items: [weatherGrid],//, windGrid],
    buttons:[{
        text: OpenLayers.i18n('Close'), 
        handler: function() {
            weathersettingsWindow.hide();
        }
    }]
});
weathersettingsWindow.hide();

function showClimateData() {
    weathersettingsWindow.show();
    weatherStore.loadData();
};

// overig

            function not_implemented() {
                Ext.Msg.show({
                    title: OpenLayers.i18n('Information'),
                    msg: OpenLayers.i18n("Not implemented yet"),
                    width: 400,
                    height: 400,
                    buttons: Ext.MessageBox.OK
                });
            }
            ;

/* vertaling: html, javascript, extjs, openlayers (teksten in OpenLayers.Lang), geoext (teksten in GeoExt.Lang.dict)
*/

OpenLayers.Util.applyDefaults(OpenLayers.Lang['nl'], {
    "Room for a model panel.": "Hier komt een simulatie model.",
    
    "${layerName} is now the active layer.": "Kaartlaag '${layerName}' is nu actief",
    
    "Layers": "Kaartlagen",
    
    "Simulation model": "Simulatiemodel",
    
    "Close": "Sluiten",
    
    "Ignite": "Aansteken",
    
    "Description": "Beschrijving",
    
    "Information": "Informatie",
    
    "Wildfire modeling": "Simulatie van natuurbranden",
    
    "Not implemented yet": "Deze functie is nog niet geïmplementeerd."
});
function translateDom() {
    // vertaalbare teksten in dom moeten class i18n hebben
    var code = OpenLayers.Lang.getCode();
    var dictionary = OpenLayers.Lang[code];
    if (code !== 'en' && dictionary !== 'undefined') {
        var els = Ext.DomQuery.select('.i18n');
        for (var i = 0; i < els.length; i++) {
            var el = els[i];
            if (typeof dictionary[el.innerHTML] !== 'undefined') {
                el.innerHTML = dictionary[el.innerHTML];
            }
        }
    }
}

var mapPanel, tree;
var status;

function online() {
//status.setAttribute("class", "online");
status.innerHTML = "Online";
}

function offline() {
//status.setAttribute("class", "offline");
status.innerHTML = "Offline";
}

// define Ext.onReady(fn, scope, options)
Ext.onReady(function() {
    var win;
    
    // dom is geladen en kan dus vertaald worden
    translateDom();
    
    // maak tooltips mogelijk
    Ext.QuickTips.init();
    
    status = document.getElementById('online-or-offline');

    if (navigator.onLine) {
        online();
    } else {
        offline();
    }

    window.addEventListener('online', online, false);
    window.addEventListener('offline', offline, false);
    
    // create a vector layer for drawing
    var wildfire_layer = new OpenLayers.Layer.Vector('Wildfire lines', {
        displayInLayerSwitcher: false,
        styleMap: new OpenLayers.StyleMap({
            temporary: OpenLayers.Util.applyDefaults({
                    pointRadius: 5
                }, OpenLayers.Feature.Vector.style.temporary),
            'default': OpenLayers.Util.applyDefaults({
                    pointRadius: 5,
                    strokeWidth: 3,
                    strokeColor: '#ff0000'
                }, OpenLayers.Feature.Vector.style['default']),
            select: OpenLayers.Util.applyDefaults({
                    pointRadius: 5,
                    strokeWidth: 3
                }, OpenLayers.Feature.Vector.style.select)
        }),
        eventListeners: {
            beforefeatureadded: function(event) {
                // remove other features
                event.object.removeAllFeatures();
                return true;
            },
            featureadded: function(event) {
                // event = type, element, feature, object (layer)
                console.log('featureadded', event.feature);
            },
            scope: wildfire_layer
        }
    });
    // OpenLayers' EditingToolbar internally creates a Navigation control, we
    // want a TouchNavigation control here so we create our own editing toolbar
    var toolbar = new OpenLayers.Control.Panel({
        displayClass: 'olControlEditingToolbar'
    });
    toolbar.addControls([
        // this control is just there to be able to deactivate the drawing
        // tools
        new OpenLayers.Control({
            displayClass: 'olControlNavigation'
        }),
        new OpenLayers.Control.ModifyFeature(wildfire_layer, {
            vertexRenderIntent: 'temporary',
            displayClass: 'olControlModifyFeature'
        }),
        /*new OpenLayers.Control.DrawFeature(wildfire_layer, OpenLayers.Handler.Point, {
            displayClass: 'olControlDrawFeaturePoint'
        }),*/
        new OpenLayers.Control.DrawFeature(wildfire_layer, OpenLayers.Handler.Path, {
            displayClass: 'olControlDrawFeaturePath'
        })/*,
        new OpenLayers.Control.DrawFeature(wildfire_layer, OpenLayers.Handler.Polygon, {
            displayClass: 'olControlDrawFeaturePolygon'
        })*/
    ]);
    
    // van geoext example tree.html
    var nav, panel;
    mapPanel = new GeoExt.MapPanel({
        border: true,
        region: "center",
        // we do not want all overlays, to try the OverlayLayerContainer
        map: new OpenLayers.Map({
            allOverlays: false, 
            displayProjection: 'EPSG:4326',
            projection: 'EPSG:900913',
            controls: [
                new OpenLayers.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                }),
                new OpenLayers.Control.Zoom(),
                new OpenLayers.Control.ScaleLine({bottomOutUnits: '', bottomInUnits: ''}),
                nav = new OpenLayers.Control.NavigationHistory(),
                //new OpenLayers.Control.Permalink(), // todo: uitzoeken werking geoext met permalink
                toolbar
            ]
        }),
        center: new OpenLayers.LonLat(5.946197509765718, 52.20750576821061).transform('EPSG:4326', 'EPSG:900913'), //[146.1569825, -41.6109735],
        zoom: 10,
        layers: [
            /*new OpenLayers.Layer.WMS("Global Imagery",
                "http://maps.opengeo.org/geowebcache/service/wms", {
                    layers: "bluemarble"
                }, {
                    isBaseLayer: true,
                    buffer: 0,
                    visibility: true
                }
            ),*/
            new OpenLayers.Layer.OSM(),
            new OpenLayers.Layer.WMS('Water', 'http://model.geodan.nl/geoserver/wms?', {
                    layers: 'nl_data:waterdeel_vlak',
                    format: 'image/png',
                    transparent: true
                }, {
                    isBaseLayer: false,
                    visibility: false,
                    maxExtent: OpenLayers.Bounds.fromString('361124.418941,6573545.115699,806881.242096,7095449.313188'),
                    transitionEffect: 'resize'
                }),
            new OpenLayers.Layer.WMS('KNMI Neerslagradar', 'http://geoservices.knmi.nl/cgi-bin/RADNL_OPER_R___25PCPRR_L3.cgi?', {
                    layers: 'RADNL_OPER_R___25PCPRR_L3_COLOR',
                    transparent: true,
                    format: 'image/png'
                }, {
                    visibility: false,
                    opacity: 0.6,
                    singleTile: true,
                    transitionEffect: 'resize'
                }),
            wildfire_layer,
            new OpenLayers.Layer.Boxes('_boxes_', {displayInLayerSwitcher: false})
            /*,
            new OpenLayers.Layer.WMS("Tasmania Roads",
                "http://demo.opengeo.org/geoserver/wms", {
                    layers: "topp:tasmania_roads",
                    transparent: true,
                    format: "image/gif"
                }, {
                    isBaseLayer: false,
                    buffer: 0
                }
            )*/
        ]
    });
    var panel = new OpenLayers.Control.Panel({
        //div: document.getElementById("panel")
    });
    panel.addControls([nav.next, nav.previous]);
    mapPanel.map.addControl(panel);
    
    // create our own layer node UI class, using the TreeNodeUIEventMixin
    var LayerNodeUI = Ext.extend(GeoExt.tree.LayerNodeUI, new GeoExt.tree.TreeNodeUIEventMixin());
    var treeConfig = [{
        nodeType: "gx_baselayercontainer",
        expanded: true
    }, {
        nodeType: "gx_overlaylayercontainer",
        expanded: true,
        // render the nodes inside this container with a radio button,
        // and assign them the group "foo".
        loader: {
            baseAttrs: {
                radioGroup: "foo",
                uiProvider: "layernodeui"
            }
        }
    }/*, {
        nodeType: "gx_layer",
        layer: "Tasmania (Group Layer)",
        isLeaf: false,
        // create subnodes for the layers in the LAYERS param. If we assign
        // a loader to a LayerNode and do not provide a loader class, a
        // LayerParamLoader will be assumed.
        loader: {
            param: "LAYERS"
        }
    }*/];
    
    // create the tree with the configuration from above
    tree = new Ext.tree.TreePanel({
        border: true,
        region: "west",
        title: OpenLayers.i18n("Layers"),
        width: 200,
        split: true,
        collapsible: true,
        collapseMode: "mini",
        autoScroll: true,
        plugins: [
            new GeoExt.plugins.TreeNodeRadioButton({
                listeners: {
                    "radiochange": function(node) {
                        alert(OpenLayers.i18n("${layerName} is now the active layer.", {layerName: node.text}));
                    }
                }
            })
        ],
        loader: new Ext.tree.TreeLoader({
            // applyLoader has to be set to false to not interfere with loaders
            // of nodes further down the tree hierarchy
            applyLoader: false,
            uiProviders: {
                "layernodeui": LayerNodeUI
            }
        }),
        root: {
            nodeType: "async",
            // the children property of an Ext.tree.AsyncTreeNode is used to
            // provide an initial set of layer nodes. We use the treeConfig
            // from above, that we created with OpenLayers.Format.JSON.write.
            //children: Ext.decode(treeConfig)
            // Don't use the line above in your application. Instead, use
            children: treeConfig
            
        },
        listeners: {
            "radiochange": function(node){
                alert(OpenLayers.i18n("${layerName} is now the active layer.", {layerName: node.layer.name}));
            }
        },
        rootVisible: false,
        lines: false,
        bbar: [{
            contentEl: document.getElementById('show-btn'),
            text: OpenLayers.i18n("Ignite"),
            handler: function() {
                not_implemented();
                //treeConfigWin.show();
                //Ext.getCmp("treeconfig").setValue(treeConfig);
            }
        }, {
            text: OpenLayers.i18n('Wfs Grid'),
            handler: function() {
                var map = mapPanel.map;
                var layers = map.getLayersByName('wfs_vector_landscapes');
                if (layers.length > 0) {
                    var wfsLayer = layers[0];
                } else {
                    // wfs kaartlaag toevoegen
                    var wfsLayer = new OpenLayers.Layer.Vector("wfs_vector_landscapes", {
                        //rendererOptions: {
                        //    zIndexing: true
                        displayInLayerSwitcher: false,
                        styleMap: new OpenLayers.StyleMap({
                            'default': new OpenLayers.Style({
                                //display: 'none',
                                fillColor: '#aaaaaa',
                                fillOpacity: 0.2,
                                strokeColor: '#888888',
                                strokeOpacity: 0.4
                            }),
                            'select': new OpenLayers.Style({
                                fillColor: '#ff8800',
                                fillOpacity: 0.6,
                                strokeColor: '#ff0000',
                                strokeOpacity: 0.6,
                                strokeWidth: '3px',
                                display: 'visible'
                            })
                        })
                    });
                    // TODO: voor wfs laag alleen geselecteerde feature tonen!
                    mapPanel.map.addLayer(wfsLayer);
                }
                // create feature store, binding it to the vector layer
                var store = new GeoExt.data.FeatureStore({
                    layer: wfsLayer,
                    /*fields: [
                        {name: 'landscape_name', type: 'string'},
                        {name: 'started', type: 'date'}
                    ],*/
                    //recordType: TerrainFeatureRecord,
                    reader: new GeoExt.data.FeatureReader({}, TerrainFeatureRecord),
                    proxy: new GeoExt.data.ProtocolProxy({
                        protocol: new OpenLayers.Protocol.WFS({
                            url: "/geoserver/ows",
                            version: "1.1.0",
                            featureType: 'landscapes',
                            featureNS: 'model_wildfire',
                            srsName: 'EPSG:900913'//,
                            //outputFormat: 'application/json', // richting geoserver
                            //format: new OpenLayers.Format.GeoJSON() // ??
                        })
                    }),
                    autoLoad: true
                });
                console.log('Store', store);
                // create grid panel configured with feature store
                gridPanel = new Ext.grid.GridPanel({
                    title: "Feature Grid",
                    applyTo: "desc",
                    region: "east",
                    store: store,
                    width: 320,
                    height: 400,
                    columns: [{
                        header: "Naam",
                        width: 200,
                        sortable: true,
                        dataIndex: "landscape_name"
                    }, {
                        header: 'Begintijd',
                        width: 200,
                        sortable: true,
                        dataIndex: 'started'
                    }],
                    sm: new GeoExt.grid.FeatureSelectionModel({
                        autoPanMapOnSelection: false, // we zoomen er zelf naartoe
                        singleSelect: true
                    })
                });
                
                gridPanel.store.bind(wfsLayer);
                gridPanel.getSelectionModel().bind(wfsLayer);
                gridPanel.getSelectionModel().on('rowselect', function (obj, rowIndex, row){
                    console.log('rowselect', row.data.feature);
                    var center = row.data.feature.geometry.getCentroid();
                    mapPanel.map.panTo(new OpenLayers.LonLat(center.x, center.y));
                    
                    var time = new Date(row.data.feature.attributes['started']);
                    time = new Date(time.getTime() - time.getTime() % (5*60*1000)); // round to 5 minutes
                    console.log('tijd afgerond', time);
                    var map = row.data.feature.layer.map;
                    var layers = map.getLayersByName('KNMI Neerslagradar');
                    if (layers.length > 0) {
                        var layer = layers[0];
                        layer.mergeNewParams({time: time.toISOString()});
                    }
                }, gridPanel);

                // create a panel and add the map panel and grid panel
                // inside it
                /*mainPanel = new Ext.Panel({
                    renderTo: "mainpanel",
                    layout: "border",
                    height: 400,
                    width: 920,
                    items: [mapPanel, gridPanel]
                });*/
            }
        }]
    });
    
    var modelPanel = new Ext.Panel({
            title: OpenLayers.i18n("Simulation model"),
            contentEl: document.getElementById('model'),
            region: "east",
            bodyStyle: {"padding": "0px"},
            collapsible: true,
            collapseMode: "mini",
            autoScroll: true,
            split: true,
            width: 200,
            layout: 'auto',
            items: [
    new Ext.form.FormPanel({
	title: OpenLayers.i18n("Step 1 - Location"),
	//html: "Create conversion parameters and select area in the map by dragging a box around it. This will be the models boundary.",
	id: "farsitepanel1",
        collapsible: true,
	labelWidth: 40,
	labelAlign: 'left',
        monitorValid: true, // 
	layout: {
            type:  "form",
            align: "center"
	},
	defaults: {
            style: 'margin: 5px'
	},
	items: [
	/*	{
			xtype:'fieldset',
			id: 'fieldset_conversie',
			title: 'Conversie',
			defaults: {
				width: 150,
			},
			items: [
				actions["landuse2fuel"]
			]
		},{
			xtype: 'fieldset',
			id: 'fieldset_nieuwbestaand',
			title: 'Nieuw of bestaand',
			defaults: {
				width: 150,
			},
			items: [
				actions["newfuelmodel"],
				actions["existingfuelmodel"]
			]
		},*/
                {
                    xtype: 'fieldset',
                    title: OpenLayers.i18n('Select area'),
                    defaults: {
                        width: 'inherited'
                    },
                    items: [
                        {
                            xtype: "panel", //need this to put plugin-terrein in 
                            defaults: {width: 150, style: 'margin: 0px;'},
                            id: "terreinpanel1", 
                            border: false
                        }, {
                            xtype: 'numberfield',
                            id: 'terrein_id',
                            name: 'terrein_id',
                            fieldLabel: OpenLayers.i18n('Terrein ID'),
                            width: 40,
                            disabled: true,
                            hidden: true,
                            value: '0'
                        },
                        new Ext.Button({
                            text: OpenLayers.i18n("Select region"),
                            //xtype: 'button',
                            id: 'btn_select_region',
                            enableToggle: true,
                            tooltip: OpenLayers.i18n("Select region by dragging a rectangle in the map"),
                            handler: function(b, e) {
                                console.log('select region handler', b.pressed);
                                var map = mapPanel.map;
                                if (b.pressed) {
                                    var control = new OpenLayers.Control();
                                    b.control = control;
                                    OpenLayers.Util.extend(control, {
                                        draw: function () {
                                            // this Handler.Box will intercept the shift-mousedown
                                            // before Control.MouseDefault gets to see it
                                            this.box = new OpenLayers.Handler.Box( control,
                                                {"done": this.notice},
                                                {keyMask: OpenLayers.Handler.MOD_SHIFT}
                                            );
                                            this.box.activate();
                                        },

                                        notice: function (bounds) {
                                            // lower-left
                                            var ll = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.bottom)); 
                                            // upper-right
                                            var ur = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.top)); 

                                            var bounds = new OpenLayers.Bounds(
                                                ll.lon.toFixed(0), // left
                                                ll.lat.toFixed(0), // bottom
                                                ur.lon.toFixed(0), // right
                                                ur.lat.toFixed(0) // top
                                            );
                                            var geom = bounds.toGeometry();
                                            var area = geom.getArea(); // or getGeodesicArea('EPSG:900913')
                                            if (area > Gmi.Settings.maxArea) {
                                                // TODO: in km2 zou leesbaarder zijn
                                                alert(OpenLayers.i18n('Area ${area} is larger than ${max} m2', {
                                                    max: Gmi.Settings.maxArea, 
                                                    area: area
                                                }));
                                                //return;
                                            }
                                            console.log('area', area);

                                            var layers = map.getLayersByName('_boxes_');
                                            if (layers.length > 0) {
                                                // layer leegmaken
                                                layers[0].clearMarkers();
                                                // nieuwe toevoegen
                                                var box = new OpenLayers.Marker.Box(bounds);
                                                layers[0].addMarker(box);
                                            }
                                        }
                                    });
                                    mapPanel.map.addControl(control);
                                } else {
                                    // disable regio kiezen, maar laat gebied zichtbaar
                                    b.control.box.deactivate();
                                    map.removeControl(b.control);
                                }
                            },
                            cls: 'g-actie-knop'
                        }),
                        new Ext.Button({
                            text: OpenLayers.i18n('Make subset'),
                            cls: 'g-actie-knop',
                            handler: function(b, e) {
                                // kaart variabele beschikbaar maken
                                var map = mapPanel.map;
                                // laag achterhalen
                                var layers = map.getLayersByName('_boxes_');
                                if (layers.length > 0) {
                                    // rechthoek achterhalen
                                    //var bounds = layers[0].getDataExtent(); // gaat fout omdat deze functie marker.lonlat gebruikt en deze hier null
                                    var bounds = layers[0].markers.length > 0 ? layers[0].markers[0].bounds : null;
                                    if (! bounds) {
                                        alert(OpenLayers.i18n('Select region first'));
                                    } else {
                                        // select region knop deactiveren
                                        var btn_select_region = Ext.getCmp('btn_select_region');
                                        if (btn_select_region.pressed) {
                                            btn_select_region.control.box.deactivate();
                                            map.removeControl(btn_select_region.control);
                                            btn_select_region.doToggle();
                                        }
                                        Gmi.Session.box = bounds;

                                        // makesubset process aanroepen
                                        startProgress(OpenLayers.i18n('makesubset'));
                                        Ext.Ajax.request({
                                            url: '/geoserver/ows?', 
                                            params: {
                                                service: 'WPS',
                                                version: '1.1.0',
                                                request: 'execute',
                                                identifier: 'py:wildfire_makesubset',
                                                datainputs: combineParams({
                                                    userid: Gmi.Session.userid,
                                                    name: 'test',
                                                    left: bounds.left,
                                                    lower: bounds.bottom,
                                                    right: bounds.right,
                                                    upper: bounds.top
                                                }, ';'),
                                                RawDataOutput: 'string',
                                                mimeType: 'application/json'
                                            },
                                            on_finished: function(out_params) {
                                                // bewaar runid als terreinid
                                                Gmi.Session.terreinid = out_params.runid;
                                                // verwijdere oude terreinen
                                                var layers = map.getLayersByName('Terrein');
                                                /*for (var i = layers.length - 1; i >= 0; i--) {
                                                    map.removeLayer(layers[i]);
                                                }*/
                                                // voeg nieuwe terrein toe
                                                var name = 'model_wildfire:terrein_' + out_params.runid;
                                                if (layers.length > 0) {
                                                    layers[0].mergeNewParams({
                                                        layers: name
                                                    });
                                                } else {
                                                    var layer = new OpenLayers.Layer.WMS('Terrein', 
                                                    'http://model.geodan.nl/geoserver/wms?', {
                                                        layers: name,
                                                        transparent: true,
                                                        format: 'image/png'
                                                    }, {
                                                        isBaseLayer: false,
                                                        opacity: 0.6
                                                    });
                                                    map.addLayer(layer);
                                               }
                                           },
                                           success: wpsSuccessCallback,
                                           failure: wpsFailureCallback
                                        });
                                    }
                                }
                            }
                        })
                    ]
                }, { /*
			xtype: 'fieldset',
			title: 'Bewerk terrein',
			defaults: {
				width: 150,
			},
			items: [
				{
					xtype: "panel", //need this to put edit-tool in 
					defaults: {width: 150, style: 'margin: 0px;'},
					id: "terreineditpanel1",
                            border: false
                        }
                        ]
                }, { */
                        xtype: 'fieldset',
                        title: OpenLayers.i18n('Save'),
                        defaults: {
                            width: 'inherited'
                        },
                        items: [
                            {
                                fieldLabel: OpenLayers.i18n('Name'),
                                xtype: 'textfield',
                                id: 'fuelmodel_name',
                                name: 'fuelmodel_name',
                                tooltip: OpenLayers.i18n('Name of terrain'),
                                width: 100,
                                align: 'right',
                                //allowBlank: false, // must be filled in!
                                value: OpenLayers.i18n('untitled')
                                //style: 'padding: 0px;'
                            },
                            //actions["makeLcp"]
                            new Ext.Button({
                                text: OpenLayers.i18n("Save"),
                                formBind: true, // If form validation fails disable the button
                                //xtype: 'button',
                                tooltip: OpenLayers.i18n("Create landscape file on the base of currently selected region"),
                                handler: function() {
                                    var terreinid = Gmi.Session.terreinid; //Ext.getCmp("terrein_id").getValue();
                                    var landscapename = Ext.getCmp("fuelmodel_name").getValue();
                                    if (! terreinid) {
                                        alert(OpenLayers.i18n('Landscape file cannot be prepared yet.'));
                                    } else {
                                        // maak landschap ('lcp') voor model aan
                                        startProgress(OpenLayers.i18n('makelcp'));
                                        Ext.Ajax.request({
                                            url: '/geoserver/ows?', //service=WPS&request=execute&version=1.0.0&identifier=py:wildfire_makelcp&datainputs=userid=' + userid + ';terreinid=' + terreinid + ';landscapename=' + landscapename + ';&RawDataOutput=string&mimeType=application/json',
                                            params: {
                                                service: 'WPS',
                                                version: '1.1.0',
                                                request: 'execute',
                                                identifier: 'py:wildfire_makelcp',
                                                datainputs: combineParams({
                                                    userid: Gmi.Session.userid,
                                                    terreinid: terreinid,
                                                    landscapename: landscapename
                                                }, ';'),
                                                RawDataOutput: 'string',
                                                mimeType: 'application/json'
                                            },
                                            on_finished: function(out_params) {
                                                // bewaar id van fuelmodel
                                                Gmi.Session.fuelid = out_params.runid;
                                            },
                                            success: wpsSuccessCallback,
                                            failure: wpsFailureCallback
                                        });
                                    }
                                },
                                cls: 'g-actie-knop'
                            })
                        ]
                    }
                    ]
                }),
                new Ext.form.FormPanel({
                    title: 'Step 2 - Inputs',
                    collapsible: true,
                    defaults: {
                        style: 'margin: 5px'
                    },
                    items: [
                        {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Weather data'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [
                                new Ext.form.ComboBox({
                                    id: 'weatherstation',
                                    fieldLabel: 'Weather station',
                                    name: 'station',
                                    typeAhead: true,
                                    triggerAction: 'all',
                                    lazyRender: true,
                                    align: 'right',
                                    mode: 'local',
                                    value: 275, // default: Deelen
                                    forceSelection: true, editable: false,
                                    store: new Ext.data.ArrayStore({
                                        id: 0,
                                        fields: [
                                            'id',
                                            'naam'
                                        ],
                                        data: [[260, 'De Bilt'], [275, 'Deelen'], [283, 'Hupsel'], [375, 'Volkel']]
                                    }),
                                    valueField: 'id',
                                    displayField: 'naam'
                                }),
                                new Ext.Button({
                                    text: OpenLayers.i18n('Show weather data'),
                                    handler: showClimateData,
                                    cls: 'g-actie-knop'
                                })
                            ]
                        }, {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Fire location'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [
                                new Ext.Button({
                                    text: OpenLayers.i18n('Draw fire line'),
                                    handler: drawFireLine,
                                    cls: 'g-actie-knop'
                                })
                            ]
                        }
                    ]
                }),
                new Ext.form.FormPanel({
                    title: 'Step 3 - Run model',
                    collapsible: true,
                    defaults: {
                        style: 'margin: 5px'
                    },
                    items: [
                        {
                            xtype: 'fieldset',
                            title: OpenLayers.i18n('Execution'),
                            defaults: {
                                width: 'inherited'
                            },
                            items: [
                                new Ext.Button({
                                    text: OpenLayers.i18n('Start run'),
                                    handler: startModelRun,
                                    cls: 'g-actie-knop'
                                })
                            ]
                        }
                    ]
                }),
                new Ext.form.FormPanel({
                    title: 'Step 4 - Outputs',
                    collapsible: true,
                    defaults: {
                        style: 'margin: 5px'
                    },
                    html: '&lt;todo&gt;',
                    cls: 'empty'
                })]
            });
    var viewportItems = [mapPanel, tree, modelPanel];
    
    new Ext.Viewport({
        layout: "fit",
        hideBorders: true,
        items: {
            layout: "border",
            deferredRender: false,
            items: viewportItems
        }
    });
    
    // toevoegen van stappen aan rechterkant (simPanel)
 
    var button = Ext.get('show-btn');

    button.on('click', function() {
        // create the window on the first click and reuse on subsequent clicks
        if (!win) {
            win = new Ext.Window({
                applyTo: 'hello-win',
                title: 'Simulatie', // of hier of in div met class x-window-header
                layout: 'fit',
                width: 500,
                height: 300,
                closeAction: 'hide', // NB anders slechts 1x bruikbaar
                plain: true,
                modal: true,
                items: new Ext.TabPanel({
                    //applyTo: 'hello-tabs',
                    renderTo: Ext.get('hello-win'),
                    //autoTabs: true,
                    activeTab: 0,
                    deferredRender: false,
                    border: false,
                    items: [{
                            xtype: 'form',
                            title: 'Gebied', // 1ste tab
                            defaults: {
                                width: 150
                            },
                            items: [
                                {
                                    xtype: 'textfield',
                                    fieldLabel: 'Naam gebied'
                                },
                                {
                                    xtype: 'button',
                                    fieldLabel: 'Selecteer gebied',
                                    handler: not_implemented
                                },
                                {
                                    xtype: 'combo',
                                    fieldLabel: 'Choose version',
                                    store: ['3.0', '2.0', '1.0']
                                },
                                {
                                    xtype: 'button',
                                    fieldLabel: 'Opslaan'
                                }
                            ]
                        }, {
                            xtype: 'form',
                            title: 'Weersomstandigheden', // 2de tab
                            defaults: {
                                width: 150
                            },
                            items: [
                                {
                                    xtype: 'textfield',
                                    fieldLabel: 'Name'
                                },
                                {
                                    xtype: 'checkbox',
                                    fieldLabel: 'Do you love Ext?'
                                },
                                {
                                    xtype: 'combo',
                                    fieldLabel: 'Choose version',
                                    store: ['3.0', '2.0', '1.0']
                                }
                            ]
                        }, {
                            xtype: 'form',
                            title: 'Tijd', // 3de tab
                            items: [
                                {
                                    xtype: 'datefield',
                                    fieldLabel: 'Begintijd',
                                    width: 'auto',
                                    format: 'd-m-Y'
                                }
                                , {
                                    xtype: 'datefield',
                                    fieldLabel: 'Eindtijd',
                                    width: 'auto',
                                    format: 'd-m-Y'
                                }
                            ]
                        }
                    ]
                }),
                buttons: [{
                        text: 'Help',
                        handler: not_implemented
                    }, {
                        text: 'Annuleren',
                        disabled: true
                    }, {
                        text: 'Start',
                        handler: not_implemented,
                        handlerX: function() {
                            win.hide();
                        }
                    }]
            });
        }
        win.show(this);
    });

});

function drawFireLine() {
    not_implemented();
};

function startModelRun() {
    
    var map = mapPanel.map;
    if (! map) {
        alert('Interne fout: map is undefined.'); // internal
        return;
    }    
    
    // TODO: vuurfront uitlezen ipv middelpunt van box
    if (! Gmi.Session.box) {
        alert('Box/Subset is undefined.'); // [Make subset]
        return;
    }
    
    var t = map.getLayersByName('Wildfire lines');
    if (t.length === 0) {
        alert('Interne fout: geen vectorlaag voor vuurlijnen');
        return;
    }
    var wildfire_layer = t[0];
    if (wildfire_layer.features.length === 0) {
        alert('Geen vuurfront getekend');
        return;
    }
    var geom = wildfire_layer.features[0].geometry.clone();
    for (var i = 0; i < geom.components.length; i++) {
        geom.components[i].transform('EPSG:900913', 'EPSG:28992');
    }
    var wkt = geom.toString(); // rd geometry
    console.log('fire line', wkt);
    //return;
/*    
    var rdbox = Gmi.Session.box.clone().transform('EPSG:900913', 'EPSG:28992');
    var center = rdbox.getCenterLonLat();
    //var p = new OpenLayers.Geometry.Point(center.lon, center.lat);
    var geom = new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(center.lon - 1, center.lat - 1), new OpenLayers.Geometry.Point(center.lon + 1, center.lat + 1)]);
    var wkt = geom.toString();
    //var wkt = 'LINESTRING(' + center.lon +' ' + center.lat + ', ' + center.lon +' ' + center.lat + ')';
*/
    if (! Gmi.Session.fuelid) {
        alert('Fuel model is undefined.'); // [Save]
        return;
    }
    
    // weather/wind data
    
    // startRun process aanroepen
    // Let op: 
    startProgress(OpenLayers.i18n('startRun'));
    Ext.Ajax.request({
        url: '/geoserver/ows?', 
        params: {
            service: 'WPS',
            version: '1.1.0',
            request: 'execute',
            identifier: 'py:wildfire_startRun',
            datainputs: combineParams({
                userid: Gmi.Session.userid,
                name: 'test brand', // naam van brand
                fuelmodel: Gmi.Session.fuelid, // runid van fuelmodel (resultaat van makelcp)
                geom: wkt, // wkt LINESTRING(x y, ...) RD projectie
                // wind: (month,day,hour,speed,dir,cl), etc (6 uren)
                windstring: '(5,16,1508,00,180,10),(5,16,1608,00,180,10),(5,16,1708,00,180,10),(5,16,1808,00,180,10),(5,16,1908,00,180,10),(5,17,2008,00,180,10)', 
                // windstring=(5,16,1508,00,180,10),(5,16,1608,00,180,10),(5,16,1708,00,180,10),(5,16,1808,00,180,10),(5,16,1908,00,180,10),(5,16,2008,00,180,10);
                // weather: (month,day,rn,am,pm,tlo,thi,hhi,hlo,elv), etc (6 dagen)
                weatherstring: '(05,12,00,0500,1500,15,32,60,15,0000),(05,13,00,0500,1500,15,32,50,10,0000),(05,14,00,0500,1500,15,32,50,11,0000),(05,15,00,0500,1500,15,32,60,10,0000),(05,16,00,0500,1500,15,32,50,10,0000),(05,17,00,0500,1500,15,32,50,10,0000)', 
                // weatherstring=(05,12,00,0500,1500,15,32,60,15,0000),(05,13,00,0500,1500,15,32,50,10,0000),(05,14,00,0500,1500,15,32,50,11,0000),(05,15,00,0500,1500,15,32,60,10,0000),(05,16,00,0500,1500,15,32,50,10,0000),(05,17,00,0500,1500,15,32,50,10,0000);
                // startmonth=05;startday=16;starthour=1508;
                startmonth: '05', // 0-padded
                startday: '16', // 0-padded, laatste dag van weather/wind-string
                starthour: '1508' // hhmm
            }, ';'),
            RawDataOutput: 'string',
            mimeType: 'application/json'
        },
        on_finished: function(out_params) {
            // toevoegen van kaartlaag met naam als model_wildfire:result_1769
            // bewaar runid als terreinid
            Gmi.Session.fireid = out_params.runid;
            // verwijdere oude terreinen
            var layers = map.getLayersByName('Brandverspreiding');
            var name = 'model_wildfire:result_' + out_params.runid;
            if (layers.length > 0) {
                // pas huidige resultaat aan
                layers[0].mergeNewParams({
                    layers: name
                });
            } else {
                // voeg nieuwe resultaat toe
                var layer = new OpenLayers.Layer.WMS('Brandverspreiding', 
                'http://model.geodan.nl/geoserver/wms?', {
                    layers: name,
                    transparent: true,
                    format: 'image/png'
                }, {
                    isBaseLayer: false,
                    opacity: 0.6
                });
                map.addLayer(layer);
           }
       },
       success: wpsSuccessCallback,
       failure: wpsFailureCallback
    });
};

var wpsFailureCallback = function(response, options) {
    stopProgress();
    alert(OpenLayers.i18n('WPS failure'));
};

var wpsSuccessCallback = function(response, options) {
    console.log('wpsSuccessCallback response', response);
    
    var params = JSON.parse(response.responseText);
    var activerunid = params.runid;
    // statussen: scheduled, running, error, finished
    if (params.status === 'scheduled') {
        var runner = new Ext.util.TaskRunner();
        // bij een 'scheduled' process moet voortgang gecontroleerd worden
        var task = {
            interval: 1000, // 1 seconde
            run: function() {
                //Ext.fly('clock').update(new Date().format('g:i:s A'));
                Ext.Ajax.request({
                    url:'/geoserver/ows?',//service=WPS&request=execute&version=1.0.0&identifier=py:checkModelStatus&datainputs=runid='+activerunid+';&RawDataOutput=string=mimeType="application/json"',
                    params: {
                        service: 'WPS',
                        version: '1.1.0',
                        request: 'execute',
                        identifier: 'py:checkModelStatus',
                        RawDataOutput: 'string',
                        mimeType: 'application/json',
                        datainputs: combineParams({
                            runid: activerunid
                        }, ';')
                    },
                    success: function(check_response) {
                        var params = {};
                        //console.log(check_response);
                        try {
                            params = JSON.parse(check_response.responseText);
                        } catch (err) {
                            params.status = 'error';
                            params.lastMessage = check_response.responseText;
                        }
                        if (params.status === 'error') {
                            runner.stop(task); 
                            stopProgress();
                            console.log('wfs taak ging fout', params);
                            alert(OpenLayers.i18n('WFS process error: ${msg}', {msg: params.lastMessage}));
                        } else if (params.percentage == 100) {
                            runner.stop(task); 
                            stopProgress();
                            console.log('wfs taak is klaar', params);
                            if (options.on_finished) {
                                options.on_finished(params);
                            } else {
                                alert(OpenLayers.i18n('Process is ready; results are ignored'));
                            }
                        } else if (check_response.tId >= 120) {
                            runner.stop(task);
                            stopProgress();
                            console.log('wfs taak duurde te lang', params);
                            alert(OpenLayers.i18n('Process takes too long; aborted'));
                        } else {
                            updateProgress(check_response.tId, params.percentage);
                            console.log('voortgang', check_response.tId, params);
                        }
                    },
                    failure: function() {
                        stopProgress();
                        runner.stop(task);
                        console.log('WFS process failure', arguments);
                        alert('WFS process failure');
                    }
                });
            }
        };
        runner.start(task);
    } else if (params.status === 'finished') {
        stopProgress();
        // direct resultaat, dus on_finished
        if (options.on_finished) {
            options.on_finished(params);
        }
    } else if (params.status === 'error') {
        // fout
        stopProgress();
        alert(OpenLayers.i18n('WFS process error: ${msg}', {msg: params.lastMessage}));
    } else {
        stopProgress();
        // onbekende veld
        alert(OpenLayers.i18n('Internal error: unknown return status'));
    }
};

function startProgress(message) {
    Ext.MessageBox.show({
        title: OpenLayers.i18n('Please wait'),
        msg: message,
        progressText: OpenLayers.i18n('Initializing...'),
        width: 300,
        progress: true,
        closable: false
        //,animEl: 'mb6'
    });
};

function updateProgress(i, perc) {
    Ext.MessageBox.updateProgress(i, OpenLayers.i18n('${perc}% completed',{perc: Math.round(perc)}));
};

function stopProgress() {
    Ext.MessageBox.hide();
};

function combineParams(o, sep) {
    if (!sep) {
        sep = ';';
    }
    var s = '';
    for (var key in o) {
        s += key + '=' + o[key] + sep;
    }
    return s;
}

//-->
        </script>
        <div id="online-or-offline">?</div>
        <input type="button" id="show-btn" value="Open dialoog" />
        <br />
        <br />
        <div id="hello-win" class="x-hidden">
        </div>
        <div id="wfsgrid">WFS grid</div>

        <div class="x-window-header">Simulatie</div>
        <div id="hello-tabs">
            <!-- Auto create tab 1 -->
            <div class="x-tab" title="Hello World 1">
                <p>Hello...</p>
            </div>
            <!-- Auto create tab 2 -->
            <div class="x-tab" title="Hello World 2">
                <p>... World!</p>
            </div>
        </div>
        
        <div id="model">
            <!--p class="i18n">Room for a model panel.</p-->
            <div id="desc"></div>
        </div>
    </body>
</html>
