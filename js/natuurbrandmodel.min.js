Ext.namespace("Gmi.Control","Gmi.Data","Gmi.Params","Gmi.Services","Gmi.Services.WPS","Gmi.Session","Gmi.Settings");Gmi.Settings.debug=(location.host==="brand.localhost");Gmi.Params=Gmi.Params||{};if(location.search!==""){var search=location.search.substr(1);var params=search.split("&");for(var i=0;i<params.length;i++){var pos=params[i].indexOf("=");if(pos<0){Gmi.Params[params[i]]=null}else{var key=params[i].substr(0,pos);var value=params[i].substr(pos+1);Gmi.Params[key]=value;if(key==="debug"){Gmi.Settings.debug=(value==="true")}}}}Gmi.Control.SessionHistory=OpenLayers.Class(OpenLayers.Control.NavigationHistory,{initialize:function(a){OpenLayers.Control.NavigationHistory.prototype.initialize.apply(this,[a])},destroy:function(){OpenLayers.Control.NavigationHistory.prototype.destroy.apply(this)},getState:function(){var a=OpenLayers.Control.NavigationHistory.prototype.getState.apply(this);return a},restore:function(a){OpenLayers.Control.NavigationHistory.prototype.restore.apply(this,arguments)},CLASS_NAME:"Gmi.Control.SessionHistory"});Gmi.Version="0.1";Gmi.Settings.openLayers_imgPath="img/";if(location.host==="brand.localhost"){Gmi.Settings.openLayers_proxyHost="proxy.php?url="}else{Gmi.Settings.openLayers_proxyHost="cgi-bin/proxy.cgi?url="}Gmi.userDefaults=localStorage.userDefaults;if(typeof Gmi.userDefaults==="undefined"){Gmi.userDefaults={station:275}}else{Gmi.userDefaults=JSON.parse(Gmi.userDefaults)}Gmi.Settings.maxArea=10000*10000;Gmi.Settings.tijd_afronding_minuten=5;Gmi.Settings.operationalMode=1;Gmi.Settings.dateFormat="Y-m-d";Gmi.Settings.datetimeFormat="Y-m-d H:i";Gmi.Settings.decimalSeparator=".";Gmi.Settings.maxZoomOnMoveToTerrain=14;Gmi.Settings.weatherDaysBefore=6;Gmi.Settings.weatherDefaults={station:Gmi.userDefaults.station,tmin:15,tmax:30,hmin:50,hmax:100,precipitation:0,speed:3.3,direction:225,cloudiness:0};Gmi.Settings.windHours=6;Gmi.Session.userid="0";OpenLayers.imgPath=Gmi.Settings.openLayers_imgPath;OpenLayers.ProxyHost=Gmi.Settings.openLayers_proxyHost;OpenLayers.Util.applyDefaults(OpenLayers.Lang.nl,{"${perc}% completed":"Voortgang ${perc}%","All weather data will be cleared. Are you sure?":"Alle opgeslagen weergegevens zullen worden verwijderd. Doorgaan?","Area ${area}":"Oppervlakte ${area}","Area ${area} is too large; the maximum is ${max}":"Een oppervlakte van ${area} is te groot; maximaal ${max} is toegestaan.",Change:"Wijzigen","Change zoom":"Zoom wijzigen","Clear weather data":"Verwijderen weerdata","Click here to download the shapefile":"Klik hier om een shapefile te downloaden",Close:"Sluiten","Cloudiness (%)":"Bewolking (%)","Create landscape file on the base of currently selected region":"Bepaal hoeveelheid brandstof op basis van huidige gebied","Custom data":"Eigen gegevens",Date:"Datum","Date & time":"Datum & tijd","Direction (&deg;)":"Richting (&deg;)","Distance: ${distance} ${units}":"Afstand: ${distance} ${units}","Draw a fire line first":"Geen vuurfront getekend","Draw fire line":"Teken vuurfront","Draw new fire line":"Teken nieuw vuurfront",Edit:"Wijzigen","Edit feature":"Wijzig feature","Edit the land use":"Wijzig landgebruik",Execution:"Uitvoering","Export shape file":"Exporteer shapefile","Feature Grid":"Grid","Fire location":"Locatie van brand","Fuel list":"Brandstoflijst","Fuel model is undefined.":"Het terrein is niet opgeslagen.","Initializing...":"Initialiseren","Is modified?":"Gewijzigd?",Layers:"Kaartlagen","Measure distances in map":"Bepaal afstanden in kaart","Modify existing fire line":"Wijzig huidige vuurfront",Name:"Naam","Name of fire":"Naam van brand","Name of terrain":"Naam van terrein","Navigate in map":"Navigeer in kaart","Not implemented yet":"Deze functie is nog niet geïmplementeerd.","Please wait":"Even wachten","Preparing fuel model":"Bepalen van brandstof","Preparing terrain":"Uitsnijden terrein","Region is undefined.":"Er is geen gebied geselecteerd","Restore next extent":"Herstel volgende kaartbeeld","Restore previous extent":"Herstel vorige kaartbeeld","Running fire model":"Uitvoeren van natuurbrandmodel",Save:"Opslaan","Saved terrains":"Opgeslagen terreinen","Scale line":"Schaalbalk","Select area":"Selecteer oppervlakte","Select region":"Selecteer gebied","Select region first":"Selecteer eerst een gebied","Select region by dragging a rectangle in the map":"Selecteer gebied door het trekken van een rechthoek","Set weather data":"Weergegevens","Show translations":"Toon vertalingen","Simulation model":"Simulatiemodel","Speed (m/s)":"Snelheid (m/s)","Start run":"Start model",Station:"Station","Step 1 - Location":"Stap 1 - Locatie","Step 2 - Inputs":"Stap 2 - Invoergegevens","Step 3 - Run model":"Stap 3 - Model","Step 4 - Results":"Stap 4 - Resultaat",Terrain:"Terrein","Terrein ID":"Terrein ID",Time:"Tijd",Topography:"Topografie",Warning:"Waarschuwing",Weather:"Weer","Weather characteristics":"Weergegevens","Weather data":"Weer data","Weather settings":"Weer instellingen","Weather station":"Weerstation","WFS process error: ${msg}":"Fout bij uitvoering model: ${msg}","Wild fire layer is missing":"Brandverspreidingslaag is nog niet berekend","Wildfire modeling":"Simulatie van natuurbranden",Wind:"Wind","Wind characteristics":"Windgegevens","save succeeded":"Succesvol opgeslagen",todo:"Te doen",untitled:"geen titel"});OpenLayers.Util.applyDefaults(OpenLayers.Lang.nl,{"${layerName} is now the active layer.":"Kaartlaag '${layerName}' is nu actief",Description:"Beschrijving",Ignite:"Aansteken",Information:"Informatie","No terrain selected":"Geen terrein beschikbaar","Too large":"Te groot",Weather:"Weer"});OpenLayers.Util.applyDefaults(OpenLayers.Lang.fr,{"Change zoom":"",Close:"","Cloudiness (%)":"","Create landscape file on the base of currently selected region":"","Custom data":"",Date:"","Date & time":"","Direction (&deg;)":"","Draw fire line":"","Draw new fire line":"",Edit:"","Edit the land use":"",Execution:"","Fire location":"","Is modified?":"",Layers:"","Measure distances in map":"","Modify existing fire line":"",Name:"","Name of fire":"","Name of terrain":"","Navigate in map":"","Restore next extent":"","Restore previous extent":"",Save:"","Saved terrains":"","Scale line":"","Select area":"","Select region":"","Select region by dragging a rectangle in the map":"","Set weather data":"","Simulation model":"","Speed (m/s)":"","Start run":"",Station:"","Step 1 - Location":"","Step 2 - Inputs":"","Step 3 - Run model":"",Terrain:"","Terrein ID":"",Time:"",Weather:"","Weather characteristics":"","Weather data":"","Weather settings":"","Weather station":"","Wildfire modeling":"",Wind:"","Wind characteristics":"",untitled:"sans titre"});Gmi.Data.translations={};Gmi.Data.addTranslation=function(b){var a=OpenLayers.Lang.getCode();var c="";if(OpenLayers.Lang[a]){c=OpenLayers.Lang[a][b];if(!c){c=""}}Gmi.Data.translations[b]=c};OpenLayers.orig_i18n=OpenLayers.i18n;OpenLayers.i18n=function(){Gmi.Data.addTranslation(arguments[0]);return OpenLayers.orig_i18n.apply(window,arguments)};Gmi.Data.showTranslations=function(){function b(g){var d=[];for(var f in g){d[d.length]=f}d.sort();var c={};for(var e=0;e<d.length;e++){c[d[e]]=g[d[e]]}return c}var a="OpenLayers.Util.applyDefaults(OpenLayers.Lang['"+OpenLayers.Lang.getCode()+"'], "+JSON.stringify(b(Gmi.Data.translations),null,4)+");\n";alert(a)};function translateDom(){var d=OpenLayers.Lang.getCode();var e=OpenLayers.Lang[d];if(d!=="en"&&e!=="undefined"){var b=Ext.DomQuery.select(".i18n");for(var a=0;a<b.length;a++){var c=b[a];Gmi.Data.addTranslation(c.innerHTML);if(typeof e[c.innerHTML]!=="undefined"){c.innerHTML=e[c.innerHTML]}}}}Gmi.Data.fuels={count:58,types:{"1":"GR1 | Short grass","2":"GR2 | Timber grass and understory","3":"GR3 | Tall grass","4":"SH4 | Chaparral","5":"SH5 | Brush","6":"SH6 | Dormant brush","7":"SH7 | Southern rough","8":"TL8 | Compact timber litter","9":"TL9 | Hardwoord litter","10":"TU10 | Timber litter and understory","11":"SB11 | Light slash","12":"SB12 | Medium slash","13":"SB13 | Heavy slash","91":"NB91 | Urban/suburban","92":"NB92 | Snow/Ice","93":"NB93 | Agricultural field","98":"NB98 | Open water","99":"NB99 | Bear ground","101":"GR101 | Short, sparse dry climate grass","102":"GR102 | Low load dry climate grass","103":"GR103 | Low load very coarse humid climate grass","104":"GR104 | Moderate load dry climate grass","105":"GR105 | Low load humid climate grass","106":"GR106 | Moderate load humid climate grass","107":"GR107 | High load dry climate grass","108":"GR108 | High load very coarse humid climate grass","109":"GR109 | Very high load humid climate grass","121":"GS121 | Low load dry climate grass-shrub","122":"GS122 | Moderate load dry climate grass-shrub","123":"GS123 | Moderate load humid climate grass-shrub","124":"GS124 | High load humid climate grass-shrub","141":"SH141 | Low load dry climate shrub","142":"SH142 | Moderate load dry climate shrub","143":"SH143 | Moderate load humid climate shrub","144":"SH144 | Low load humid climate timber shrub","145":"SH145 | High load dry climate shrub","146":"SH146 | Low load humid climate shrub","147":"SH147 | Very high load dry climate shrub","148":"SH148 | High load humid climate shrub","149":"SH149 | Very high load humid climate shrub","161":"TU161 | Ligh load dry climate timber-grass-shrub","162":"TU162 | Moderate load humid climate timber-shrub","163":"TU163 | Moderate load humid climate timber-grass-shrub","164":"TU164 | Dwarf conifer with understory","165":"TU165 | Very high load dry climate timber-shrub","181":"TL181 | Low load compact conifer litter","182":"TL182 | Low load broadleaf litter","183":"TL183 | Moderate load conifer litter","184":"TL184 | Small downed logs","185":"TL185 | High load conifer litter","186":"TL186 | Moderate load broadleaf litter","187":"TL187 | Large downed logs","188":"TL188 | Long-needle litter","189":"TL189 | Very high load broadleaf litter","201":"SB201 | Low load activity fuel","202":"SB202 | Moderate load activ. fuel or low load blowdown","203":"SB203 | High load activ. fuel or mod. load blowdown","204":"SB204 | High load blowdown"},colors:{"106":"#C25283","162":"#00FF00"}};Gmi.Data.Stations=[[0,OpenLayers.i18n("Custom data")],[260,"De Bilt"],[275,"Deelen"],[283,"Hupsel"],[375,"Volkel"]];Gmi.Services.WPS={url:"/geoserver/ows?",request:function(b){var a=Ext.extend({url:"/geoserver/ows?",params:{service:"WPS",version:"1.1.0",request:"execute",identifier:"py:wildfire_makesubset",datainputs:combineParams({userid:Gmi.Session.userid,name:"test",left:bounds.left,lower:bounds.bottom,right:bounds.right,upper:bounds.top},";"),RawDataOutput:"string",mimeType:"application/json"}},b);Ext.Ajax.Request(a)}};var WeatherRecord=new Ext.data.Record.create([{name:"station",type:"int"},{name:"date",type:"date"},{name:"precipitation",type:"float"},{name:"wind",type:"float"},{name:"windrichting",type:"int"},{name:"hour1",type:"int"},{name:"hour2",type:"int"},{name:"tmin",type:"float"},{name:"tmax",type:"float"},{name:"hmin",type:"float"},{name:"hmax",type:"float"},{name:"isModified",type:"int"}]);var WindRecord=new Ext.data.Record.create([{name:"station",type:"int"},{name:"date",type:"date"},{name:"time",type:"time",timeFormat:"H:i"},{name:"speed",type:"float"},{name:"direction",type:"float"},{name:"cloudiness",type:"float"},{name:"isModified",type:"int"}]);var TerrainFeatureRecord=new GeoExt.data.FeatureRecord.create([{name:"landscape_name",type:"string"},{name:"started",type:"date"}]);function stringToFloat(a){var b=parseFloat(a);if(isNaN(b)){b=0}return b}function parseWeatherData(f,m,b){var e={};var n=f.split("\n").filter(function(d){return d.length>0&&!d.startsWith("#")});for(var g=0;g<n.length;g++){var k=n[g].split(/[,\s]+/g).filter(function(d){return d.length>0});var h=k[1];e[h]={station:k[0],date:Date.parseDate(h,"Ymd"),tmin:parseFloat(k[2])/10,hour1:parseInt(k[3]),tmax:parseFloat(k[4])/10,hour2:parseInt(k[5]),hmin:parseFloat(k[6]),hmax:parseFloat(k[8]),precipitation:Math.max(0,stringToFloat(k[10]))/10,wind:stringToFloat(k[11])/10,windrichting:parseFloat(k[12]),isModified:0}}var j=Date.parseDate(m,"Ymd");var a=Date.parseDate(b,"Ymd").valueOf();var l=j.dateFormat("Ymd");j.increment(1);while(j.valueOf()<=a){h=j.dateFormat("Ymd");if(!e[h]&&e[l]){e[h]=OpenLayers.Util.applyDefaults({date:Date.parseDate(h,"Ymd"),isModified:1},e[l]);console.log("stationgegevens kopie van dag ervoor",e[h])}l=h;j.increment(1)}var c=[];for(var h in e){c.push(e[h])}return c}function requestWeatherData(b,f,a){console.log("requestWeatherData",b,f,a);var e="TN:TNH:TX:TXH:UN:UNH:UX:UXH:RH:FHVEC:DDVEC";var c=OpenLayers.Request.GET({url:"http://www.knmi.nl/klimatologie/daggegevens/getdata_dag.cgi",async:false,params:{stns:b,vars:e,start:f,end:a},success:function(g){},failure:function(g){console.log("request failure",arguments)}});var d=[];if(c.status==200){d=parseWeatherData(c.responseText,f,a)}else{alert(OpenLayers.i18n("Failure: ${msg} (status ${status})",{status:c.status,msg:c.responseText}))}return d}function storeWeatherData(c,e){var b=c+"_station";var d=localStorage[b];if(d){d=JSON.parse(d)}else{d={}}for(var a=0;a<e.length;a++){d[e[a].date.dateFormat("Ymd")]=e[a]}localStorage[b]=JSON.stringify(d)}function storeWindData(c,e){var b=c+"_wind";var d=localStorage[b];if(d){d=JSON.parse(d)}else{d={}}for(var a=0;a<e.length;a++){d[e[a].date.dateFormat("YmdHi")]=e[a]}localStorage[b]=JSON.stringify(d)}function weatherDataToRecords(f,h){var c=[];var a="00000000";var b={};for(var e=0;e<h.length;e++){var g=h[e];var d=g.date.dateFormat("Ymd");if(d>a){a=d;b=g}c.push(new WeatherRecord(g,d))}if(c.length>0&&f!==a){c.push(new WeatherRecord(OpenLayers.Util.applyDefaults({date:Date.parseDate(f,"Ymd"),isModified:1},b),f))}return c}function windDataToRecords(f,h){var c=[];var a="000000000000";var b={};for(var e=0;e<h.length;e++){var g=h[e];var d=g.date.dateFormat("YmdHi");if(d>a){a=d;b=g}c.push(new WindRecord(g,d))}if(c.length>0&&f!==a){c.push(new WindRecord(OpenLayers.Util.applyDefaults({date:Date.parseDate(f,"YmdHi"),isModified:1},b),f))}return c}function getClimateData(s){var f=Ext.getCmp("model_date").getValue();var c=f.dateFormat("Ymd");var b=new Date(f);b.increment(-Gmi.Settings.weatherDaysBefore);var r=b.dateFormat("Ymd");var k=[];var t=s+"_station";var p=localStorage[t];if(p){p=JSON.parse(p);var n=parseInt(c)-parseInt(r)+1;var e=0;var q=new Date().clearTime();var a=q.dateFormat("Ymd");if(p[r]){var o=Date.parseDate(r,"Ymd");var l=Date.parseDate(c,"Ymd");while(o.getTime()<=l.getTime()){var m=o.dateFormat("Ymd");if(p[m]){p[m]["date"]=new Date(p[m]["date"]);k.push(p[m]);if(s>0&&p[m]["date"].valueOf()<q.valueOf()&&p[m]["isModified"]===1){e+=1}}else{}n-=1;o.increment(+1)}if(e===0&&(n===0||(n===1&&l.dateFormat("Ymd")==a))){console.log("all climate data from local storage",k);return weatherDataToRecords(c,k)}}}if(s===0){k=[];var o=Date.parseDate(r,"Ymd");var l=Date.parseDate(c,"Ymd");while(o<=l){var m=o.dateFormat("Ymd");k.push({station:s,date:Date.parseDate(m,"Ymd"),tmin:Gmi.Settings.weatherDefaults.tmin,hour1:5,tmax:Gmi.Settings.weatherDefaults.tmax,hour2:14,hmin:Gmi.Settings.weatherDefaults.hmin,hmax:Gmi.Settings.weatherDefaults.hmax,precipitation:Gmi.Settings.weatherDefaults.precipitation,wind:0,windrichting:0,isModified:1});o.increment(+1)}}else{var p=requestWeatherData(s,r,c);for(var h=0;h<p.length;h++){if(p[h].isModified){for(var g=0;g<k.length;g++){if(p[h].date.dateFormat("Ymd")===k[g].date.dateFormat("Ymd")){p[h]=k[g];break}}}}k=p}storeWeatherData(s,k);return weatherDataToRecords(c,k)}function getWindData(k){var m=getModelDateTime();var b=new Date(m);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);var j=b.dateFormat("YmdHi");var d=new Date(b);d.increment(Gmi.Settings.windHours/24);var c=d.dateFormat("YmdHi");var l=k+"_wind";var h=localStorage[l];if(h){h=JSON.parse(h)}else{h={}}var f=[];var a=b.dateFormat("YmdHi");f.push(h[a]?h[a]:{station:k,date:b,time:zpad(b.getHours(),2)+":00",speed:Gmi.Settings.weatherDefaults.speed,direction:Gmi.Settings.weatherDefaults.direction,cloudiness:Gmi.Settings.weatherDefaults.cloudiness,isModified:1});for(var e=1;e<=Gmi.Settings.windHours;e++){var g=new Date(b);g.increment(e/24);a=g.dateFormat("YmdHi");f.push(h[a]?h[a]:{station:k,date:g,time:zpad(g.getHours(),2)+":00",speed:Gmi.Settings.weatherDefaults.speed,direction:Gmi.Settings.weatherDefaults.direction,cloudiness:Gmi.Settings.weatherDefaults.cloudiness,isModified:1})}for(var e=0;e<f.length;e++){if(typeof f[e].date=="string"){f[e].date=new Date(f[e].date)}}storeWindData(k,f);return windDataToRecords(c,f)}Gmi.makeSubset=function(){var e=mapPanel.map;var d=e.getLayersByName("_boxes_");if(d.length>0){var b=d[0].markers.length>0?d[0].markers[0].bounds:null;if(!b||!b.left){alert(OpenLayers.i18n("Select region first"))}else{var a=Ext.getCmp("btn_select_region");if(a.pressed){a.control.box.deactivate();e.removeControl(a.control);a.doToggle()}Gmi.Session.box=b;var c={service:"WPS",version:"1.1.0",request:"execute",identifier:"py:wildfire_makesubset",datainputs:combineParams({userid:Gmi.Session.userid,name:"test",left:b.left,lower:b.bottom,right:b.right,upper:b.top},";"),RawDataOutput:"string",mimeType:"application/json"};if(Gmi.Settings.debug){if(!confirm(OpenLayers.i18n("Subset parameters: \n\n${params}",{params:JSON.stringify(c,null,2)}))){return}}startProgress(OpenLayers.i18n("Preparing terrain"));Ext.Ajax.request({url:"/geoserver/ows?",params:c,extraParams:{count:0},on_finished:function(f){Ext.getCmp("fuelmodel_name").setValue(OpenLayers.i18n("untitled"));Gmi.Session.fuelid=null;f.subset_name="model_wildfire:terrein_"+f.runid;showTerrein(e,f.runid,f.subset_name)},success:wpsSuccessCallback,failure:wpsFailureCallback})}}};var weatherColumnModel=new Ext.grid.ColumnModel({defaults:{sortable:true,width:100,align:"right",format:"000.0",editable:true,xtype:"numbercolumn"},columns:[{header:"Station",dataIndex:"station",hidden:true,format:"000"},{header:"Date",dataIndex:"date",width:100,align:"right",format:Gmi.Settings.dateFormat,xtype:"datecolumn"},{header:"Tmin (°C)",format:"00.0",editable:true,editor:new Ext.form.NumberField({allowBlank:false,decimalSeparator:Gmi.Settings.decimalSeparator,minValue:0,maxValue:50,maxLength:4}),dataIndex:"tmin"},{header:"Tmax (°C)",format:"00.0",editable:true,editor:new Ext.form.NumberField({allowBlank:false,minValue:0,maxValue:50,decimalSeparator:Gmi.Settings.decimalSeparator,maxLength:4}),dataIndex:"tmax"},{header:"RVmin (%)",format:"000",editable:true,editor:new Ext.form.NumberField({allowBlank:false,maxLength:3,minValue:0,maxValue:100}),dataIndex:"hmin"},{header:"RVmax (%)",format:"000",editable:true,editor:new Ext.form.NumberField({allowBlank:false,maxLength:3,minValue:0,maxValue:100}),dataIndex:"hmax"},{header:"Rainfall",format:"000.0",editable:true,editor:new Ext.form.NumberField({allowBlank:false,maxLength:5,decimalSeparator:Gmi.Settings.decimalSeparator,minValue:0,maxValue:100}),dataIndex:"precipitation"},{header:"Wind",format:"000.0",editable:true,hidden:true,editor:new Ext.form.NumberField({allowBlank:false,decimalSeparator:Gmi.Settings.decimalSeparator,maxLength:5,minValue:0}),dataIndex:"wind"},{header:"Windrichting",format:"000",editable:true,hidden:true,editor:new Ext.form.NumberField({allowBlank:false,maxLength:3,minValue:0,maxValue:360}),dataIndex:"windrichting"},{header:OpenLayers.i18n("Is modified?"),format:"0",editable:false,hidden:!Gmi.Settings.debug,editor:new Ext.form.NumberField({allowBlank:false,maxLength:1,minValue:0,maxValue:1}),dataIndex:"isModified"}]});var windColumnModel=new Ext.grid.ColumnModel({defaults:{sortable:true,width:100,align:"right"},columns:[{header:OpenLayers.i18n("Station"),dataIndex:"station",hidden:true,format:"000"},{header:OpenLayers.i18n("Date"),dataIndex:"date",width:100,align:"right",format:Gmi.Settings.dateFormat,xtype:"datecolumn"},{header:OpenLayers.i18n("Time"),dataIndex:"time",format:"H:i",align:"right",editable:false},{header:OpenLayers.i18n("Speed (m/s)"),format:"00.0",editable:true,editor:new Ext.form.NumberField({allowBlank:false,decimalSeparator:Gmi.Settings.decimalSeparator,minValue:0,maxLength:4}),dataIndex:"speed",xtype:"numbercolumn"},{header:OpenLayers.i18n("Direction (&deg;)"),format:"000",editable:true,editor:new Ext.form.NumberField({allowBlank:false,maxLength:3,minValue:0,maxValue:360}),dataIndex:"direction",xtype:"numbercolumn"},{header:OpenLayers.i18n("Cloudiness (%)"),format:"000",editable:true,editor:new Ext.form.NumberField({allowBlank:false,maxLength:3,minValue:0,maxValue:100}),dataIndex:"cloudiness",xtype:"numbercolumn"},{header:OpenLayers.i18n("Is modified?"),format:"0",editable:false,hidden:!Gmi.Settings.debug,editor:new Ext.form.NumberField({allowBlank:false,maxLength:1,minValue:0,maxValue:1}),dataIndex:"isModified"}]});Ext.data.LocalStorageWriter=Ext.extend(Ext.data.DataWriter,{encode:true,encodeDelete:false,constructor:function(a){Ext.data.LocalStorageWriter.superclass.constructor.call(this,a)},createRecord:function(a){console.log("createRecord",a);return this.toHash(a)},updateRecord:function(a){console.log("updateRecord",a);Ext.apply(this,{meta:{idProperty:"id"}});if(a instanceof WeatherRecord){storeWeatherData(a.data.station,[a.data])}else{if(a instanceof WindRecord){storeWindData(a.data.station,[a.data])}else{alert("Interne fout: onbekend record type")}}return this.toHash(a)},destroyRecord:function(b){if(this.encodeDelete){var a={};a[this.meta.idProperty]=b.id;return a}else{return b.id}}});var weatherStore=new Ext.data.Store({id:"weatherStore",autoSave:false,recordType:WeatherRecord,sortInfo:{field:"date",direction:"DESC"},reader:{idProperty:"id",root:"results",readRecords:function(){if(weatherStore.modified.length>0){console.log("modified",weatherStore.modified);var d=[];for(var b=0;b<weatherStore.modified.length;b++){d.push(weatherStore.modified[b].data)}for(var b=0;b<d.length;b++){d[b].isModified=1}storeWeatherData(d[0].station,d)}var c=Ext.getCmp("weatherstation");var a=getClimateData(c.value);if(a){weatherGrid.setTitle(OpenLayers.i18n("Weather characteristics - ${name}",{name:c.lastSelectionText}))}return{records:a}}},writer:new Ext.data.LocalStorageWriter({})});weatherStore.proxy={request:Ext.emptyFn};var windStore=new Ext.data.Store({id:"windStore",autoSave:false,recordType:WindRecord,sortInfo:{field:"date",direction:"ASC"},reader:{idProperty:"id",root:"results",readRecords:function(){if(windStore.modified.length>0){console.log("modified",windStore.modified);var d=[];for(var b=0;b<windStore.modified.length;b++){d.push(windStore.modified[b].data)}for(var b=0;b<d.length;b++){d[b].isModified=1}storeWindData(d[0].station,d)}var c=Ext.getCmp("weatherstation");var a=getWindData(c.value);return{records:a}}},writer:new Ext.data.LocalStorageWriter({})});windStore.proxy={request:Ext.emptyFn};var weatherGrid=new Ext.grid.EditorGridPanel({id:"weathergrid",title:OpenLayers.i18n("Weather characteristics"),header:false,store:weatherStore,clicksToEdit:1,viewConfig:{forceFit:true},cm:weatherColumnModel});var windGrid=new Ext.grid.EditorGridPanel({id:"windgrid",title:OpenLayers.i18n("Wind characteristics"),header:false,loadMask:true,store:windStore,clicksToEdit:1,viewConfig:{forceFit:true},cm:windColumnModel});var weathersettingsWindow=new Ext.Window({id:"weathersettingsWindow",title:OpenLayers.i18n("Weather settings"),width:600,height:400,closable:true,closeAction:"hide",autoScroll:true,hideable:true,resizable:true,draggable:true,modal:true,plain:true,defaults:{},items:[new Ext.form.ComboBox({id:"weatherstation2",fieldLabel:OpenLayers.i18n("Weather station"),name:"station",typeAhead:true,triggerAction:"all",lazyRender:true,anchor:"100%",region:"north",mode:"local",value:Gmi.Settings.weatherDefaults.station,forceSelection:true,editable:false,store:new Ext.data.ArrayStore({id:0,fields:["id","naam"],data:Gmi.Data.Stations}),valueField:"id",displayField:"naam",listeners:{select:function(a,b){Ext.getCmp("weatherstation").setValue(b.data.id);weatherStore.loadData();windStore.loadData();console.log("select weather station",arguments);Gmi.updateUserDefaults({station:b.data.id})}}}),new Ext.TabPanel({renderTo:Ext.getBody(),activeTab:0,region:"center",defaults:{height:300},items:[{title:OpenLayers.i18n("Weather"),layout:"fit",items:[weatherGrid]},{title:OpenLayers.i18n("Wind"),layout:"fit",items:[windGrid]}]})],buttons:[{text:OpenLayers.i18n("Close"),handler:function(){if(weatherStore.modified.length>0){weatherStore.save()}weathersettingsWindow.hide()}}]});weathersettingsWindow.hide();Gmi.getSortedStoreData=function(a){var b=a.getRange().sort(function(d,c){return d.data.date.valueOf()-c.data.date.valueOf()});return b};Gmi.checkModelDateInStoreData=function(b){var c=Gmi.getSortedStoreData(b);if(c.length>0){var a=getModelDateTime();if(a.valueOf()<c[0].data.date.valueOf()||a.valueOf()>c[c.length-1].data.date.valueOf()){return false}}return true};function showClimateData(){if(!Gmi.checkModelDateInStoreData(weatherStore)){weatherStore.clearData();console.log("model_date valt buiten data range voor weatherStore")}if(!Gmi.checkModelDateInStoreData(windStore)){windStore.clearData();console.log("model_date valt buiten data range voor windStore")}weathersettingsWindow.show();if(weatherStore.getRange().length===0){weatherStore.loadData()}if(windStore.getRange().length===0){windStore.loadData()}weatherGrid.startEditing(0,0);windGrid.startEditing(0,0)}function not_implemented(){Ext.Msg.show({title:OpenLayers.i18n("Information"),msg:OpenLayers.i18n("Not implemented yet"),width:400,height:400,buttons:Ext.MessageBox.OK})}var mapPanel,tree;var status;Ext.onReady(function(){var c;translateDom();Ext.QuickTips.init();Gmi.defineTerrainWfsGrid=function(){var z=mapPanel.map;var y=z.getLayersByName("wfs_vector_landscapes");if(y.length>0){var A=y[0]}else{var A=new OpenLayers.Layer.Vector("wfs_vector_landscapes",{displayInLayerSwitcher:Gmi.Settings.debug,visibility:false,styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:"#aaaaaa",fillOpacity:0.2,strokeColor:"#888888",strokeOpacity:0.4}),select:new OpenLayers.Style({fillColor:"#ff8800",fillOpacity:0.6,strokeColor:"#ff0000",strokeOpacity:0.6,strokeWidth:"3px",display:"visible"})})});mapPanel.map.addLayer(A)}var x=new GeoExt.data.FeatureStore({layer:A,reader:new GeoExt.data.FeatureReader({},TerrainFeatureRecord),proxy:new GeoExt.data.ProtocolProxy({protocol:new OpenLayers.Protocol.WFS({url:"/geoserver/ows",version:"1.1.0",featureType:"landscapes",featureNS:"model_wildfire",srsName:"EPSG:900913"})}),autoLoad:true});console.log("Store",x);gridPanel=new Ext.grid.GridPanel({title:OpenLayers.i18n("Feature Grid"),region:"east",header:false,store:x,width:200,height:200,columns:[{header:OpenLayers.i18n("Name"),width:100,sortable:true,dataIndex:"landscape_name"},{header:OpenLayers.i18n("Time"),width:100,sortable:true,xtype:"datecolumn",format:Gmi.Settings.datetimeFormat,dataIndex:"started"}],sm:new GeoExt.grid.FeatureSelectionModel({autoPanMapOnSelection:false,singleSelect:true})});gridPanel.store.bind(A);gridPanel.getSelectionModel().bind(A);gridPanel.getSelectionModel().on("rowdeselect_NIET",function(B,D,C){console.log("rowdeselect",C.data.feature);Gmi.Session.fuelid=null;Gmi.Session.datetime=null;showTerrein(mapPanel.map,null);setBox(mapPanel.map,null)});gridPanel.getSelectionModel().on("rowselect",function(G,J,M){console.log("rowselect",M.data.feature);var K=M.data.feature.geometry;var C=K.getCentroid();var B=K.getBounds();setBox(mapPanel.map,B);var I=new Date(M.data.feature.attributes.started);Gmi.Session.datetime=I;var L=mapPanel.map.getZoomForExtent(B);if(L>Gmi.Settings.maxZoomOnMoveToTerrain){L=Gmi.Settings.maxZoomOnMoveToTerrain}mapPanel.map.moveTo(new OpenLayers.LonLat(C.x,C.y),L);Ext.getCmp("fuelmodel_name").setValue(M.data.feature.attributes.landscape_name);Gmi.Session.fuelid=M.data.feature.attributes.landscape_id;setModelDateTime(I);showTerrein(mapPanel.map,M.data.feature.attributes.terrein_id);var D=M.data.feature.layer.map;var F=D.getLayersByName(OpenLayers.i18n("KNMI Neerslagradar"));if(F.length>0){var E=new Date(I.getTime()-I.getTime()%(5*60*1000));console.log("tijd afgerond voor neerslagradar",E);var H=F[0];H.mergeNewParams({time:E.toISOString()})}},gridPanel);return gridPanel};Gmi.invalidateTerrainWfsGrid=function(){var x=Ext.getCmp("subset-fieldset");if(x.items.length>0){x.items.clear()}if(!x.collapsed){Gmi.defineTerrainWfsGrid()}};var t=new OpenLayers.Layer.Vector("Wildfire lines",{displayInLayerSwitcher:Gmi.Settings.debug,styleMap:new OpenLayers.StyleMap({temporary:OpenLayers.Util.applyDefaults({pointRadius:5,strokeWidth:3,strokeOpacity:1,strokeColor:"#ff0000"},OpenLayers.Feature.Vector.style.temporary),"default":OpenLayers.Util.applyDefaults({pointRadius:5,strokeWidth:3,strokeColor:"#ff0000"},OpenLayers.Feature.Vector.style["default"]),select:OpenLayers.Util.applyDefaults({pointRadius:5,strokeWidth:3},OpenLayers.Feature.Vector.style.select)}),eventListeners:{beforefeatureadded:function(x){x.object.removeAllFeatures();return true},featureadded:function(x){console.log("featureadded",x.feature)},scope:t}});var k=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{immediate:true,persist:true,displayClass:"olControlMeasure",title:OpenLayers.i18n("Measure distances in map"),handlerOptions:{layerOptions:{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3}}})]})})}}});k.getCustomLength=function(y,B){var x=y.geometry.components.length;if(x<2){return""}var C="";if(x>=2){C=OpenLayers.i18n("Distance: ${distance} ${units}",{distance:y.units==="km"?y.measure.toFixed(3):y.measure.toFixed(1),units:y.units})}if(!B&&x>2){var A=new OpenLayers.Geometry.LineString([y.geometry.components[x-2],y.geometry.components[x-1]]);var z=this.getBestLength(A);C+="<br/>Last segment: "+(z[1]==="km"?z[0].toFixed(3):z[0].toFixed(1))+" "+z[1]}return C};k.events.on({deactivate:function(x){console.log("deactivate",x);measureTip.hide()},measure:function(x){console.log("measure",x);var y=k.getCustomLength(x,true);measureTip.show(y);console.log("afstand",y)},measurepartial:function(x){console.log("measurepartial",x);var y=k.getCustomLength(x,false);measureTip.show(y);console.log("afstand",y)}});var m=new OpenLayers.Control.Panel({displayClass:"olControlEditingToolbar",activateControl:function(x){console.log("activate control",x);if(x.CLASS_NAME==="OpenLayers.Control.ModifyFeature"){if(x.layer.features.length>0){x.selectFeature(x.layer.features[0])}}return OpenLayers.Control.Panel.prototype.activateControl.apply(this,[x])}});m.addControls([new OpenLayers.Control({displayClass:"olControlNavigation",title:OpenLayers.i18n("Navigate in map")}),k,new OpenLayers.Control.ModifyFeature(t,{vertexRenderIntent:"temporary",displayClass:"olControlModifyFeature",title:OpenLayers.i18n("Modify existing fire line")}),new OpenLayers.Control.DrawFeature(t,OpenLayers.Handler.Path,{displayClass:"olControlDrawFeaturePath",title:OpenLayers.i18n("Draw new fire line")})]);var f,d,l,n;n=[new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:true}}),new OpenLayers.Control.Zoom({title:OpenLayers.i18n("Change zoom")}),new OpenLayers.Control.ScaleLine({bottomOutUnits:"",bottomInUnits:"",title:OpenLayers.i18n("Scale line")}),m];n.push(f=new OpenLayers.Control.NavigationHistory({previousOptions:{title:OpenLayers.i18n("Restore previous extent")},nextOptions:{title:OpenLayers.i18n("Restore next extent")}}));if(false){n.push(d=new Gmi.Control.SessionHistory({previousOptions:{title:OpenLayers.i18n("Restore previous session")},nextOptions:{title:OpenLayers.i18n("Restore next session")}}))}var w={allOverlays:false,displayProjection:"EPSG:4326",projection:new OpenLayers.Projection("EPSG:900913"),units:"meters",controls:n,resolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135,0.29858214169740677,0.14929107084870338,0.07464553542435169,0.037322767712175846,0.018661383856087923,0.009330691928043961,0.004665345964021981,0.0023326729820109904,0.0011663364910054952,0.0005831682455027476,0.0002915841227513738,0.0001457920613756869],maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),theme:null};mapPanel=new GeoExt.MapPanel({border:true,region:"center",map:new OpenLayers.Map(w),center:new OpenLayers.LonLat(5.946197509765718,52.20750576821061).transform("EPSG:4326","EPSG:900913"),zoom:10,layers:[new OpenLayers.Layer(OpenLayers.i18n("Geen achtergrondlaag"),{isBaseLayer:true}),new OpenLayers.Layer.OSM(),new OpenLayers.Layer.WMS(OpenLayers.i18n("Topography"),"/geoserver/wms?",{layers:"nl_data:terrein",format:"image/png",transparent:true,tiled:true},{isBaseLayer:true,visibility:false,transitionEffect:"resize"}),new OpenLayers.Layer.WMS(OpenLayers.i18n("KNMI Neerslagradar"),"http://geoservices.knmi.nl/cgi-bin/RADNL_OPER_R___25PCPRR_L3.cgi?",{layers:"RADNL_OPER_R___25PCPRR_L3_COLOR",transparent:true,format:"image/png"},{visibility:false,opacity:0.6,singleTile:true,transitionEffect:"resize",legend:{url:"img/NeerslagradarLegend.png"}}),t,new OpenLayers.Layer.Boxes("_boxes_",{displayInLayerSwitcher:Gmi.Settings.debug})]});var l=new OpenLayers.Control.Panel({displayClass:"olControlCustomToolbar"});var o=[];if(d){o.push(d.next);o.push(d.previous)}if(f){o.push(f.next);o.push(f.previous)}l.addControls(o);mapPanel.map.addControl(l);var v=Ext.extend(GeoExt.tree.LayerNodeUI,new GeoExt.tree.TreeNodeUIEventMixin());var b=[{nodeType:"gx_baselayercontainer",expanded:true},{nodeType:"gx_overlaylayercontainer",expanded:true,loader:{baseAttrs:{radioGroup:"foo",uiProvider:"layernodeui"}}}];var h=[];if(Gmi.Settings.debug){h.push({text:OpenLayers.i18n("Show translations"),handler:Gmi.Data.showTranslations});h.push({text:OpenLayers.i18n("Clear weather data"),handler:function(){if(confirm(OpenLayers.i18n("All weather data will be cleared. Are you sure?"))){localStorage.clear();weatherStore.clearData();windStore.clearData()}}})}tree=new Ext.tree.TreePanel({border:true,region:"west",title:OpenLayers.i18n("Layers"),width:240,split:true,collapsible:true,collapseMode:"mini",autoScroll:true,plugins:[],loader:new Ext.tree.TreeLoader({applyLoader:false,uiProviders:{layernodeui:v}}),root:{nodeType:"async",children:b},listeners:{click:function(y,x){if(jQuery(x.target).hasClass("gx-tree-layer-icon")){console.log("toggle legendgraphic",y);if(jQuery(".g-legendgraphic",x.target.parentNode.parentNode).length>=1){jQuery(".g-legendgraphic",x.target.parentNode.parentNode).remove()}else{if(y.layer.CLASS_NAME==="OpenLayers.Layer.WMS"){var z;if(y.layer.legend&&y.layer.legend.url){z=y.layer.legend.url}else{z=y.layer.url+"SERVICE=WMS&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+y.layer.params.LAYERS}jQuery(x.target.parentNode.parentNode).append('<div class="g-legendgraphic"><img src="'+z+'"></img></div>')}}}},radiochange:function(x){alert(OpenLayers.i18n("${layerName} is now the active layer.",{layerName:x.layer.name}))}},rootVisible:false,lines:false,bbar:h,bbarCfg:{layout:"fit",defaults:{anchor:"100%"}}});var j=new Ext.Panel({title:OpenLayers.i18n("Simulation model"),contentEl:document.getElementById("model"),region:"east",bodyStyle:{padding:"0px"},collapsible:true,collapseMode:"mini",autoScroll:true,split:true,width:250,layout:"auto",items:[new Ext.form.FormPanel({title:OpenLayers.i18n("Step 1 - Location"),id:"farsitepanel1",collapsible:true,labelWidth:40,labelAlign:"left",monitorValid:true,layout:{type:"form",align:"center"},defaults:{style:"margin: 5px"},items:[{xtype:"fieldset",title:OpenLayers.i18n("Select area"),defaults:{width:"inherited"},items:[{xtype:"panel",defaults:{width:150,style:"margin: 0px;"},id:"terreinpanel1",border:false},{xtype:"numberfield",id:"terrein_id",name:"terrein_id",fieldLabel:OpenLayers.i18n("Terrein ID"),width:40,disabled:true,hidden:true,value:"0"},new Ext.Button({text:OpenLayers.i18n("Select region"),id:"btn_select_region",enableToggle:true,tooltip:OpenLayers.i18n("Select region by dragging a rectangle in the map"),handler:function(x,A){console.log("select region handler",x.pressed);var z=mapPanel.map;if(x.pressed){var y=new OpenLayers.Control();x.control=y;OpenLayers.Util.extend(y,{draw:function(){var B=new OpenLayers.Handler.Box(y,{done:this.notice},{moveBox:function(M){OpenLayers.Handler.Box.prototype.moveBox.apply(B,[M]);var F=B.dragHandler.start;var J=Math.min(F.y,M.y);var D=Math.max(F.y,M.y);var G=Math.min(F.x,M.x);var L=Math.max(F.x,M.x);C=new OpenLayers.Bounds(G,D,L,J);var K=z.getLonLatFromPixel(new OpenLayers.Pixel(C.left,C.bottom));var H=z.getLonLatFromPixel(new OpenLayers.Pixel(C.right,C.top));var C=new OpenLayers.Bounds(K.lon.toFixed(0),K.lat.toFixed(0),H.lon.toFixed(0),H.lat.toFixed(0));var I=C.toGeometry();var E=I.getArea();console.log("moveBox",C,E,E>Gmi.Settings.maxArea?"TOO LARGE":"");measureTip.show(E>Gmi.Settings.maxArea?OpenLayers.i18n("Too large"):OpenLayers.i18n("Area ${area}",{area:areaWithUnit(E)}))}});this.box=B;this.box.activate()},notice:function(D){var E=z.getLonLatFromPixel(new OpenLayers.Pixel(D.left,D.bottom));var F=z.getLonLatFromPixel(new OpenLayers.Pixel(D.right,D.top));var D=new OpenLayers.Bounds(E.lon.toFixed(0),E.lat.toFixed(0),F.lon.toFixed(0),F.lat.toFixed(0));var B=D.toGeometry();var C=B.getArea();if(C>Gmi.Settings.maxArea){alert(OpenLayers.i18n("Area ${area} is too large; the maximum is ${max}",{max:areaWithUnit(Gmi.Settings.maxArea),area:areaWithUnit(C)}))}else{console.log("area",C);setBox(z,D);x.control.box.deactivate();z.removeControl(x.control);x.doToggle();Gmi.makeSubset()}}});mapPanel.map.addControl(y)}else{x.control.box.deactivate();z.removeControl(x.control)}},cls:"g-actie-knop"})]},{xtype:"fieldset",title:OpenLayers.i18n("Terrain"),defaults:{width:"inherited"},items:[new Ext.Button({text:OpenLayers.i18n("Edit"),id:"btn_edit_terrain",formBind:true,enableToggle:true,tooltip:OpenLayers.i18n("Edit the land use"),handler:function(x,z){var y=mapPanel.map;if(x.pressed){if(!start_edit_subset(y)){x.doToggle()}}else{stop_edit_subset(y)}},cls:"g-actie-knop"}),{fieldLabel:OpenLayers.i18n("Name"),xtype:"textfield",id:"fuelmodel_name",name:"fuelmodel_name",tooltip:OpenLayers.i18n("Name of terrain"),anchor:"100%",width:120,align:"right",value:OpenLayers.i18n("untitled")},new Ext.Button({text:OpenLayers.i18n("Save"),formBind:true,tooltip:OpenLayers.i18n("Create landscape file on the base of currently selected region"),handler:function(){var x=mapPanel.map;stop_edit_subset(x);var z=Gmi.Session.terreinid;var y=Ext.getCmp("fuelmodel_name").getValue();if(!z){alert(OpenLayers.i18n("Landscape file cannot be prepared yet."))}else{startProgress(OpenLayers.i18n("Preparing fuel model"));Ext.Ajax.request({url:"/geoserver/ows?",params:{service:"WPS",version:"1.1.0",request:"execute",identifier:"py:wildfire_makelcp",datainputs:combineParams({userid:Gmi.Session.userid,terreinid:z,landscapename:y},";"),RawDataOutput:"string",mimeType:"application/json"},extraParams:{count:0},on_finished:function(A){Gmi.Session.fuelid=A.runid;Gmi.invalidateTerrainWfsGrid()},success:wpsSuccessCallback,failure:wpsFailureCallback})}},cls:"g-actie-knop"})]}]}),new Ext.form.FormPanel({title:OpenLayers.i18n("Step 2 - Inputs"),collapsible:true,defaults:{style:"margin: 5px"},items:[{xtype:"fieldset",id:"subset-fieldset",title:OpenLayers.i18n("Saved terrains"),defaults:{width:"inherited"},collapsible:true,collapsed:true,items:[],listeners:{beforeexpand:function(x,z){if(x.items.length==0){var y=Gmi.defineTerrainWfsGrid();x.add(y)}}}},{xtype:"fieldset",title:OpenLayers.i18n("Date & time"),defaults:{width:"inherited"},items:[{xtype:"datefield",id:"model_date",fieldLabel:OpenLayers.i18n("Date"),anchor:"100%",format:Gmi.Settings.dateFormat,forceSelection:true,editable:false},{xtype:"timefield",id:"model_time",fieldLabel:OpenLayers.i18n("Time"),anchor:"100%",forceSelection:true,editable:false,increment:Gmi.Settings.tijd_afronding_minuten,format:"H:i"}]},{xtype:"fieldset",title:OpenLayers.i18n("Weather data"),defaults:{width:"inherited"},items:[new Ext.form.ComboBox({id:"weatherstation",fieldLabel:OpenLayers.i18n("Weather station"),name:"station",typeAhead:true,triggerAction:"all",lazyRender:true,anchor:"100%",align:"right",mode:"local",value:Gmi.Settings.weatherDefaults.station,forceSelection:true,editable:false,store:new Ext.data.ArrayStore({id:0,fields:["id","naam"],data:Gmi.Data.Stations}),valueField:"id",displayField:"naam",listeners:{select:function(x,z){var y=x.getValue();Ext.getCmp("weatherstation2").setValue(y);weatherStore.clearData();windStore.clearData();Gmi.updateUserDefaults({station:y})}}}),new Ext.Button({text:OpenLayers.i18n("Set weather data"),handler:showClimateData,cls:"g-actie-knop"})]}]}),new Ext.form.FormPanel({title:OpenLayers.i18n("Step 3 - Run model"),collapsible:true,defaults:{style:"margin: 5px"},items:[{xtype:"fieldset",title:OpenLayers.i18n("Fire location"),defaults:{width:"inherited"},items:[new Ext.Button({text:OpenLayers.i18n("Draw fire line"),handler:drawFireLine,cls:"g-actie-knop"})]},{xtype:"fieldset",title:OpenLayers.i18n("Execution"),defaults:{width:"inherited"},items:[{fieldLabel:OpenLayers.i18n("Name"),xtype:"textfield",id:"fire_name",name:"fire_name",tooltip:OpenLayers.i18n("Name of fire"),anchor:"100%",width:120,align:"right",value:OpenLayers.i18n("untitled")},new Ext.Button({text:OpenLayers.i18n("Start run"),handler:startModelRun,cls:"g-actie-knop"})]}]}),new Ext.form.FormPanel({title:OpenLayers.i18n("Step 4 - Results"),collapsible:true,defaults:{style:"margin: 5px"},items:[{xtype:"fieldset",title:OpenLayers.i18n("Output"),defaults:{width:"inherited"},items:[new Ext.Button({text:OpenLayers.i18n("Download"),handler:function(){var y=mapPanel.map.getLayersByName(OpenLayers.i18n("Brandverspreiding"));if(y.length==0){Ext.MessageBox.show({msg:OpenLayers.i18n("Wild fire layer is missing"),width:300,title:OpenLayers.i18n("Warning")})}else{var x="/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName="+y[0].params.LAYERS+"&maxFeatures=1000&outputFormat=SHAPE-ZIP";Ext.MessageBox.show({msg:'<a href="#" onclick="javascript:Gmi.downloadOnClick(\''+x+"')\">"+OpenLayers.i18n("Click here to download the shapefile")+"</a>",width:300,title:OpenLayers.i18n("Export shape file")})}},cls:"g-actie-knop"})]}]})]});var p=[mapPanel,tree,j];new Ext.Viewport({layout:"fit",hideBorders:true,items:{layout:"border",deferredRender:false,items:p}});var a=Ext.get("show-btn");if(a){a.on("click",function(){if(!c){c=new Ext.Window({applyTo:"hello-win",title:OpenLayers.i18n("Simulation"),layout:"fit",width:500,height:300,closeAction:"hide",plain:true,modal:true,items:new Ext.TabPanel({renderTo:Ext.get("hello-win"),activeTab:0,deferredRender:false,border:false,items:[{xtype:"form",title:OpenLayers.i18n("Gebied"),defaults:{width:150},items:[{xtype:"textfield",fieldLabel:OpenLayers.i18n("Naam gebied")},{xtype:"button",fieldLabel:OpenLayers.i18n("Selecteer gebied"),handler:not_implemented},{xtype:"combo",fieldLabel:OpenLayers.i18n("Choose version"),store:["3.0","2.0","1.0"]},{xtype:"button",fieldLabel:OpenLayers.i18n("Opslaan")}]},{xtype:"form",title:OpenLayers.i18n("Weersomstandigheden"),defaults:{width:150},items:[{xtype:"textfield",fieldLabel:OpenLayers.i18n("Name")},{xtype:"checkbox",fieldLabel:OpenLayers.i18n("Do you love Ext?")},{xtype:"combo",fieldLabel:OpenLayers.i18n("Choose version"),store:["3.0","2.0","1.0"]}]},{xtype:"form",title:OpenLayers.i18n("Tijd"),items:[{xtype:"datefield",fieldLabel:OpenLayers.i18n("Start time"),width:"auto",format:Gmi.Settings.dateFormat},{xtype:"datefield",fieldLabel:OpenLayers.i18n("End time"),width:"auto",format:Gmi.Settings.dateFormat}]}]}),buttons:[{text:"Help",handler:not_implemented},{text:"Annuleren",disabled:true},{text:"Start",handler:not_implemented,handlerX:function(){c.hide()}}]})}c.show(this)})}var e=-1;var s={run:function(){if(Gmi.Session.datetime){return}var z=new Date();var A=z.getHours();var x=z.getMinutes();var y=Math.floor(x/Gmi.Settings.tijd_afronding_minuten)*Gmi.Settings.tijd_afronding_minuten;if(y!==e){Ext.getCmp("model_date").setValue(z);console.log(z.toLocaleTimeString());Ext.getCmp("model_time").setValue(zpad(A,2)+":"+zpad(y,2));e=y}},interval:15000};var g=new Ext.util.TaskRunner();g.start(s);m.activateControl(m.controls[0]);var r=null;if(window.Geodan){r="OpenLayers.Layer.OSM"}else{r="OpenLayers.Layer.WMS"}if(r){var u=mapPanel.map.getLayersBy("isBaseLayer",true);for(var q=0;q<u.length;q++){if(u[q].CLASS_NAME==r){mapPanel.map.setBaseLayer(u[q]);break}}}});function zpad(a,c){var b=Math.round(a)+"";while(b.length<c){b="0"+b}return b}function setModelDateTime(d){Ext.getCmp("model_date").setValue(d);var b=d.getHours();var a=d.getMinutes();var c=zpad(b,2)+zpad(a,2);Ext.getCmp("model_time").setValue(c)}function getModelDateTime(){var a=Ext.getCmp("model_date").getValue();var b=Ext.getCmp("model_time").getValue();a.setHours(b.split(":")[0]);a.setMinutes(b.split(":")[1]);return a}function setBox(d,b){var c=d.getLayersByName("_boxes_");if(c.length>0){c[0].clearMarkers();if(b){var a=new OpenLayers.Marker.Box(b);c[0].addMarker(a)}Gmi.Session.box=b}}function showTerrein(f,c,d){Gmi.Session.terreinid=c;var e=f.getLayersByName("Terrein");if(!c){for(var b=e.length-1;b>=0;b--){f.removeLayer(e[b])}return}if(!d){d="model_wildfire:terrein_"+c}if(e.length>0){e[0].mergeNewParams({layers:d})}else{var a=new OpenLayers.Layer.WMS("Terrein","/geoserver/wms?",{layers:d,transparent:true,format:"image/png"},{isBaseLayer:false,opacity:0.6,legend:{url:"img/TerrainLegend.png"}});f.addLayer(a)}}function weatherStoreAsString(){var p=weatherStore.getRange().sort(function(s,r){return s.data.date.valueOf()-r.data.date.valueOf()});var k="";var a=null;var q;var j,l,h,g,d,n,f,o,b,c;for(var e=0;e<p.length;e++){p[e].data.hour1=500;p[e].data.hour2=1500;p[e].data.precipitation=0;a=new Date(p[e].data.date);j=zpad(a.getMonth()+1,2);l=zpad(a.getDate(),2);h=zpad(p[e].data.precipitation,2);g=zpad(p[e].data.hour1,4);d=zpad(p[e].data.hour2,4);n=zpad(p[e].data.tmin,2);f=zpad(p[e].data.tmax,2);o=zpad(Math.min(99,p[e].data.hmax),2);b=zpad(Math.min(99,p[e].data.hmin),2);c="0000";q=h+","+g+","+d+","+n+","+f+","+o+","+b+","+c;k+="("+j+","+l+","+q+")";if(e<p.length-1){k+=","}}if(a){var m=getModelDateTime();while(m.valueOf()>a.valueOf()){a.increment(+1);j=zpad(a.getMonth()+1,2);l=zpad(a.getDate(),2);k+=",("+j+","+l+","+q+")"}}console.log("weatherString",k);return k}function windStoreAsString(){var e=windStore.getRange().sort(function(o,n){return o.data.date.valueOf()-n.data.date.valueOf()});var f="";var g,h,b,c,l,k;var a=null;if(e.length>0){a=new Date(e[0].data.date);a.increment(+1)}var m;for(var d=0;d<e.length;d++){g=e[d].data.date.getMonth()+1;h=e[d].data.date.getDate();var j=e[d].data.time.split(":");k=zpad(j[0],2)+zpad(j[1],2);b=zpad(e[d].data.speed*3.6,2);c=zpad(e[d].data.direction,3);l=zpad(Math.min(99,e[d].data.cloudiness),2);m=b+","+c+","+l;f+="("+e[d].data.date.dateFormat("m,d,Hi")+","+m+")";if(d<e.length-1){f+=","}}if(a){f+=",("+a.dateFormat("m,d,Hi")+","+m+")"}console.log("windString",f);return f}function drawFireLine(){var c=mapPanel.map;var b=c.getControlsBy("displayClass","olControlEditingToolbar");if(b.length>0){var a=b[0].getControlsByClass("OpenLayers.Control.DrawFeature");if(a.length>0){b[0].activateControl(a[0])}}}function startModelRun(){var b=mapPanel.map;if(!b){alert(OpenLayers.i18n("Interne fout: map is undefined."));return}if(!Gmi.Session.box){alert(OpenLayers.i18n("Region is undefined."));return}if(!Gmi.Session.fuelid){alert(OpenLayers.i18n("Fuel model is undefined."));return}var m=b.getLayersByName("Wildfire lines");if(m.length===0){alert(OpenLayers.i18n("Interne fout: geen vectorlaag voor vuurlijnen"));return}var a=m[0];if(a.features.length===0){alert(OpenLayers.i18n("Draw a fire line first"));return}var h=a.features[0].geometry.clone();for(var c=0;c<h.components.length;c++){h.components[c].transform("EPSG:900913","EPSG:28992")}var e=h.toString();console.log("fire line",e);if(!Gmi.checkModelDateInStoreData(weatherStore)){weatherStore.clearData();console.log("model_date valt buiten data range voor weatherStore")}if(!Gmi.checkModelDateInStoreData(windStore)){windStore.clearData();console.log("model_date valt buiten data range voor windStore")}var l=Ext.getCmp("weatherstation").getValue();var g=weatherStoreAsString();if(g===""){weatherStore.loadData();g=weatherStoreAsString()}var d=windStoreAsString();if(d===""){windStore.loadData();d=windStoreAsString()}var k=Ext.getCmp("model_time").value.replace(":","");if(!k){alert(OpenLayers.i18n("Tijd onbekend"));return}var n=getModelDateTime();var j=Ext.getCmp("fire_name").getValue();var f={service:"WPS",version:"1.1.0",request:"execute",identifier:"py:wildfire_startRun",datainputs:combineParams({userid:Gmi.Session.userid,name:j,fuelmodel:Gmi.Session.fuelid,geom:e,windstring:d,weatherstring:g,startmonth:zpad(n.getMonth()+1,2),startday:zpad(n.getDate(),2),starthour:k},";"),RawDataOutput:"string",mimeType:"application/json"};console.log("run params",f);if(Gmi.Settings.debug){if(!confirm(OpenLayers.i18n("Model parameters: \n\n${params}",{params:JSON.stringify(f,null,2)}))){return}}startProgress(OpenLayers.i18n("Running fire model"));Ext.Ajax.request({url:"/geoserver/ows?",params:f,extraParams:{count:0},on_finished:function(p){Gmi.Session.fireid=p.runid;var r=b.getLayersByName("Brandverspreiding");var o="model_wildfire:result_"+p.runid;if(r.length>0){r[0].mergeNewParams({layers:o})}else{var q=new OpenLayers.Layer.WMS("Brandverspreiding","/geoserver/wms?",{layers:o,transparent:true,format:"image/png"},{isBaseLayer:false,opacity:0.6});b.addLayer(q)}},success:wpsSuccessCallback,failure:wpsFailureCallback})}var wpsFailureCallback=function(a,b){stopProgress();alert(OpenLayers.i18n("WPS failure"))};var wpsSuccessCallback=function(b,c){console.log("wpsSuccessCallback response",b,c);var g=JSON.parse(b.responseText);var d=g.runid;if(g.status==="scheduled"){var f=new Ext.util.TaskRunner();var e=c.extraParams.count+1;var a={interval:1000,run:function(){e=e+1;Ext.Ajax.request({url:"/geoserver/ows?",params:{service:"WPS",version:"1.1.0",request:"execute",identifier:"py:checkModelStatus",RawDataOutput:"string",mimeType:"application/json",datainputs:combineParams({runid:d},";")},extraParams:{count:e},success:function(h,m){var l={};try{var k=h.responseText;l=JSON.parse(k)}catch(j){l.status="error";l.lastmessage=h.responseText}if(l.status==="error"){f.stop(a);stopProgress();console.log("wfs taak ging fout",l);alert(OpenLayers.i18n("WFS process error: ${msg}",{msg:l.lastmessage}))}else{if(l.percentage==100){f.stop(a);stopProgress();console.log("wfs taak is klaar",l);if(c.on_finished){c.on_finished(l)}else{alert(OpenLayers.i18n("Process is ready; results are ignored"))}}else{if(m.extraParams.count>=120){f.stop(a);stopProgress();console.log("wfs taak duurde te lang",l);alert(OpenLayers.i18n("Process takes too long; aborted"))}else{updateProgress(m.extraParams.count,l.percentage);console.log("voortgang",m.extraParams.count,l)}}}},failure:function(){stopProgress();f.stop(a);console.log("WFS process failure",arguments);alert(OpenLayers.i18n("WFS process failure"))}})}};f.start(a)}else{if(g.status==="finished"){stopProgress();if(c.on_finished){c.on_finished(g)}}else{if(g.status==="error"){stopProgress();alert(OpenLayers.i18n("WFS process error: ${msg}",{msg:g.lastmessage}))}else{stopProgress();alert(OpenLayers.i18n("Internal error: unknown return status"))}}}};function startProgress(a){Ext.MessageBox.show({title:OpenLayers.i18n("Please wait"),msg:a,progressText:OpenLayers.i18n("Initializing..."),width:300,wait:true,waitConfig:{interval:200},closable:false})}function updateProgress(b,a){Ext.MessageBox.updateProgress(b,OpenLayers.i18n("${perc}% completed",{perc:Math.round(a)}))}function stopProgress(){Ext.MessageBox.hide()}Gmi.downloadOnClick=function(a){Ext.MessageBox.hide();window.open(a)};Gmi.updateUserDefaults=function(b){var a=localStorage.userDefaults;if(!a){a="{}"}a=JSON.parse(a);OpenLayers.Util.extend(a,b);localStorage.userDefaults=JSON.stringify(a);return a};function combineParams(d,a){if(!a){a=";"}var c="";for(var b in d){c+=b+"="+d[b]+a}return c}function areaWithUnit(b){var c={"km²":6,ha:4,are:2,"m²":0};var e=Math.log(b)/Math.LN10;var d=null;for(d in c){if(c[d]<e){e-=c[d];break}}return Math.pow(10,e).toPrecision(3)+" "+d}function lengthWithUnit(b){var c={km:3,m:0};var e=Math.log(b)/Math.LN10;var d=null;for(d in c){if(c[d]<e){e-=c[d];break}}return Math.pow(10,e).toPrecision(3)+" "+d}var measureTip={show:function(b){var a=document.getElementById("measure-tip");if(!a){if(jQuery){jQuery("body").append('<div id="measure-tip" style="border: solid; background-color: white; position: absolute; top: 300px; z-index: 1020; padding: 4px;"></div>');a=document.getElementById("measure-tip")}else{a=document.createElement("div");a.id="measure-tip";a.style.border="solid";a.style.backgroundColor="white";a.style.position="absolute";a.style.height="20px";a.style.width="300px";a.style.left="500px";a.style.top="300px";document.getElementsByTagName("body")[0].appendChild(a)}}else{a.style.display="inline"}if(b){a.innerHTML=b;jQuery(a).offset({top:0,left:(jQuery(window).width()-jQuery(a).width())/2})}},hide:function(){var a=document.getElementById("measure-tip");if(a){if(jQuery){jQuery("#measure-tip").remove()}else{a.style.display="none"}}}};function start_edit_subset(a){var d=a.getLayersByName("Terrein");if(d.length!==1){alert(OpenLayers.i18n("No terrain selected"));return false}var f=d[0];var h=new OpenLayers.StyleMap({"default":new OpenLayers.Style(OpenLayers.Util.applyDefaults({cursor:"pointer",title:"${fuelLabel}",graphicTitle:"${fuelLabel}",fillColor:"${fillColor}"},OpenLayers.Feature.Vector.style["default"]),{context:{fuelLabel:function(k){return k.attributes.fuel_id},fillColor:function(k){if(Gmi.Data.fuels.colors[k.attributes.fuel_id]){return Gmi.Data.fuels.colors[k.attributes.fuel_id]}return"#ee9900"}}}),select:new OpenLayers.Style(OpenLayers.Util.applyDefaults({cursor:"pointer",title:"${fuelLabel}",graphicTitle:"${fuelLabel}"},OpenLayers.Feature.Vector.style.select),{context:{fuelLabel:function(k){return k.attributes.fuel_id}}})});var b,c,e;var g=new OpenLayers.Strategy.Save({auto:true});g.events.register("fail",g,function(k){alert(OpenLayers.i18n("save failed"))});g.events.register("success",g,function(k){if(b){b.close()}e.unselectAll()});function j(l){var k=Gmi.Data.fuels.types[l.attributes.fuel_id];if(b){b.close();b=null}if(!b){var m=[];for(var n in Gmi.Data.fuels.types){m.push([n,Gmi.Data.fuels.types[n]])}b=new GeoExt.Popup({title:OpenLayers.i18n("Edit feature"),id:"wfs_popup",location:l,map:a,width:300,html:k,maximizable:false,collapsible:false,layout:"fit",items:[new Ext.form.ComboBox({id:"wfs_fuel_list",fieldLabel:OpenLayers.i18n("Fuel list"),name:"wfs_fuel_list",typeAhead:true,triggerAction:"all",lazyRender:true,anchor:"100%",align:"right",mode:"local",value:l.attributes.fuel_id,forceSelection:true,editable:false,store:new Ext.data.ArrayStore({id:0,fields:["id","naam"],data:m}),valueField:"id",displayField:"naam",listeners:{select:function(){console.log("select fuel_list")}}}),new Ext.Button({text:OpenLayers.i18n("Change"),id:"btn_save_wfs",tooltip:OpenLayers.i18n("todo"),handler:function(o,p){l.attributes.fuel_id=Ext.getCmp("wfs_fuel_list").getValue();console.log("todo: fuel_id wordt ",l.attributes.fuel_id);l.state=OpenLayers.State.UPDATE;l.layer.events.triggerEvent("featuremodified",{feature:l});l.layer.events.triggerEvent("afterfeaturemodified",{feature:l,modified:true})}})]});b.on({close:function(){console.log("close popup");b=null}})}b.show()}c=new OpenLayers.Layer.Vector("Terrein (WFS)",{strategies:[new OpenLayers.Strategy.Fixed(),g],projection:new OpenLayers.Projection("EPSG:4326"),protocol:new OpenLayers.Protocol.WFS({url:"/geoserver/ows",version:"1.1.0",geometryName:"geom",srsName:"EPSG:4326",featureType:f.params.LAYERS.split(":")[1],featureNS:"model_wildfire"}),styleMap:h,eventListeners:{featureselected:function(k){console.log("feature selected",k.feature);j(k.feature)}},displayInLayerSwitcher:Gmi.Settings.debug});a.addLayer(c);e=new OpenLayers.Control.SelectFeature(c,{hover:false,multiple:false,renderers:OpenLayers.Layer.Vector.prototype.renderers});a.addControl(e);e.activate();return true}function stop_edit_subset(f){var c=Ext.getCmp("btn_edit_terrain");if(c.pressed){c.doToggle()}var e=f.getLayersByName("Terrein (WFS)");if(e.length===0){return}var d=e[0];var a=f.getControlsByClass("OpenLayers.Control.SelectFeature");for(var b=0;b<a.length;b++){if(a[b].layer===d){f.removeControl(a[b]);console.log("wfs control removed")}}f.removeLayer(d);console.log("wfs layer removed")};